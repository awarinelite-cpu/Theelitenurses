<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MedRecord â€” Medication Administration Records</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
<!-- Firebase SDK (compat version - works without modules) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyD91f4UJKPXZEpfXV_QoggsZq1R_9WcC4s",
    authDomain: "the-elites-nurses.firebaseapp.com",
    projectId: "the-elites-nurses",
    storageBucket: "the-elites-nurses.firebasestorage.app",
    messagingSenderId: "44425476386",
    appId: "1:44425476386:web:20d7dae98bb6b302eccd7b"
  };
  firebase.initializeApp(firebaseConfig);
  window._db = firebase.firestore();
  console.log('Firebase ready âœ“');
</script>
<style>
  :root {
    --navy: #0f1b2d;
    --deep: #162236;
    --card: #1c2d42;
    --border: #243349;
    --teal: #2dd4bf;
    --teal-dim: #1a9e8d;
    --amber: #f59e0b;
    --rose: #f43f5e;
    --muted: #94a3b8;
    --text: #e2e8f0;
    --light: #f8fafc;
    --success: #10b981;
  }

  /* Light Mode Colors */
  [data-theme="light"] {
    --navy: #ffffff;
    --deep: #f8fafc;
    --card: #ffffff;
    --border: #e2e8f0;
    --teal: #0891b2;
    --teal-dim: #0e7490;
    --amber: #f59e0b;
    --rose: #e11d48;
    --muted: #64748b;
    --text: #1e293b;
    --light: #0f172a;
    --success: #059669;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  /* â”€â”€â”€ GLOBALCARE-STYLE PATIENT HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .gc-patient-header {
    background: var(--deep);
    border: 1px solid var(--border);
    border-radius: 14px;
    margin-bottom: 0;
    overflow: hidden;
  }

  .gc-patient-header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.2rem 1.5rem;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
    gap: 1rem;
  }

  .gc-patient-identity {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .gc-avatar {
    width: 54px;
    height: 54px;
    border-radius: 50%;
    background: rgba(45,212,191,0.12);
    border: 2px solid rgba(45,212,191,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--teal);
    flex-shrink: 0;
  }

  .gc-patient-fullname {
    font-family: 'Playfair Display', serif;
    font-size: 1.35rem;
    font-weight: 700;
    color: var(--light);
    letter-spacing: -0.01em;
  }

  .gc-patient-sub {
    font-size: 0.78rem;
    color: var(--muted);
    margin: 3px 0 6px;
  }

  .gc-badge-row {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .gc-badge {
    font-size: 0.65rem;
    font-weight: 700;
    padding: 3px 8px;
    border-radius: 20px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }

  .gc-badge-emr  { background: rgba(45,212,191,0.15); color: var(--teal); }
  .gc-badge-ward { background: rgba(245,158,11,0.15); color: var(--amber); }
  .gc-badge-status { background: rgba(16,185,129,0.15); color: var(--success); }

  .gc-patient-header-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .gc-clearance-block {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
  }

  .gc-clearance-label {
    font-size: 0.65rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    font-weight: 600;
  }

  .gc-clearance-value {
    font-size: 0.9rem;
    color: var(--text);
    font-weight: 500;
  }

  .gc-wallet {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: rgba(45,212,191,0.08);
    border: 1px solid rgba(45,212,191,0.2);
    border-radius: 8px;
    padding: 6px 14px;
    min-width: 110px;
    text-align: center;
  }

  .gc-wallet-label {
    font-size: 0.6rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 600;
  }

  .gc-wallet-val {
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--teal);
    margin-top: 2px;
  }

  .gc-action-btn {
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.82rem;
    cursor: pointer;
    padding: 9px 16px;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .gc-btn-save {
    background: linear-gradient(135deg, var(--teal), #06b6d4);
    color: var(--navy);
  }

  .gc-btn-save:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(45,212,191,0.3); }

  .gc-btn-transfer {
    background: rgba(245,158,11,0.15);
    color: var(--amber);
    border: 1px solid rgba(245,158,11,0.3);
  }

  .gc-btn-transfer:hover { background: rgba(245,158,11,0.25); }

  /* â”€â”€â”€ TAB BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .gc-tab-bar {
    display: flex;
    gap: 0;
    background: var(--navy);
    overflow-x: auto;
    scrollbar-width: none;
  }

  .gc-tab-bar::-webkit-scrollbar { display: none; }

  .gc-tab {
    border: none;
    background: transparent;
    padding: 11px 18px;
    font-size: 0.82rem;
    font-weight: 500;
    color: var(--muted);
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.2s;
    white-space: nowrap;
    position: relative;
    border-bottom: 3px solid transparent;
  }

  .gc-tab:hover:not(.active) {
    color: var(--text);
    background: rgba(45,212,191,0.05);
  }

  .gc-tab.active {
    color: var(--teal);
    border-bottom-color: var(--teal);
    background: rgba(45,212,191,0.07);
    font-weight: 600;
  }

  /* â”€â”€â”€ TWO-COLUMN BODY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .gc-body-layout {
    display: flex;
    gap: 0;
    align-items: flex-start;
    margin-top: 0;
  }

  .gc-main-content {
    flex: 1;
    min-width: 0;
    padding-top: 1.5rem;
  }

  /* â”€â”€â”€ TAB PANELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .gc-tab-panel { display: none; }
  .gc-tab-panel.active { display: block; }

  /* â”€â”€â”€ RIGHT ACTION PANEL (GlobalCare right sidebar) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .gc-right-panel {
    width: 200px;
    flex-shrink: 0;
    background: var(--deep);
    border-left: 1px solid var(--border);
    border-top: 1px solid var(--border);
    border-radius: 0 0 14px 0;
    margin-top: 0;
    padding: 0.8rem 0;
    position: sticky;
    top: 64px;
    max-height: calc(100vh - 80px);
    overflow-y: auto;
  }

  .gc-right-panel::-webkit-scrollbar { width: 3px; }
  .gc-right-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .gc-right-panel-title {
    font-size: 0.62rem;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
    padding: 0 1rem 0.6rem;
    border-bottom: 1px solid var(--border);
    margin-bottom: 0.4rem;
  }

  .gc-right-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
    background: transparent;
    border: none;
    border-bottom: 1px solid rgba(36,51,73,0.4);
    padding: 9px 1rem;
    font-size: 0.78rem;
    color: var(--teal);
    cursor: pointer;
    text-align: left;
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
    transition: background 0.15s, color 0.15s;
  }

  .gc-right-btn:hover {
    background: rgba(45,212,191,0.08);
    color: var(--light);
  }

  .gc-right-btn-icon {
    font-size: 1rem;
    flex-shrink: 0;
    width: 20px;
    text-align: center;
  }

  /* Light mode overrides for GC elements */
  [data-theme="light"] .gc-patient-header { background: #fff; }
  [data-theme="light"] .gc-right-panel { background: #f8fafc; }
  [data-theme="light"] .gc-tab-bar { background: #f1f5f9; }
  [data-theme="light"] .gc-tab.active { background: rgba(8,145,178,0.06); }
  [data-theme="light"] .gc-patient-fullname { color: #0f172a; }
  [data-theme="light"] .gc-wallet { background: rgba(8,145,178,0.06); border-color: rgba(8,145,178,0.2); }
  [data-theme="light"] .gc-wallet-val { color: var(--teal); }


  body {
    background: var(--navy);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  /* Theme Toggle Button */
  .theme-toggle {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 6px 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.85rem;
    color: var(--text);
    transition: all 0.2s;
  }

  .theme-toggle:hover {
    background: var(--border);
    transform: translateY(-1px);
  }

  .theme-toggle-icon {
    font-size: 1.1rem;
  }

  /* â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  header {
    background: var(--deep);
    border-bottom: 1px solid var(--border);
    padding: 0 2rem;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
  }

  .logo {
    display: flex; align-items: center; gap: 10px;
  }

  .logo-icon {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, var(--teal), #06b6d4);
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
  }

  .logo h1 {
    font-family: 'Playfair Display', serif;
    font-size: 1.3rem;
    color: var(--light);
    letter-spacing: -0.02em;
  }

  .logo span {
    font-family: 'DM Sans', sans-serif;
    font-size: 0.7rem;
    color: var(--teal);
    font-weight: 500;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    display: block;
    margin-top: -3px;
  }

  .ward-info {
    background: rgba(45,212,191,0.15);
    color: var(--teal);
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    letter-spacing: 0.05em;
  }

  header .actions { display: flex; gap: 10px; align-items: center; }

  /* â”€â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .app { display: flex; flex: 1; overflow: hidden; }

  /* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .sidebar {
    width: 280px;
    background: var(--deep);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-header {
    padding: 1.2rem 1.2rem 0.8rem;
    border-bottom: 1px solid var(--border);
  }

  .sidebar-header h2 {
    font-size: 0.72rem;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 0.8rem;
  }

  .status-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 0.8rem;
    padding: 4px;
    background: var(--navy);
    border-radius: 8px;
  }

  .status-tab {
    flex: 1;
    padding: 6px 8px;
    font-size: 0.7rem;
    font-weight: 600;
    text-align: center;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--muted);
    border: none;
    background: transparent;
  }

  .status-tab.active {
    background: var(--teal);
    color: var(--navy);
  }

  .status-tab:hover:not(.active) {
    background: var(--card);
    color: var(--text);
  }

  .search-box {
    position: relative;
  }

  .search-box input {
    width: 100%;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 12px 8px 34px;
    color: var(--text);
    font-size: 0.85rem;
    font-family: 'DM Sans', sans-serif;
    outline: none;
    transition: border-color 0.2s;
  }

  .search-box input:focus { border-color: var(--teal); }

  .search-box::before {
    content: "âŒ•";
    position: absolute; left: 10px; top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    font-size: 1rem;
    pointer-events: none;
  }

  .patient-list {
    flex: 1;
    overflow-y: auto;
    padding: 0.5rem;
  }

  .patient-list::-webkit-scrollbar { width: 4px; }
  .patient-list::-webkit-scrollbar-track { background: transparent; }
  .patient-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .patient-item {
    padding: 0.75rem 1rem;
    border-radius: 10px;
    cursor: pointer;
    transition: background 0.15s;
    margin-bottom: 2px;
    position: relative;
  }

  .patient-item:hover { background: var(--card); }
  .patient-item.active {
    background: rgba(45,212,191,0.12);
    border: 1px solid rgba(45,212,191,0.25);
  }

  .patient-item.active::before {
    content: '';
    position: absolute;
    left: 0; top: 20%; bottom: 20%;
    width: 3px;
    background: var(--teal);
    border-radius: 0 3px 3px 0;
  }

  .patient-name {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text);
  }

  .patient-meta {
    font-size: 0.75rem;
    color: var(--muted);
    margin-top: 2px;
  }

  .emr-badge {
    display: inline-block;
    background: rgba(45,212,191,0.15);
    color: var(--teal);
    font-size: 0.65rem;
    font-weight: 600;
    padding: 2px 6px;
    border-radius: 4px;
    letter-spacing: 0.05em;
  }

  .ward-badge {
    display: inline-block;
    background: rgba(245,158,11,0.15);
    color: var(--amber);
    font-size: 0.65rem;
    font-weight: 600;
    padding: 2px 6px;
    border-radius: 4px;
    letter-spacing: 0.05em;
    margin-left: 4px;
  }

  .status-badge {
    display: inline-block;
    font-size: 0.65rem;
    font-weight: 600;
    padding: 2px 6px;
    border-radius: 4px;
    letter-spacing: 0.05em;
    margin-left: 4px;
  }

  .status-active {
    background: rgba(16,185,129,0.15);
    color: var(--success);
  }

  .status-discharged {
    background: rgba(148,163,184,0.15);
    color: var(--muted);
  }

  .status-transferred {
    background: rgba(6,182,212,0.15);
    color: #06b6d4;
  }

  /* Medication Status Colors */
  .med-status-given {
    background: rgba(16,185,129,0.15);
    color: var(--success);
  }

  .med-status-not-given {
    background: rgba(244,63,94,0.15);
    color: var(--rose);
  }

  /* Patient Report Color Coding - Overall Nurse View */
  .patient-has-daily-care {
    background: rgba(16,185,129,0.08) !important;
    border-left: 3px solid var(--success) !important;
  }

  .patient-has-report {
    background: rgba(168,85,247,0.12) !important;
    border-left: 3px solid #a855f7 !important;
  }

  .patient-name-with-care {
    color: var(--success);
    font-weight: 600;
  }

  .patient-name-with-report {
    color: #a855f7;
    font-weight: 700;
  }

  .med-status-issue {
    background: rgba(245,158,11,0.15);
    color: var(--amber);
  }

  .sidebar-footer {
    padding: 1rem;
    border-top: 1px solid var(--border);
  }

  /* â”€â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .main {
    flex: 1;
    overflow-y: auto;
    padding: 2rem 2.5rem;
    background: var(--navy);
  }

  .main::-webkit-scrollbar { width: 6px; }
  .main::-webkit-scrollbar-track { background: transparent; }
  .main::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* â”€â”€â”€ EMPTY STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    min-height: 400px;
    color: var(--muted);
    text-align: center;
  }

  .empty-state .icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.4; }
  .empty-state h3 { font-size: 1.1rem; font-weight: 500; margin-bottom: 0.4rem; color: var(--text); }
  .empty-state p { font-size: 0.85rem; max-width: 260px; }

  /* â”€â”€â”€ RECORD FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .record-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
  }

  .record-title h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1.6rem;
    color: var(--light);
    font-weight: 700;
  }

  .record-title p {
    font-size: 0.82rem;
    color: var(--muted);
    margin-top: 3px;
  }

  .badge-group { display: flex; gap: 8px; margin-top: 8px; }

  .badge {
    font-size: 0.72rem;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 20px;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }

  .badge-teal { background: rgba(45,212,191,0.15); color: var(--teal); }
  .badge-amber { background: rgba(245,158,11,0.15); color: var(--amber); }

  .section {
    background: var(--card);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid var(--border);
  }

  .section-title {
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .section-title-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .section-title-row .section-title {
    margin-bottom: 0;
  }

  .section-title::before {
    content: '';
    width: 3px; height: 16px;
    background: var(--teal);
    border-radius: 2px;
  }

  .form-row {
    display: flex;
    gap: 1rem;
    margin-bottom: 0.9rem;
  }

  .form-group {
    flex: 1;
  }

  label {
    display: block;
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--muted);
    margin-bottom: 5px;
    letter-spacing: 0.02em;
  }

  input, select, textarea {
    width: 100%;
    background: var(--navy);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    color: var(--text);
    font-size: 0.85rem;
    font-family: 'DM Sans', sans-serif;
    outline: none;
    transition: border-color 0.2s;
  }

  input:focus, select:focus, textarea:focus {
    border-color: var(--teal);
  }

  textarea {
    resize: vertical;
    min-height: 60px;
  }

  /* â”€â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .btn {
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'DM Sans', sans-serif;
    letter-spacing: 0.02em;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--teal), #06b6d4);
    color: var(--navy);
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(45,212,191,0.3);
  }

  .btn-secondary {
    background: var(--card);
    color: var(--text);
    border: 1px solid var(--border);
  }

  .btn-secondary:hover {
    background: var(--border);
  }

  .btn-danger {
    background: rgba(244,63,94,0.15);
    color: var(--rose);
    border: 1px solid rgba(244,63,94,0.3);
  }

  .btn-danger:hover {
    background: rgba(244,63,94,0.25);
  }

  .btn-small {
    padding: 6px 12px;
    font-size: 0.75rem;
  }

  /* â”€â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .table-container {
    overflow-x: auto;
    margin-top: 1rem;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.82rem;
  }

  thead {
    background: rgba(45,212,191,0.08);
  }

  th {
    text-align: left;
    padding: 12px 10px;
    font-weight: 600;
    font-size: 0.72rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--teal);
    border-bottom: 1px solid var(--border);
  }

  td {
    padding: 10px 10px;
    border-bottom: 1px solid rgba(36,51,73,0.5);
    vertical-align: middle;
  }

  tbody tr:hover {
    background: rgba(45,212,191,0.03);
  }

  td input, td select, td textarea {
    padding: 6px 8px;
    font-size: 0.82rem;
    margin: 0;
  }

  .row-del {
    background: transparent;
    border: none;
    color: var(--rose);
    font-size: 1.1rem;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background 0.15s;
  }

  .row-del:hover {
    background: rgba(244,63,94,0.15);
  }

  /* â”€â”€â”€ VITALS GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .vitals-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .vital-card {
    background: rgba(45,212,191,0.05);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1rem;
    transition: all 0.2s;
  }

  .vital-card:hover {
    border-color: var(--teal);
    transform: translateY(-2px);
  }

  .vital-label {
    font-size: 0.7rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 6px;
  }

  .vital-value {
    font-size: 1.6rem;
    font-weight: 600;
    color: var(--teal);
    font-family: 'DM Sans', sans-serif;
  }

  .vital-unit {
    font-size: 0.8rem;
    color: var(--muted);
    margin-left: 4px;
  }

  .vital-card.alert-ok { border-color: var(--success); }
  .vital-card.alert-ok .vital-value { color: var(--success); }

  .vital-card.alert-low { border-color: var(--amber); }
  .vital-card.alert-low .vital-value { color: var(--amber); }

  .vital-card.alert-high { border-color: var(--rose); }
  .vital-card.alert-high .vital-value { color: var(--rose); }

  /* â”€â”€â”€ ABNORMAL HIGHLIGHTING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .abnormal-low {
    background: rgba(245,158,11,0.15) !important;
    border-left: 3px solid var(--amber) !important;
  }

  .abnormal-high {
    background: rgba(244,63,94,0.15) !important;
    border-left: 3px solid var(--rose) !important;
  }

  /* â”€â”€â”€ LOGIN/REGISTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .auth-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    gap: 2rem;
    flex-wrap: wrap;
    position: relative;
    overflow: hidden;
  }

  /* Background image with overlay */
  .auth-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: url('https://images.unsplash.com/photo-1576765608535-5f04d1e3f289?q=80&w=2000');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    z-index: 0;
  }

  /* Dark overlay for readability in dark mode */
  .auth-container::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(15, 27, 45, 0.85);
    z-index: 1;
    transition: background 0.3s ease;
  }

  /* Light overlay for light mode */
  [data-theme="light"] .auth-container::after {
    background: rgba(255, 255, 255, 0.90);
  }

  /* Ensure content appears above background */
  .auth-container > * {
    position: relative;
    z-index: 2;
  }

  .auth-box {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 2.5rem;
    max-width: 420px;
    width: 100%;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    backdrop-filter: blur(10px);
  }

  [data-theme="light"] .auth-box {
    box-shadow: 0 8px 32px rgba(0,0,0,0.15);
  }

  .overall-nurse-panel {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 2rem;
    max-width: 350px;
    width: 100%;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    backdrop-filter: blur(10px);
  }

  [data-theme="light"] .overall-nurse-panel {
    box-shadow: 0 8px 32px rgba(0,0,0,0.15);
  }

  .overall-nurse-panel h3 {
    font-size: 1.1rem;
    color: var(--teal);
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .overall-nurse-panel p {
    font-size: 0.8rem;
    color: var(--muted);
    margin-bottom: 1.5rem;
  }

  .nurse-selector {
    margin-bottom: 1rem;
  }

  .nurse-selector label {
    display: block;
    font-size: 0.85rem;
    color: var(--text);
    margin-bottom: 0.5rem;
    font-weight: 500;
  }

  .nurse-selector select {
    width: 100%;
    background: var(--navy);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px;
    color: var(--text);
    font-size: 0.9rem;
    font-family: 'DM Sans', sans-serif;
  }

  .current-overall-nurse {
    background: rgba(45,212,191,0.1);
    border: 1px solid rgba(45,212,191,0.3);
    border-radius: 10px;
    padding: 1rem;
    margin-top: 1rem;
  }

  .current-overall-nurse .label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--muted);
    margin-bottom: 0.5rem;
  }

  .current-overall-nurse .name {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--teal);
  }

  .current-overall-nurse .date {
    font-size: 0.75rem;
    color: var(--muted);
    margin-top: 0.3rem;
  }

  /* â”€â”€â”€ LOGIN HISTORY DROPDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .login-history-dropdown {
    position: relative;
    background: var(--navy);
    border: 1px solid var(--border);
    border-radius: 10px;
    margin-top: 0.5rem;
    max-height: 300px;
    overflow-y: auto;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
  }

  .login-history-dropdown::-webkit-scrollbar { width: 6px; }
  .login-history-dropdown::-webkit-scrollbar-track { background: transparent; }
  .login-history-dropdown::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .login-history-item {
    padding: 0.8rem 1rem;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s;
  }

  .login-history-item:last-child {
    border-bottom: none;
  }

  .login-history-item:hover {
    background: var(--card);
  }

  .login-history-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.4rem;
  }

  .login-history-item-name {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text);
  }

  .login-history-item-role {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 2px 6px;
    border-radius: 4px;
    background: rgba(45,212,191,0.15);
    color: var(--teal);
  }

  .login-history-item-credentials {
    display: flex;
    gap: 1rem;
    font-size: 0.8rem;
    color: var(--muted);
  }

  .login-history-item-credentials span {
    color: var(--text);
    font-family: 'Courier New', monospace;
  }

  .login-history-empty {
    padding: 2rem 1rem;
    text-align: center;
    color: var(--muted);
    font-size: 0.85rem;
  }

  .auth-logo {
    text-align: center;
    margin-bottom: 2rem;
  }

  .auth-logo-icon {
    width: 56px; height: 56px;
    background: linear-gradient(135deg, var(--teal), #06b6d4);
    border-radius: 14px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    margin-bottom: 1rem;
  }

  .auth-logo h1 {
    font-family: 'Playfair Display', serif;
    font-size: 1.8rem;
    color: var(--light);
    margin-bottom: 4px;
  }

  .auth-logo p {
    font-size: 0.85rem;
    color: var(--muted);
  }

  .auth-form {
    margin-top: 2rem;
  }

  .auth-form .form-group {
    margin-bottom: 1.2rem;
  }

  .auth-toggle {
    text-align: center;
    margin-top: 1.5rem;
    font-size: 0.85rem;
    color: var(--muted);
  }

  .auth-toggle a {
    color: var(--teal);
    cursor: pointer;
    text-decoration: none;
    font-weight: 600;
  }

  .auth-toggle a:hover {
    text-decoration: underline;
  }

  /* â”€â”€â”€ SHARE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .share-overlay {
    position:fixed; inset:0; background:rgba(0,0,0,.72);
    z-index:4000; display:flex; align-items:center; justify-content:center;
    padding:1rem; animation:fadeIn .2s ease;
  }
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  .share-box {
    background:var(--card); border:1px solid var(--border);
    border-radius:18px; width:100%; max-width:540px;
    max-height:88vh; overflow-y:auto;
    box-shadow:0 24px 64px rgba(0,0,0,.55);
  }
  .share-head {
    padding:1.2rem 1.4rem .9rem;
    border-bottom:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between;
  }
  .share-head h3 { font-size:1.05rem; font-weight:700; color:var(--light); display:flex; align-items:center; gap:8px; }
  .share-body { padding:1.3rem 1.4rem; }

  .share-scope-row {
    display:flex; gap:4px; background:var(--navy);
    border-radius:9px; padding:3px; margin-bottom:1.1rem;
  }
  .share-scope-btn {
    flex:1; padding:6px 8px; font-size:.75rem; font-weight:600;
    border-radius:6px; border:none; background:transparent;
    color:var(--muted); cursor:pointer; font-family:'DM Sans',sans-serif; transition:all .15s;
  }
  .share-scope-btn.on { background:var(--teal); color:var(--navy); }

  .share-grid {
    display:grid; grid-template-columns:1fr 1fr 1fr;
    gap:.7rem; margin-bottom:1rem;
  }
  .share-card {
    background:var(--navy); border:1.5px solid var(--border);
    border-radius:12px; padding:.9rem .7rem; cursor:pointer;
    transition:all .18s; text-align:center;
    display:flex; flex-direction:column; align-items:center; gap:6px;
  }
  .share-card:hover { transform:translateY(-2px); }
  .share-card:active { transform:translateY(0); }
  .share-card-icon { font-size:1.9rem; line-height:1; }
  .share-card-label { font-size:.76rem; font-weight:700; color:var(--text); }
  .share-card-desc  { font-size:.65rem; color:var(--muted); line-height:1.3; }

  .sc-save:hover   { border-color:#10b981; background:rgba(16,185,129,.08); }
  .sc-print:hover  { border-color:#06b6d4; background:rgba(6,182,212,.08); }
  .sc-csv:hover    { border-color:#f59e0b; background:rgba(245,158,11,.08); }
  .sc-email:hover  { border-color:#f59e0b; background:rgba(245,158,11,.08); }
  .sc-whatsapp:hover { border-color:#25d366; background:rgba(37,211,102,.08); }
  .sc-copy:hover   { border-color:#a855f7; background:rgba(168,85,247,.08); }
  .sc-file:hover   { border-color:var(--teal); background:rgba(45,212,191,.08); }
  .sc-system:hover { border-color:#6366f1; background:rgba(99,102,241,.08); }
  .sc-bt:hover     { border-color:#3b82f6; background:rgba(59,130,246,.08); }

  .share-msg {
    font-size:.8rem; padding:.65rem .9rem; border-radius:8px;
    margin-top:.7rem; display:none; line-height:1.45;
  }
  .share-msg.ok  { background:rgba(16,185,129,.12); color:#10b981; border:1px solid rgba(16,185,129,.3); }
  .share-msg.err { background:rgba(244,63,94,.12);  color:#f43f5e; border:1px solid rgba(244,63,94,.3); }
  .share-msg.inf { background:rgba(45,212,191,.10); color:var(--teal); border:1px solid rgba(45,212,191,.25); }

  /* Report toolbar above ward tables */
  .rpt-toolbar {
    display:flex; gap:.5rem; flex-wrap:wrap; align-items:center;
    background:rgba(45,212,191,.06); border:1px solid rgba(45,212,191,.2);
    border-radius:11px; padding:.7rem 1.1rem; margin-bottom:1.4rem;
  }
  .rpt-toolbar-label {
    font-size:.7rem; font-weight:700; letter-spacing:.08em;
    text-transform:uppercase; color:var(--teal); margin-right:.3rem;
  }

  /* â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: var(--card);
    border: 1px solid var(--teal);
    border-radius: 12px;
    padding: 1rem 1.5rem;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    transform: translateY(150%);
    transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .toast.show {
    transform: translateY(0);
  }

  .toast-icon {
    font-size: 1.2rem;
  }

  /* â”€â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 768px) {
    .sidebar { width: 100%; max-width: 280px; }
    .app { flex-direction: column; }
    .main { padding: 1.5rem; }
    .form-row { flex-direction: column; }
    .vitals-grid { grid-template-columns: 1fr; }
  }

  /* â”€â”€â”€ HIDE/SHOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .hidden { display: none !important; }

  /* â”€â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    padding: 2rem;
  }

  .modal {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    max-width: 800px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  }

  .modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .modal-header h3 {
    font-size: 1.2rem;
    color: var(--light);
    font-weight: 600;
  }

  .modal-close {
    background: transparent;
    border: none;
    color: var(--muted);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: all 0.2s;
  }

  .modal-close:hover {
    background: var(--border);
    color: var(--text);
  }

  .modal-body {
    padding: 1.5rem;
  }

  .modal-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 0.8rem;
    justify-content: flex-end;
  }

  .help-text {
    background: rgba(45,212,191,0.08);
    border: 1px solid rgba(45,212,191,0.2);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    font-size: 0.82rem;
    color: var(--text);
  }

  .help-text strong {
    color: var(--teal);
    display: block;
    margin-bottom: 0.5rem;
  }

  .help-text code {
    background: var(--navy);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 0.8rem;
    color: var(--teal);
  }

  /* â”€â”€â”€ NOTEPAD WIDGET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .notepad-widget {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  .notepad-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .notepad-header h3 {
    font-size: 1rem;
    color: var(--teal);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
  }

  .notepad-textarea {
    width: 100%;
    min-height: 150px;
    background: var(--navy);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
    color: var(--text);
    font-size: 0.9rem;
    font-family: 'DM Sans', sans-serif;
    resize: vertical;
    line-height: 1.6;
  }

  .notepad-textarea:focus {
    outline: none;
    border-color: var(--teal);
  }

  .notepad-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.8rem;
    font-size: 0.75rem;
    color: var(--muted);
  }

  /* â”€â”€â”€ LOGIN HISTORY CLIPBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .login-history-panel {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 2rem;
    max-width: 400px;
    width: 100%;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    max-height: 600px;
    display: flex;
    flex-direction: column;
  }

  .login-history-panel h3 {
    font-size: 1.1rem;
    color: var(--amber);
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .login-history-panel p {
    font-size: 0.8rem;
    color: var(--muted);
    margin-bottom: 1rem;
  }

  .login-history-list {
    flex: 1;
    overflow-y: auto;
    background: var(--navy);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1rem;
  }

  .login-history-list::-webkit-scrollbar { width: 6px; }
  .login-history-list::-webkit-scrollbar-track { background: transparent; }
  .login-history-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .login-entry {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.8rem;
    margin-bottom: 0.8rem;
    transition: all 0.2s;
  }

  .login-entry:hover {
    border-color: var(--amber);
    transform: translateX(2px);
  }

  .login-entry-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .login-entry-name {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text);
  }

  .login-entry-role {
    font-size: 0.7rem;
    background: rgba(245,158,11,0.15);
    color: var(--amber);
    padding: 2px 6px;
    border-radius: 4px;
  }

  .login-entry-details {
    font-size: 0.75rem;
    color: var(--muted);
    line-height: 1.5;
  }

  .login-entry-username {
    font-family: 'Courier New', monospace;
    color: var(--teal);
  }

  .login-entry-password {
    font-family: 'Courier New', monospace;
    color: var(--rose);
    user-select: all;
  }

  .login-entry-time {
    font-size: 0.7rem;
    color: var(--muted);
    margin-top: 0.3rem;
    font-style: italic;
  }

  .history-actions {
    display: flex;
    gap: 0.5rem;
  }

  .empty-history {
    text-align: center;
    padding: 2rem;
    color: var(--muted);
    font-size: 0.85rem;
  }

  /* â”€â”€â”€ HMS SMART PASTE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .hms-paste-tabs {
    display: flex;
    gap: 4px;
    padding: 4px;
    background: var(--navy);
    border-radius: 10px;
    margin-bottom: 1.2rem;
  }
  .hms-paste-tab {
    flex: 1;
    padding: 8px 10px;
    font-size: 0.78rem;
    font-weight: 600;
    text-align: center;
    border-radius: 7px;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--muted);
    border: none;
    background: transparent;
    font-family: 'DM Sans', sans-serif;
  }
  .hms-paste-tab.active {
    background: var(--teal);
    color: var(--navy);
  }
  .hms-paste-tab:hover:not(.active) {
    background: var(--card);
    color: var(--text);
  }
  .hms-tab-panel { display: none; }
  .hms-tab-panel.active { display: block; }

  .parse-preview-card {
    background: var(--navy);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1rem;
    margin-top: 1rem;
  }
  .parse-preview-card .preview-title {
    font-size: 0.72rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--teal);
    margin-bottom: 0.8rem;
  }
  .parse-field-row {
    display: flex;
    align-items: center;
    margin-bottom: 0.6rem;
    gap: 0.8rem;
  }
  .parse-field-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--muted);
    width: 130px;
    flex-shrink: 0;
  }
  .parse-field-value {
    flex: 1;
    font-size: 0.85rem;
    color: var(--text);
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 5px 10px;
  }
  .parse-field-value.detected {
    border-color: rgba(45,212,191,0.5);
    color: var(--teal);
  }
  .parse-field-value.empty {
    color: var(--muted);
    font-style: italic;
  }
  .parse-confidence {
    font-size: 0.68rem;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 600;
    flex-shrink: 0;
  }
  .parse-confidence.high { background: rgba(16,185,129,0.15); color: var(--success); }
  .parse-confidence.med { background: rgba(245,158,11,0.15); color: var(--amber); }
  .parse-confidence.low { background: rgba(244,63,94,0.15); color: var(--rose); }

  /* â”€â”€â”€ SPLIT SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .split-screen-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: var(--navy);
    z-index: 3000;
    display: flex;
    flex-direction: column;
  }
  .split-screen-header {
    background: var(--deep);
    border-bottom: 1px solid var(--border);
    padding: 0.6rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
    height: 52px;
  }
  .split-screen-title {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--teal);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .split-screen-body {
    display: flex;
    flex: 1;
    overflow: hidden;
  }
  .split-pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border-right: 2px solid var(--border);
  }
  .split-pane:last-child { border-right: none; }
  .split-pane-header {
    background: var(--deep);
    border-bottom: 1px solid var(--border);
    padding: 0.5rem 1rem;
    font-size: 0.78rem;
    font-weight: 600;
    color: var(--muted);
    letter-spacing: 0.06em;
    text-transform: uppercase;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }
  .split-pane iframe {
    flex: 1;
    border: none;
    background: #fff;
  }
  .split-form-pane {
    flex: 0 0 420px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .split-form-scroll {
    flex: 1;
    overflow-y: auto;
    padding: 1.2rem;
  }
  .split-form-scroll::-webkit-scrollbar { width: 4px; }
  .split-form-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .split-field-group {
    margin-bottom: 0.9rem;
  }
  .split-field-group label {
    font-size: 0.73rem;
    font-weight: 600;
    color: var(--muted);
    margin-bottom: 4px;
    display: block;
    letter-spacing: 0.04em;
  }
  .split-field-group input,
  .split-field-group select,
  .split-field-group textarea {
    font-size: 0.85rem;
    padding: 8px 10px;
  }
  .split-apply-btn {
    position: sticky;
    bottom: 0;
    background: var(--deep);
    border-top: 1px solid var(--border);
    padding: 0.8rem 1.2rem;
    display: flex;
    gap: 0.6rem;
  }

  /* â”€â”€â”€ API STATUS INDICATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .api-status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 4px;
  }
  .api-status-dot.connected { background: var(--success); box-shadow: 0 0 6px var(--success); }
  .api-status-dot.disconnected { background: var(--rose); }
  .api-status-dot.testing { background: var(--amber); animation: pulse 1s infinite; }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

  .emr-fetch-row {
    display: flex;
    gap: 0.5rem;
    align-items: stretch;
  }
  .emr-fetch-row input { flex: 1; }
  .emr-fetch-actions {
    display: flex;
    gap: 4px;
  }

  .hms-banner {
    background: linear-gradient(135deg, rgba(45,212,191,0.12), rgba(6,182,212,0.08));
    border: 1px solid rgba(45,212,191,0.25);
    border-radius: 10px;
    padding: 0.8rem 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 1rem;
  }
  .hms-banner-text {
    font-size: 0.8rem;
    color: var(--text);
    line-height: 1.4;
  }
  .hms-banner-text strong { color: var(--teal); }
  .hms-banner-actions { display: flex; gap: 6px; flex-shrink: 0; }

  /* â”€â”€â”€ CARE MANAGEMENT BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .care-buttons-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
  }

  .btn-care {
    background: var(--card);
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem 1rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.8rem;
    font-family: 'DM Sans', sans-serif;
    color: var(--text);
  }

  .btn-care:hover {
    background: var(--deep);
    border-color: var(--teal);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(45,212,191,0.2);
  }

  .btn-care .care-icon {
    font-size: 2rem;
  }

  .btn-care .care-label {
    font-size: 0.9rem;
    font-weight: 600;
    text-align: center;
  }

  /* â”€â”€â”€ CARE HISTORY DISPLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .care-history-container {
    background: var(--navy);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1.5rem;
    max-height: 500px;
    overflow-y: auto;
  }

  .care-history-container::-webkit-scrollbar { width: 6px; }
  .care-history-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .care-entry {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
  }

  .care-entry:last-child {
    margin-bottom: 0;
  }

  .care-entry-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.8rem;
    padding-bottom: 0.8rem;
    border-bottom: 1px solid var(--border);
  }

  .care-entry-type {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--teal);
  }

  .care-entry-date {
    font-size: 0.75rem;
    color: var(--muted);
  }

  .care-entry-content {
    font-size: 0.85rem;
    line-height: 1.6;
    color: var(--text);
  }

  .care-entry-content .field-row {
    display: flex;
    margin-bottom: 0.5rem;
  }

  .care-entry-content .field-label {
    font-weight: 600;
    color: var(--muted);
    min-width: 120px;
  }

  .care-entry-content .field-value {
    color: var(--text);
  }

  .care-entry-footer {
    margin-top: 0.8rem;
    padding-top: 0.8rem;
    border-top: 1px solid var(--border);
    font-size: 0.75rem;
    color: var(--muted);
    font-style: italic;
  }

  /* â”€â”€â”€ CARE MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .care-modal-content {
    max-width: 600px;
  }

  .care-modal-content .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .care-modal-content .form-row.full-width {
    grid-template-columns: 1fr;
  }

</style>
</head>
<body>

<!-- â•â•â• AUTH VIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="authView" class="auth-container">
  <div class="auth-box">
    <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
      <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
        <span class="theme-toggle-icon" id="themeIcon3">ğŸŒ™</span>
        <span id="themeText3">Dark</span>
      </button>
    </div>
    <div class="auth-logo">
      <div class="auth-logo-icon">âš•ï¸</div>
      <h1>MedRecord</h1>
      <p>Medication Administration Records</p>
    </div>

    <!-- LOGIN FORM -->
    <div id="loginForm">
      <div class="auth-form">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="loginUsername" placeholder="Enter your username">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="loginPassword" placeholder="Enter your password">
        </div>
        
        <!-- Saved Logins Dropdown -->
        <div class="form-group" style="margin-top: 0.5rem;">
          <button type="button" class="btn btn-secondary btn-small" style="width: 100%;" onclick="toggleLoginHistory()">
            ğŸ‘¤ Saved Logins
          </button>
          <div id="loginHistoryDropdown" class="login-history-dropdown hidden"></div>
        </div>
        
        <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="login()">
          Login
        </button>
      </div>
      <div class="auth-toggle">
        Don't have an account? <a onclick="showRegister()">Register here</a>
      </div>
    </div>

    <!-- REGISTER FORM -->
    <div id="registerForm" class="hidden">
      <div class="auth-form">
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="regName" placeholder="Enter your full name">
        </div>
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="regUsername" placeholder="Choose a username">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="regPassword" placeholder="Choose a password">
        </div>
        <div class="form-group">
          <label>Role</label>
          <select id="regRole" onchange="handleRoleChange()">
            <option value="">Select Role</option>
            <option value="nurse">Ward Nurse</option>
            <option value="overall_nurse">Overall Nurse (Supervisor)</option>
            <option value="ward_master">Ward Master</option>
          </select>
        </div>
        <div class="form-group" id="regWardGroup" style="display: none;">
          <label id="regWardLabel">Ward Assignment</label>
          <select id="regWard">
            <option value="">Select Ward</option>
            <option value="Ward A">Ward A - General Medicine</option>
            <option value="Ward B">Ward B - Surgical</option>
            <option value="Ward C">Ward C - Pediatrics</option>
            <option value="Ward D">Ward D - Cardiology</option>
            <option value="Ward E">Ward E - Orthopedics</option>
            <option value="Ward F">Ward F - ICU</option>
            <option value="Ward G">Ward G - Maternity</option>
            <option value="Ward H">Ward H - Oncology</option>
          </select>
          <div id="regWardNote" style="display:none; font-size:0.73rem; color:var(--amber); margin-top:5px; padding:6px 10px; background:rgba(245,158,11,0.1); border-radius:6px; border-left:3px solid var(--amber);">
            âš ï¸ Only one Ward Master is allowed per ward. Wards with an existing Ward Master are disabled.
          </div>
        </div>
        <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="register()">
          Create Account
        </button>
      </div>
      <div class="auth-toggle">
        Already have an account? <a onclick="showLogin()">Login here</a>
      </div>
    </div>
  </div>

  <!-- Overall Nurse of the Day Panel -->
  <div class="overall-nurse-panel">
    <h3>ğŸ‘‘ Overall Nurse of the Day</h3>
    <p>Self-assign as the coordinating nurse across all wards</p>
    
    <div class="current-overall-nurse" id="currentOverallDisplay">
      <div class="label">Current Status</div>
      <div class="name" id="overallNurseStatus">No overall nurse on duty</div>
      <div class="date" id="overallNurseDate"></div>
    </div>

    <div style="margin-top: 1.5rem;">
      <label style="display: block; font-size: 0.85rem; color: var(--text); margin-bottom: 0.5rem; font-weight: 500;">
        Select Yourself to Assign:
      </label>
      <select id="overallNurseLoginSelect" onchange="assignOverallNurseFromLogin()" 
        style="width: 100%; background: var(--navy); border: 1px solid var(--border); border-radius: 8px; padding: 10px; color: var(--text); font-size: 0.9rem; font-family: 'DM Sans', sans-serif;">
        <option value="">-- Select your name --</option>
      </select>
    </div>

    <button class="btn btn-secondary btn-small" style="width: 100%; margin-top: 1rem;" onclick="endOverallNurseFromLogin()">
      End Current Shift
    </button>

    <div style="font-size: 0.7rem; color: var(--muted); margin-top: 1rem; line-height: 1.5; font-style: italic;">
      ğŸ’¡ Select your name from the dropdown to designate yourself as Overall Nurse of the Day
    </div>
  </div>
</div>

<!-- â•â•â• APP VIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="appView" class="hidden">
  <header>
    <div class="logo">
      <div class="logo-icon">âš•ï¸</div>
      <div>
        <h1>MedRecord</h1>
        <span>MEDICAL RECORDS</span>
      </div>
    </div>
    <div style="display: flex; align-items: center; gap: 1rem;">
      <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.3rem;">
        <div class="ward-info" id="wardDisplay"></div>
        <div id="roleDisplay" style="font-size: 0.75rem; color: var(--muted);"></div>
      </div>
      <div class="actions">
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
          <span class="theme-toggle-icon" id="themeIcon">ğŸŒ™</span>
          <span id="themeText">Dark</span>
        </button>
        <button class="btn btn-secondary btn-small" onclick="showEMRSettings()" title="Configure EMR Integration">
          âš™ï¸ EMR Settings
        </button>
        <button class="btn btn-secondary btn-small" id="overallNurseToggle" onclick="toggleOverallNurseStatus()" style="display: none;">ğŸ‘‘ Overall Nurse</button>
        <button class="btn btn-secondary btn-small" id="viewAllReportsBtn" onclick="showOverallReportsView()" style="display: none;">ğŸ“Š View All Reports</button>
        <button class="btn btn-secondary btn-small" onclick="exportToCSV()">Export CSV</button>
        <button class="btn btn-secondary btn-small" onclick="printRecord()">Print</button>
        <button class="btn btn-danger btn-small" onclick="logout()">Logout</button>
      </div>
    </div>
  </header>

  <div class="app">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2 id="sidebarTitle">Patients</h2>
        <div class="status-tabs">
          <button class="status-tab active" onclick="filterByStatus('active')">Active</button>
          <button class="status-tab" onclick="filterByStatus('all')">All</button>
          <button class="status-tab" onclick="filterByStatus('discharged')">Discharged</button>
        </div>
        <div class="search-box">
          <input type="text" id="searchPatient" placeholder="Search patients..." onkeyup="searchPatients()">
        </div>
      </div>
      <div class="patient-list" id="patientList"></div>
      <div class="sidebar-footer">
        <button class="btn btn-primary" style="width: 100%;" onclick="addNewPatient()">
          + Add New Patient
        </button>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main">
      <!-- Empty State -->
      <div id="emptyState" class="empty-state">
        <div class="icon">ğŸ“‹</div>
        <h3>No Patient Selected</h3>
        <p>Select a patient from your ward or add a new patient to begin recording medication data.</p>
      </div>

      <!-- Patient Record -->
      <div id="recordView" class="hidden">

        <!-- GC-style Patient Header -->
        <div class="gc-patient-header">
          <div class="gc-patient-header-top">
            <div class="gc-patient-identity">
              <div class="gc-avatar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="32" height="32">
                  <circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/>
                </svg>
              </div>
              <div class="gc-patient-name-block">
                <h2 id="patientDisplayName" class="gc-patient-fullname">Patient Name</h2>
                <p id="patientDisplayMeta" class="gc-patient-sub">â€”</p>
                <div class="gc-badge-row">
                  <span class="gc-badge gc-badge-emr" id="patientDisplayEMR">EMR â€”</span>
                  <span class="gc-badge gc-badge-ward" id="patientDisplayWard">Ward â€”</span>
                  <span class="gc-badge gc-badge-status" id="patientDisplayStatus">Active</span>
                </div>
              </div>
            </div>
            <div class="gc-patient-header-actions">
              <div class="gc-clearance-block">
                <span class="gc-clearance-label">Attending:</span>
                <span class="gc-clearance-value" id="patientDisplayAttending">â€”</span>
              </div>
              <div class="gc-wallet">
                <span class="gc-wallet-label">Admission</span>
                <span class="gc-wallet-val" id="patientDisplayAdmission">â€”</span>
              </div>
              <button class="gc-action-btn gc-btn-save" onclick="saveRecord()">ğŸ’¾ Save Record</button>
              <button class="gc-action-btn gc-btn-transfer" onclick="switchGCTab('status', document.querySelector('.gc-tab[data-tab=status]'))">â‡„ Transfer / Discharge</button>
            </div>
          </div>
          <!-- Tab bar -->
          <div class="gc-tab-bar">
            <button class="gc-tab active" data-tab="visit"        onclick="switchGCTab('visit',        this)">Visit Info</button>
            <button class="gc-tab"        data-tab="vitals"       onclick="switchGCTab('vitals',       this)">Vital Signs</button>
            <button class="gc-tab"        data-tab="prescription" onclick="switchGCTab('prescription', this)">Prescription</button>
            <button class="gc-tab"        data-tab="meds"         onclick="switchGCTab('meds',         this)">Med Admin</button>
            <button class="gc-tab"        data-tab="glycemic"     onclick="switchGCTab('glycemic',     this)">Glycemic</button>
            <button class="gc-tab"        data-tab="fluid"        onclick="switchGCTab('fluid',        this)">Fluid I/O</button>
            <button class="gc-tab"        data-tab="nursing"      onclick="switchGCTab('nursing',      this)">Nursing Report</button>
            <button class="gc-tab"        data-tab="status"       onclick="switchGCTab('status',       this)">Status</button>
          </div>
        </div>

        <!-- Two-column layout -->
        <div class="gc-body-layout">

          <!-- Main content -->
          <div class="gc-main-content">

            <!-- TAB: Visit Info -->
            <div class="gc-tab-panel active" id="gc-panel-visit">
              <div class="section">
                <div class="section-title">ğŸ“‹ Patient Information</div>
                <div id="patientInfoReadOnly" class="hidden" style="background:rgba(45,212,191,0.05);padding:1rem;border-radius:8px;margin-bottom:1rem;">
                  <div style="font-size:0.75rem;color:var(--teal);font-weight:600;">â„¹ï¸ Patient information is read-only for nurses. Contact the Ward Master to update.</div>
                </div>
                <div id="patientInfoWardMasterNote" style="display:none; background:rgba(245,158,11,0.08);padding:0.8rem 1rem;border-radius:8px;margin-bottom:1rem;border-left:3px solid var(--amber);">
                  <div style="font-size:0.75rem;color:var(--amber);font-weight:600;">ğŸ¥ Ward Master Mode â€” You can add and edit patient information for your ward.</div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="patientName" placeholder="Patient full name">
                  </div>
                  <div class="form-group">
                    <label>EMR Number *</label>
                    <div class="emr-fetch-row">
                      <input type="text" id="emrNumber" placeholder="e.g., EMR-2024-0001">
                      <div class="emr-fetch-actions">
                        <button class="btn btn-primary btn-small" onclick="showHMSPasteModal()" style="white-space:nowrap;">ğŸ“‹ Paste from HMS</button>
                        <button class="btn btn-secondary btn-small" onclick="openSplitScreen()" style="white-space:nowrap;">âŠ Split View</button>
                        <button class="btn btn-secondary btn-small" onclick="fetchFromEMR()" style="white-space:nowrap;">ğŸ”— API Fetch</button>
                      </div>
                    </div>
                    <div class="hms-banner" style="margin-top:0.6rem;">
                      <div class="hms-banner-text"><strong>ğŸ’¡ GlobalCare HMS Integration</strong> â€” Use <strong>Split View</strong> to open HMS beside this form, or <strong>Paste from HMS</strong> to auto-fill fields.</div>
                      <div class="hms-banner-actions"><button class="btn btn-secondary btn-small" onclick="showEMRSettings()">âš™ï¸ API Config</button></div>
                    </div>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label>Date of Birth</label><input type="date" id="dob"></div>
                  <div class="form-group">
                    <label>Gender</label>
                    <select id="gender">
                      <option value="">Select</option>
                      <option value="Male">Male</option>
                      <option value="Female">Female</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Ward Assignment *</label>
                    <select id="patientWard">
                      <option value="">Select Ward</option>
                      <option value="Ward A">Ward A - General Medicine</option>
                      <option value="Ward B">Ward B - Surgical</option>
                      <option value="Ward C">Ward C - Pediatrics</option>
                      <option value="Ward D">Ward D - Cardiology</option>
                      <option value="Ward E">Ward E - Orthopedics</option>
                      <option value="Ward F">Ward F - ICU</option>
                      <option value="Ward G">Ward G - Maternity</option>
                      <option value="Ward H">Ward H - Oncology</option>
                    </select>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label>Attending Physician</label><input type="text" id="attending" placeholder="Dr. Name"></div>
                  <div class="form-group"><label>Admission Date</label><input type="date" id="admissionDate"></div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label>Diagnosis</label><textarea id="diagnosis" placeholder="Primary diagnosis"></textarea></div>
                  <div class="form-group"><label>Known Allergies</label><textarea id="allergies" placeholder="List any known allergies"></textarea></div>
                </div>
              </div>
              <!-- Latest Vitals strip -->
              <div class="section">
                <div class="section-title">ğŸ’“ Latest Vitals</div>
                <div class="vitals-grid">
                  <div class="vital-card" id="vitalBP"><div class="vital-label">Blood Pressure</div><div class="vital-value">--/--<span class="vital-unit">mmHg</span></div></div>
                  <div class="vital-card" id="vitalHR"><div class="vital-label">Heart Rate</div><div class="vital-value">--<span class="vital-unit">bpm</span></div></div>
                  <div class="vital-card" id="vitalTemp"><div class="vital-label">Temperature</div><div class="vital-value">--<span class="vital-unit">Â°C</span></div></div>
                  <div class="vital-card" id="vitalRR"><div class="vital-label">Resp. Rate</div><div class="vital-value">--<span class="vital-unit">/min</span></div></div>
                  <div class="vital-card" id="vitalSPO2"><div class="vital-label">SpOâ‚‚</div><div class="vital-value">--<span class="vital-unit">%</span></div></div>
                </div>
              </div>
            </div>

            <!-- TAB: Vital Signs placeholder (filled by sections below) -->
            <div class="gc-tab-panel" id="gc-panel-vitals"></div>
            <!-- TAB: Prescription placeholder -->
            <div class="gc-tab-panel" id="gc-panel-prescription"></div>
            <!-- TAB: Med Admin placeholder -->
            <div class="gc-tab-panel" id="gc-panel-meds"></div>
            <!-- TAB: Glycemic placeholder -->
            <div class="gc-tab-panel" id="gc-panel-glycemic"></div>
            <!-- TAB: Fluid I/O placeholder -->
            <div class="gc-tab-panel" id="gc-panel-fluid"></div>
            <!-- TAB: Nursing Report placeholder -->
            <div class="gc-tab-panel" id="gc-panel-nursing"></div>
            <!-- TAB: Status -->
            <div class="gc-tab-panel" id="gc-panel-status">
              <div class="section">
                <div class="section-title">ğŸ”„ Patient Status Management</div>
                <div class="form-row">
                  <div class="form-group">
                    <label>Current Status</label>
                    <select id="patientStatus" onchange="handleStatusChange()">
                      <option value="active">Active (In Ward)</option>
                      <option value="transferred">Transfer to Another Ward</option>
                      <option value="discharged">Discharge Patient</option>
                    </select>
                  </div>
                  <div class="form-group" id="transferWardGroup" style="display:none;">
                    <label>Transfer to Ward *</label>
                    <select id="transferWard">
                      <option value="">Select Destination Ward</option>
                      <option value="Ward A">Ward A - General Medicine</option>
                      <option value="Ward B">Ward B - Surgical</option>
                      <option value="Ward C">Ward C - Pediatrics</option>
                      <option value="Ward D">Ward D - Cardiology</option>
                      <option value="Ward E">Ward E - Orthopedics</option>
                      <option value="Ward F">Ward F - ICU</option>
                      <option value="Ward G">Ward G - Maternity</option>
                      <option value="Ward H">Ward H - Oncology</option>
                    </select>
                  </div>
                  <div class="form-group" id="statusDateGroup" style="display:none;">
                    <label id="statusDateLabel">Date</label>
                    <input type="date" id="statusDate">
                  </div>
                </div>
                <div class="form-row" id="statusNotesGroup" style="display:none;">
                  <div class="form-group">
                    <label id="statusNotesLabel">Notes</label>
                    <textarea id="statusNotes" placeholder="Enter reason or additional notes"></textarea>
                  </div>
                </div>
                <div id="statusHistory" style="margin-top:1rem;padding:1rem;background:var(--navy);border-radius:8px;display:none;">
                  <div style="font-size:0.75rem;font-weight:600;color:var(--muted);margin-bottom:0.5rem;letter-spacing:0.05em;">STATUS HISTORY</div>
                  <div id="statusHistoryList" style="font-size:0.8rem;color:var(--text);"></div>
                </div>
              </div>
            </div>

          </div><!-- /gc-main-content -->

          <!-- Right action panel -->
          <div class="gc-right-panel">
            <div class="gc-right-panel-title">Quick Actions</div>
            <button class="gc-right-btn" onclick="showVitalSignsModal()"><span class="gc-right-btn-icon">ğŸ’“</span>Add Vital Signs</button>
            <button class="gc-right-btn" onclick="openVitalsMonitoringPage()"><span class="gc-right-btn-icon">ğŸ“Š</span>Manage Vitals Log</button>
            <button class="gc-right-btn" onclick="showGlycemicModal()"><span class="gc-right-btn-icon">ğŸ©¸</span>Glycemic Chart</button>
            <button class="gc-right-btn" onclick="openGlucoseMonitoringPage()"><span class="gc-right-btn-icon">ğŸ©º</span>Glucose Log Page</button>
            <button class="gc-right-btn" onclick="showUrineChartModal()"><span class="gc-right-btn-icon">ğŸ’§</span>Fluid I/O Entry</button>
            <button class="gc-right-btn" onclick="openFluidChartPage()"><span class="gc-right-btn-icon">ğŸ“‹</span>Fluid Chart Page</button>
            <button class="gc-right-btn" onclick="showMedicationModal()"><span class="gc-right-btn-icon">ğŸ’Š</span>Medication Given</button>
            <button class="gc-right-btn" onclick="openMedicationPlanPage()"><span class="gc-right-btn-icon">ğŸ“</span>Medication Plan</button>
            <button class="gc-right-btn" onclick="openMedicationAdminPage()"><span class="gc-right-btn-icon">ğŸ’‰</span>Admin Log Page</button>
            <button class="gc-right-btn" onclick="showDailyCareModal()"><span class="gc-right-btn-icon">ğŸ—’ï¸</span>Daily Care Report</button>
            <button class="gc-right-btn" onclick="showHMSPasteModal()"><span class="gc-right-btn-icon">ğŸ”—</span>Paste from HMS</button>
            <button class="gc-right-btn" onclick="printRecord()"><span class="gc-right-btn-icon">ğŸ–¨ï¸</span>Print Record</button>
            <button class="gc-right-btn" onclick="exportToCSV()"><span class="gc-right-btn-icon">ğŸ“¤</span>Export CSV</button>
          </div>

        </div><!-- /gc-body-layout -->
        <!-- Care History Read-Only Display -->
        <div class="section" id="careHistorySection" style="display: none;">
          <div class="section-title">ğŸ“œ Patient Care History (Read-Only)</div>
          <div id="careHistoryDisplay" class="care-history-container"></div>
        </div>

        <!-- Vitals Log (Read-Only) -->
        <div class="section">
          <div class="section-title-row">
            <div class="section-title">ğŸ“Š Vitals Monitoring Log (Read-Only)</div>
            <button class="btn btn-primary btn-small" onclick="openVitalsMonitoringPage()"
              style="background: linear-gradient(135deg, var(--teal), #06b6d4);">
              âœï¸ Manage Vitals Log
            </button>
          </div>
          <p style="font-size: 0.82rem; color: var(--muted); margin-bottom: 1rem;">
            Patient vital signs record. Click "Manage Vitals Log" to add or edit entries.
          </p>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Time</th>
                  <th>BP (mmHg)</th>
                  <th>HR (bpm)</th>
                  <th>Temp (Â°C)</th>
                  <th>RR (/min)</th>
                  <th>SpOâ‚‚ (%)</th>
                  <th>Recorded By</th>
                </tr>
              </thead>
              <tbody id="vitalsTableBody"></tbody>
            </table>
          </div>
          <div id="vitalsEmpty" style="display: none; text-align: center; padding: 2rem; color: var(--muted); font-size: 0.9rem;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ“Š</div>
            <div>No vitals recorded yet</div>
            <div style="font-size: 0.8rem; margin-top: 0.5rem;">Click "Manage Vitals Log" to add entries</div>
          </div>
        </div>

        <!-- Prescribed Medications List (Read-Only) -->
        <div class="section">
          <div class="section-title-row">
            <div class="section-title">ğŸ“ Prescribed Medications (Read-Only)</div>
            <button class="btn btn-primary btn-small" onclick="openMedicationPlanPage()" 
              style="background: linear-gradient(135deg, var(--teal), #06b6d4);">
              âœï¸ New Prescribed Medications Plan
            </button>
          </div>
          <p style="font-size: 0.82rem; color: var(--muted); margin-bottom: 1rem;">
            Complete list of medications currently prescribed for this patient. Click "New Prescribed Medications Plan" to add or modify medications.
          </p>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Drug Name</th>
                  <th>Dosage</th>
                  <th>Route</th>
                  <th>Frequency</th>
                  <th>Start Date</th>
                  <th>End Date</th>
                  <th>Special Instructions</th>
                </tr>
              </thead>
              <tbody id="prescribedMedTableBody"></tbody>
            </table>
          </div>
          <div id="prescribedMedEmpty" style="display: none; text-align: center; padding: 2rem; color: var(--muted); font-size: 0.9rem;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ’Š</div>
            <div>No medications prescribed yet</div>
            <div style="font-size: 0.8rem; margin-top: 0.5rem;">Click "New Prescribed Medications Plan" to add medications</div>
          </div>
        </div>

        <!-- Medication Administration Log (Read-Only) -->
        <div class="section">
          <div class="section-title-row">
            <div class="section-title">ğŸ’Š Medication Administration Log (Read-Only)</div>
            <button class="btn btn-primary btn-small" onclick="openMedicationAdminPage()" 
              style="background: linear-gradient(135deg, var(--teal), #06b6d4);">
              âœï¸ Manage Administration Log
            </button>
          </div>
          <p style="font-size: 0.82rem; color: var(--muted); margin-bottom: 1rem;">
            Record of actual medication administrations. Click "Manage Administration Log" to add entries.
          </p>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Drug Name</th>
                  <th>Dosage</th>
                  <th>Route</th>
                  <th>Status</th>
                  <th>Nurse on Duty</th>
                  <th>Additional Notes</th>
                </tr>
              </thead>
              <tbody id="medTableBody"></tbody>
            </table>
          </div>
          <div id="medAdminEmpty" style="display: none; text-align: center; padding: 2rem; color: var(--muted); font-size: 0.9rem;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ’Š</div>
            <div>No medication administrations recorded yet</div>
            <div style="font-size: 0.8rem; margin-top: 0.5rem;">Click "Manage Administration Log" to add entries</div>
          </div>
        </div>

        <!-- Blood Glucose Monitoring (Read-Only) -->
        <div class="section">
          <div class="section-title-row">
            <div class="section-title">ğŸ©¸ Blood Glucose Monitoring (6-Point) (Read-Only)</div>
            <button class="btn btn-primary btn-small" onclick="openGlucoseMonitoringPage()" 
              style="background: linear-gradient(135deg, var(--teal), #06b6d4);">
              âœï¸ Manage Glucose Readings
            </button>
          </div>
          <p style="font-size: 0.82rem; color: var(--muted); margin-bottom: 0.5rem;">
            6-point blood glucose monitoring. Click "Manage Glucose Readings" to add entries.
          </p>
          <p style="font-size: 0.75rem; color: var(--muted); margin-bottom: 1rem;">
            ğŸ’¡ Normal ranges: Fasting 4.0-7.8 mmol/L â€¢ Post-meal &lt;10 mmol/L
          </p>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Fasting</th>
                  <th>Post-Breakfast</th>
                  <th>Pre-Lunch</th>
                  <th>Post-Lunch</th>
                  <th>Pre-Dinner</th>
                  <th>Bedtime</th>
                  <th>Recorded By</th>
                </tr>
              </thead>
              <tbody id="glycemicTableBody"></tbody>
            </table>
          </div>
          <div id="glycemicEmpty" style="display: none; text-align: center; padding: 2rem; color: var(--muted); font-size: 0.9rem;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ©¸</div>
            <div>No glucose readings recorded yet</div>
            <div style="font-size: 0.8rem; margin-top: 0.5rem;">Click "Manage Glucose Readings" to add entries</div>
          </div>
        </div>

        <!-- Fluid I/O Chart (Read-Only) -->
        <div class="section">
          <div class="section-title-row">
            <div class="section-title">ğŸ’§ Fluid Intake & Output Chart (Read-Only)</div>
            <button class="btn btn-primary btn-small" onclick="openFluidChartPage()" 
              style="background: linear-gradient(135deg, var(--teal), #06b6d4);">
              âœï¸ Manage Fluid Chart
            </button>
          </div>
          <p style="font-size: 0.82rem; color: var(--muted); margin-bottom: 1rem;">
            Fluid intake and output monitoring. Click "Manage Fluid Chart" to add entries.
          </p>
          
          <!-- Balance Summary Cards -->
          <div class="vitals-grid" style="margin-bottom: 1.5rem;">
            <div class="vital-card">
              <div class="vital-label">Total Intake (24h)</div>
              <div class="vital-value" id="totalIntake">0<span class="vital-unit">mL</span></div>
            </div>
            <div class="vital-card">
              <div class="vital-label">Total Output (24h)</div>
              <div class="vital-value" id="totalOutput">0<span class="vital-unit">mL</span></div>
            </div>
            <div class="vital-card" id="fluidBalanceCard">
              <div class="vital-label">Net Balance (24h)</div>
              <div class="vital-value" id="fluidBalance">0<span class="vital-unit">mL</span></div>
            </div>
          </div>

          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Type</th>
                  <th>Intake Oral (mL)</th>
                  <th>Intake IV (mL)</th>
                  <th>Output Urine (mL)</th>
                  <th>Output Other (mL)</th>
                  <th>Notes</th>
                  <th>Recorded By</th>
                </tr>
              </thead>
              <tbody id="fluidTableBody"></tbody>
            </table>
          </div>
          <div id="fluidEmpty" style="display: none; text-align: center; padding: 2rem; color: var(--muted); font-size: 0.9rem;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ’§</div>
            <div>No fluid entries recorded yet</div>
            <div style="font-size: 0.8rem; margin-top: 0.5rem;">Click "Manage Fluid Chart" to add entries</div>
          </div>
        </div>

        <!-- 24-Hour Nursing Report (includes Ward Statistics) -->
        <div class="section">
          <div class="section-title-row" style="margin-bottom: 0.6rem;">
            <div class="section-title">ğŸ“‹ 24-Hour Nursing Report</div>
          </div>
          <p style="font-size: 0.82rem; color: var(--muted); margin-bottom: 1.4rem;">
            Click a section below to open it. All changes are saved automatically.
          </p>

          <!-- â”€â”€ Toggle Button Row â”€â”€ -->
          <div style="display: flex; flex-wrap: wrap; gap: 0.7rem; margin-bottom: 1.5rem;">

            <!-- Ward Statistics button -->
            <button onclick="toggleNursingPanel('panel_ward_stat', this)"
              style="display:flex; align-items:center; gap:8px; padding:10px 18px; border-radius:10px; border:1px solid rgba(45,212,191,0.35); background:rgba(45,212,191,0.08); color:var(--teal); font-family:'DM Sans',sans-serif; font-size:0.85rem; font-weight:600; cursor:pointer; transition:all 0.2s;">
              <span style="font-size:1.1rem;">ğŸ“Š</span> Ward Statistics
              <span style="margin-left:4px; font-size:0.75rem; opacity:0.7;">â–¼</span>
            </button>

            <!-- Patient Details button -->
            <button onclick="toggleNursingPanel('panel_patient_details', this)"
              style="display:flex; align-items:center; gap:8px; padding:10px 18px; border-radius:10px; border:1px solid rgba(45,212,191,0.35); background:rgba(45,212,191,0.08); color:var(--teal); font-family:'DM Sans',sans-serif; font-size:0.85rem; font-weight:600; cursor:pointer; transition:all 0.2s;">
              <span style="font-size:1.1rem;">ğŸ“‹</span> Patient Details
              <span style="margin-left:4px; font-size:0.75rem; opacity:0.7;">â–¼</span>
            </button>

            <!-- Nursing Report Entries button -->
            <button onclick="toggleNursingPanel('panel_nursing_entries', this)"
              style="display:flex; align-items:center; gap:8px; padding:10px 18px; border-radius:10px; border:1px solid rgba(99,102,241,0.35); background:rgba(99,102,241,0.08); color:#818cf8; font-family:'DM Sans',sans-serif; font-size:0.85rem; font-weight:600; cursor:pointer; transition:all 0.2s;">
              <span style="font-size:1.1rem;">ğŸ“</span> Nursing Report Entries
              <span style="margin-left:4px; font-size:0.75rem; opacity:0.7;">â–¼</span>
            </button>

            <!-- Blood Transfusion button -->
            <button onclick="toggleNursingPanel('panel_blood_transfusion', this)"
              style="display:flex; align-items:center; gap:8px; padding:10px 18px; border-radius:10px; border:1px solid rgba(244,63,94,0.35); background:rgba(244,63,94,0.08); color:#f43f5e; font-family:'DM Sans',sans-serif; font-size:0.85rem; font-weight:600; cursor:pointer; transition:all 0.2s;">
              <span style="font-size:1.1rem;">ğŸ©¸</span> Blood Transfusion
              <span style="margin-left:4px; font-size:0.75rem; opacity:0.7;">â–¼</span>
            </button>

          </div>

          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               PANEL 1 â€” Ward Statistics
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <div id="panel_ward_stat" style="display:none; margin-bottom:1.5rem;">
            <div style="background:var(--deep); border:1px solid rgba(45,212,191,0.25); border-radius:12px; padding:1.4rem;">

              <!-- Panel header -->
              <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1.2rem;">
                <div style="display:flex; align-items:center; gap:8px;">
                  <span style="display:inline-block; width:3px; height:18px; background:var(--teal); border-radius:2px;"></span>
                  <span style="font-weight:700; font-size:0.95rem; color:var(--text);">ğŸ“Š Ward Statistics</span>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                  <button class="btn btn-primary btn-small" onclick="saveWardStatistics()"
                    style="background:linear-gradient(135deg,#3b82f6,#2563eb);">ğŸ’¾ Save Statistics</button>
                  <button onclick="closeNursingPanel('panel_ward_stat')"
                    style="background:rgba(244,63,94,0.12); border:1px solid rgba(244,63,94,0.3); color:#f43f5e; border-radius:8px; padding:6px 14px; font-size:0.82rem; font-weight:600; cursor:pointer; font-family:'DM Sans',sans-serif;">âœ• Close</button>
                </div>
              </div>

              <div class="table-container" style="margin-bottom: 0;">
                <table style="font-size: 0.82rem;">
                  <thead>
                    <tr>
                      <th rowspan="2" style="vertical-align: middle; min-width:80px;">SHIFTS</th>
                      <th colspan="2" style="text-align: center;">BED</th>
                      <th colspan="1" style="text-align: center;">ADM</th>
                      <th colspan="1" style="text-align: center;">DISC</th>
                      <th colspan="4" style="text-align: center;">TRANSFERS</th>
                      <th colspan="5" style="text-align: center;">SPECIAL CASES</th>
                      <th colspan="2" style="text-align: center;">NURSES ON DUTY</th>
                    </tr>
                    <tr>
                      <th>OCC</th><th>VAC</th><th>ADM</th><th>DISC</th>
                      <th>INT TRANS IN</th><th>INT TRANS OUT</th><th>EXT TRANS IN</th><th>EXT TRANS OUT</th>
                      <th>DAMA</th><th>SIL</th><th>VSIL</th><th>ABSC</th><th>DEATH</th>
                      <th>AM Nurses</th><th>PM Nurses</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td style="font-weight:600;">MORNING</td>
                      <td><input type="number" id="ward_stat_morning_occ" style="width:60px;" onchange="saveWardStatField('morning','occ',this.value)"></td>
                      <td><input type="number" id="ward_stat_morning_vac" style="width:60px;" onchange="saveWardStatField('morning','vac',this.value)"></td>
                      <td><input type="number" id="ward_stat_morning_adm" style="width:60px;" onchange="saveWardStatField('morning','adm',this.value)"></td>
                      <td><input type="number" id="ward_stat_morning_disc" style="width:60px;" onchange="saveWardStatField('morning','disc',this.value)"></td>
                      <td><input type="number" id="ward_stat_morning_int_trans_in" style="width:70px;" onchange="saveWardStatField('morning','int_trans_in',this.value)"></td>
                      <td><input type="number" id="ward_stat_morning_int_trans_out" style="width:70px;" onchange="saveWardStatField('morning','int_trans_out',this.value)"></td>
                      <td><input type="number" id="ward_stat_morning_ext_trans_in" style="width:70px;" onchange="saveWardStatField('morning','ext_trans_in',this.value)"></td>
                      <td><input type="number" id="ward_stat_morning_ext_trans_out" style="width:70px;" onchange="saveWardStatField('morning','ext_trans_out',this.value)"></td>
                      <td><input type="number" id="ward_stat_morning_dama" style="width:60px;" onchange="saveWardStatField('morning','dama',this.value)"></td>
                      <td><input type="number" id="ward_stat_morning_sil" style="width:60px;" onchange="saveWardStatField('morning','sil',this.value)"></td>
                      <td><input type="number" id="ward_stat_morning_vsil" style="width:60px;" onchange="saveWardStatField('morning','vsil',this.value)"></td>
                      <td><input type="number" id="ward_stat_morning_absc" style="width:60px;" onchange="saveWardStatField('morning','absc',this.value)"></td>
                      <td><input type="number" id="ward_stat_morning_death" style="width:60px;" onchange="saveWardStatField('morning','death',this.value)"></td>
                      <td><input type="text" id="ward_stat_morning_nurses_am" style="width:120px;" placeholder="Nurse name(s)" onchange="saveWardStatField('morning','nurses_am',this.value)"></td>
                      <td><input type="text" id="ward_stat_morning_nurses_pm" style="width:120px;" placeholder="Nurse name(s)" onchange="saveWardStatField('morning','nurses_pm',this.value)"></td>
                    </tr>
                    <tr>
                      <td style="font-weight:600;">NIGHT</td>
                      <td><input type="number" id="ward_stat_night_occ" style="width:60px;" onchange="saveWardStatField('night','occ',this.value)"></td>
                      <td><input type="number" id="ward_stat_night_vac" style="width:60px;" onchange="saveWardStatField('night','vac',this.value)"></td>
                      <td><input type="number" id="ward_stat_night_adm" style="width:60px;" onchange="saveWardStatField('night','adm',this.value)"></td>
                      <td><input type="number" id="ward_stat_night_disc" style="width:60px;" onchange="saveWardStatField('night','disc',this.value)"></td>
                      <td><input type="number" id="ward_stat_night_int_trans_in" style="width:70px;" onchange="saveWardStatField('night','int_trans_in',this.value)"></td>
                      <td><input type="number" id="ward_stat_night_int_trans_out" style="width:70px;" onchange="saveWardStatField('night','int_trans_out',this.value)"></td>
                      <td><input type="number" id="ward_stat_night_ext_trans_in" style="width:70px;" onchange="saveWardStatField('night','ext_trans_in',this.value)"></td>
                      <td><input type="number" id="ward_stat_night_ext_trans_out" style="width:70px;" onchange="saveWardStatField('night','ext_trans_out',this.value)"></td>
                      <td><input type="number" id="ward_stat_night_dama" style="width:60px;" onchange="saveWardStatField('night','dama',this.value)"></td>
                      <td><input type="number" id="ward_stat_night_sil" style="width:60px;" onchange="saveWardStatField('night','sil',this.value)"></td>
                      <td><input type="number" id="ward_stat_night_vsil" style="width:60px;" onchange="saveWardStatField('night','vsil',this.value)"></td>
                      <td><input type="number" id="ward_stat_night_absc" style="width:60px;" onchange="saveWardStatField('night','absc',this.value)"></td>
                      <td><input type="number" id="ward_stat_night_death" style="width:60px;" onchange="saveWardStatField('night','death',this.value)"></td>
                      <td><input type="text" id="ward_stat_night_nurses_am" style="width:120px;" placeholder="Nurse name(s)" onchange="saveWardStatField('night','nurses_am',this.value)"></td>
                      <td><input type="text" id="ward_stat_night_nurses_pm" style="width:120px;" placeholder="Nurse name(s)" onchange="saveWardStatField('night','nurses_pm',this.value)"></td>
                    </tr>
                    <tr style="background:rgba(45,212,191,0.1); font-weight:600;">
                      <td>TOTAL</td>
                      <td id="ward_stat_total_occ">â€”</td><td id="ward_stat_total_vac">â€”</td>
                      <td id="ward_stat_total_adm">â€”</td><td id="ward_stat_total_disc">â€”</td>
                      <td id="ward_stat_total_int_trans_in">â€”</td><td id="ward_stat_total_int_trans_out">â€”</td>
                      <td id="ward_stat_total_ext_trans_in">â€”</td><td id="ward_stat_total_ext_trans_out">â€”</td>
                      <td id="ward_stat_total_dama">â€”</td><td id="ward_stat_total_sil">â€”</td>
                      <td id="ward_stat_total_vsil">â€”</td><td id="ward_stat_total_absc">â€”</td>
                      <td id="ward_stat_total_death">â€”</td>
                      <td colspan="2" style="color:var(--muted); font-weight:400; font-size:0.75rem;">Names not summed</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               PANEL 2 â€” Patient Details
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <div id="panel_patient_details" style="display:none; margin-bottom:1.5rem;">
            <div style="background:var(--deep); border:1px solid rgba(45,212,191,0.25); border-radius:12px; padding:1.4rem;">

              <!-- Panel header -->
              <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1.2rem;">
                <div style="display:flex; align-items:center; gap:8px;">
                  <span style="display:inline-block; width:3px; height:18px; background:var(--teal); border-radius:2px;"></span>
                  <span style="font-weight:700; font-size:0.95rem; color:var(--text);">ğŸ“‹ Patient Details</span>
                  <span style="font-size:0.72rem; color:var(--teal); background:rgba(45,212,191,0.1); border:1px solid rgba(45,212,191,0.25); border-radius:20px; padding:3px 10px; font-weight:600;">âŸ³ Auto-filled from patient record</span>
                </div>
                <button onclick="closeNursingPanel('panel_patient_details')"
                  style="background:rgba(244,63,94,0.12); border:1px solid rgba(244,63,94,0.3); color:#f43f5e; border-radius:8px; padding:6px 14px; font-size:0.82rem; font-weight:600; cursor:pointer; font-family:'DM Sans',sans-serif;">âœ• Close</button>
              </div>

              <!-- Auto-populated read-only fields -->
              <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:1rem; margin-bottom:1rem;">
                <div>
                  <label style="display:block; font-size:0.75rem; color:var(--muted); margin-bottom:0.3rem;">NAME</label>
                  <div id="ward_stat_patient_name" style="background:rgba(45,212,191,0.05); border:1px solid rgba(45,212,191,0.2); border-radius:8px; padding:10px 12px; color:var(--text); font-size:0.85rem; min-height:38px;">â€”</div>
                </div>
                <div>
                  <label style="display:block; font-size:0.75rem; color:var(--muted); margin-bottom:0.3rem;">AGE</label>
                  <div id="ward_stat_patient_age" style="background:rgba(45,212,191,0.05); border:1px solid rgba(45,212,191,0.2); border-radius:8px; padding:10px 12px; color:var(--text); font-size:0.85rem; min-height:38px;">â€”</div>
                </div>
                <div>
                  <label style="display:block; font-size:0.75rem; color:var(--muted); margin-bottom:0.3rem;">SEX</label>
                  <div id="ward_stat_patient_sex" style="background:rgba(45,212,191,0.05); border:1px solid rgba(45,212,191,0.2); border-radius:8px; padding:10px 12px; color:var(--text); font-size:0.85rem; min-height:38px;">â€”</div>
                </div>
                <div>
                  <label style="display:block; font-size:0.75rem; color:var(--muted); margin-bottom:0.3rem;">EMR</label>
                  <div id="ward_stat_patient_emr" style="background:rgba(45,212,191,0.05); border:1px solid rgba(45,212,191,0.2); border-radius:8px; padding:10px 12px; color:var(--text); font-size:0.85rem; min-height:38px;">â€”</div>
                </div>
                <div>
                  <label style="display:block; font-size:0.75rem; color:var(--muted); margin-bottom:0.3rem;">DATE OF ADMISSION</label>
                  <div id="ward_stat_patient_doa" style="background:rgba(45,212,191,0.05); border:1px solid rgba(45,212,191,0.2); border-radius:8px; padding:10px 12px; color:var(--text); font-size:0.85rem; min-height:38px;">â€”</div>
                </div>
                <div>
                  <label style="display:block; font-size:0.75rem; color:var(--muted); margin-bottom:0.3rem;">WARD</label>
                  <div id="ward_stat_patient_ward" style="background:rgba(45,212,191,0.05); border:1px solid rgba(45,212,191,0.2); border-radius:8px; padding:10px 12px; color:var(--text); font-size:0.85rem; min-height:38px;">â€”</div>
                </div>
                <div>
                  <label style="display:block; font-size:0.75rem; color:var(--muted); margin-bottom:0.3rem;">DIAGNOSIS</label>
                  <div id="ward_stat_patient_diagnosis" style="background:rgba(45,212,191,0.05); border:1px solid rgba(45,212,191,0.2); border-radius:8px; padding:10px 12px; color:var(--text); font-size:0.85rem; min-height:38px;">â€”</div>
                </div>
                <div>
                  <label style="display:block; font-size:0.75rem; color:var(--muted); margin-bottom:0.3rem;">ATTENDING PHYSICIAN</label>
                  <div id="ward_stat_patient_attending" style="background:rgba(45,212,191,0.05); border:1px solid rgba(45,212,191,0.2); border-radius:8px; padding:10px 12px; color:var(--text); font-size:0.85rem; min-height:38px;">â€”</div>
                </div>
              </div>
              <!-- Editable contact fields -->
              <div style="border-top:1px solid var(--border); padding-top:1rem; margin-top:0.5rem;">
                <div style="font-size:0.72rem; color:var(--muted); font-weight:600; text-transform:uppercase; letter-spacing:0.08em; margin-bottom:0.7rem;">Additional Contact Info</div>
                <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:1rem;">
                  <div>
                    <label style="display:block; font-size:0.75rem; color:var(--muted); margin-bottom:0.3rem;">ADDRESS</label>
                    <input type="text" id="ward_stat_patient_address" style="width:100%;" onchange="saveWardStatPatientField('address',this.value)">
                  </div>
                  <div>
                    <label style="display:block; font-size:0.75rem; color:var(--muted); margin-bottom:0.3rem;">PHONE</label>
                    <input type="tel" id="ward_stat_patient_phone" style="width:100%;" onchange="saveWardStatPatientField('phone',this.value)">
                  </div>
                  <div>
                    <label style="display:block; font-size:0.75rem; color:var(--muted); margin-bottom:0.3rem;">NOK PHONE</label>
                    <input type="tel" id="ward_stat_patient_nok_phone" style="width:100%;" onchange="saveWardStatPatientField('nok_phone',this.value)">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               PANEL 3 â€” Nursing Report Entries
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <div id="panel_nursing_entries" style="display:none; margin-bottom:1.5rem;">
            <div style="background:var(--deep); border:1px solid rgba(99,102,241,0.25); border-radius:12px; padding:1.4rem;">

              <!-- Panel header -->
              <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1.2rem;">
                <div style="display:flex; align-items:center; gap:8px;">
                  <span style="display:inline-block; width:3px; height:18px; background:#818cf8; border-radius:2px;"></span>
                  <span style="font-weight:700; font-size:0.95rem; color:var(--text);">ğŸ“ Nursing Report Entries</span>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                  <button class="btn btn-primary btn-small" onclick="saveWardNursingReport()"
                    style="background:linear-gradient(135deg,#10b981,#059669);">ğŸ’¾ Save Report</button>
                  <button onclick="closeNursingPanel('panel_nursing_entries')"
                    style="background:rgba(244,63,94,0.12); border:1px solid rgba(244,63,94,0.3); color:#f43f5e; border-radius:8px; padding:6px 14px; font-size:0.82rem; font-weight:600; cursor:pointer; font-family:'DM Sans',sans-serif;">âœ• Close</button>
                </div>
              </div>

              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Date</th><th>Shift</th><th>Report</th><th>Nurse on Duty</th><th>Ward</th><th></th>
                    </tr>
                  </thead>
                  <tbody id="nursingReportTableBody"></tbody>
                </table>
              </div>
              <button class="btn btn-secondary btn-small" style="margin-top:0.8rem;" onclick="addNursingReportRow()">
                + Add Nursing Report
              </button>
            </div>
          </div>

          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               PANEL 4 â€” Blood Transfusion
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <div id="panel_blood_transfusion" style="display:none; margin-bottom:1.5rem;">
            <div style="background:var(--deep); border:1px solid rgba(244,63,94,0.25); border-radius:12px; padding:1.4rem;">

              <!-- Panel header -->
              <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1.2rem;">
                <div style="display:flex; align-items:center; gap:8px;">
                  <span style="display:inline-block; width:3px; height:18px; background:#f43f5e; border-radius:2px;"></span>
                  <span style="font-weight:700; font-size:0.95rem; color:var(--text);">ğŸ©¸ Blood Transfusion Record</span>
                </div>
                <button onclick="closeNursingPanel('panel_blood_transfusion')"
                  style="background:rgba(244,63,94,0.12); border:1px solid rgba(244,63,94,0.3); color:#f43f5e; border-radius:8px; padding:6px 14px; font-size:0.82rem; font-weight:600; cursor:pointer; font-family:'DM Sans',sans-serif;">âœ• Close</button>
              </div>

              <div id="bloodTransfusionContainer"></div>
              <button class="btn btn-secondary btn-small"
                style="margin-top:0.8rem; border-color:rgba(244,63,94,0.4); color:#f43f5e;"
                onclick="addBloodTransfusionEntry()">
                + Add Blood Transfusion
              </button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• OVERALL NURSE REPORTS VIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="overallReportsView" class="hidden">
  <header>
    <div class="logo">
      <div class="logo-icon">âš•ï¸</div>
      <div>
        <h1>MedRecord</h1>
        <span>NURSING REPORTS</span>
      </div>
    </div>
    <div style="display: flex; align-items: center; gap: 1rem;">
      <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.3rem;">
        <div class="ward-info">ğŸ“Š Nursing Reports Dashboard</div>
        <div id="overallRoleDisplay" style="font-size: 0.75rem; color: var(--muted);"></div>
      </div>
      <div class="actions">
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
          <span class="theme-toggle-icon" id="themeIcon2">ğŸŒ™</span>
          <span id="themeText2">Dark</span>
        </button>
        <button class="btn btn-primary btn-small" onclick="saveAllNursingReports()"
          style="background:linear-gradient(135deg,#10b981,#059669);">
          ğŸ’¾ Save
        </button>
        <button class="btn btn-secondary btn-small" onclick="printAllReports()">ğŸ–¨ï¸ Print</button>
        <button class="btn btn-primary btn-small" onclick="openShareModal()"
          style="background:linear-gradient(135deg,#3b82f6,#6366f1);">
          ğŸ“¤ Send / Share
        </button>
        <button class="btn btn-secondary btn-small" onclick="switchToPatientView()">ğŸ‘¥ Patient View</button>
        <button class="btn btn-danger btn-small" onclick="logout()">Logout</button>
      </div>
    </div>
  </header>

  <div class="main" style="padding: 2rem 3rem;">
    <!-- Notepad Widget -->
    <div class="notepad-widget">
      <div class="notepad-header">
        <h3>ğŸ“ Daily Notes & Observations</h3>
        <button class="btn btn-secondary btn-small" onclick="saveNotepad()">ğŸ’¾ Save Notes</button>
      </div>
      <textarea 
        id="dailyNotepad" 
        class="notepad-textarea" 
        placeholder="Enter important observations, reminders, or notes for the nursing team...&#10;&#10;Examples:&#10;â€¢ Staffing updates&#10;â€¢ Equipment issues&#10;â€¢ Patient care priorities&#10;â€¢ Interdepartmental communications"
        oninput="notepadModified()"></textarea>
      <div class="notepad-footer">
        <span id="notepadStatus">Auto-saved</span>
        <span id="notepadTimestamp"></span>
      </div>
    </div>

    <!-- Filter bar -->
    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <label style="font-size: 0.85rem; color: var(--muted);">Filter by Date:</label>
        <input type="date" id="reportFilterDate" onchange="renderOverallReports()" 
          style="padding: 8px; border-radius: 6px; border: 1px solid var(--border); background: var(--card); color: var(--text);">
        <button class="btn btn-secondary btn-small" onclick="clearDateFilter()">Clear</button>
      </div>
      <div class="rpt-toolbar" style="margin: 0; flex: 1;">
        <span class="rpt-toolbar-label">ğŸ“‹ Actions</span>
        <button class="btn btn-primary btn-small" onclick="saveAllNursingReports()" style="background:linear-gradient(135deg,#10b981,#059669);">ğŸ’¾ Save All</button>
        <button class="btn btn-secondary btn-small" onclick="printAllReports()">ğŸ–¨ï¸ Print</button>
        <button class="btn btn-secondary btn-small" onclick="exportAllReportsToCSV()">ğŸ“Š CSV</button>
        <button class="btn btn-secondary btn-small" onclick="exportReportHTML()">ğŸ“„ Save File</button>
        <button class="btn btn-primary btn-small" onclick="openShareModal()" style="background:linear-gradient(135deg,#3b82f6,#6366f1);">ğŸ“¤ Send / Share</button>
      </div>
    </div>

    <!-- Per-ward unified 24-Hour Nursing Reports -->
    <div id="allWardsReports"></div>
  </div>
</div>

<!-- â”€â”€ Share Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="shareModal" class="share-overlay hidden">
  <div class="share-box">
    <div class="share-head">
      <h3>ğŸ“¤ Send &amp; Share Reports</h3>
      <button class="modal-close" onclick="closeShareModal()">Ã—</button>
    </div>
    <div class="share-body">
      <p style="font-size:.8rem;color:var(--muted);margin-bottom:.9rem;">Choose what to include, then pick a sharing method.</p>

      <!-- Scope -->
      <div style="font-size:.7rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-bottom:.4rem;">Content</div>
      <div class="share-scope-row">
        <button class="share-scope-btn on" onclick="setScope('all',this)">All Wards</button>
        <button class="share-scope-btn"   onclick="setScope('date',this)">Filtered Date</button>
        <button class="share-scope-btn"   onclick="setScope('summary',this)">Summary Only</button>
      </div>

      <!-- Grid of methods -->
      <div style="font-size:.7rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-bottom:.6rem;">Send via</div>
      <div class="share-grid">
        <div class="share-card sc-save"     onclick="exportReportHTML()">
          <div class="share-card-icon">ğŸ’¾</div>
          <div class="share-card-label">Download File</div>
          <div class="share-card-desc">Save .html â€” open in any browser</div>
        </div>
        <div class="share-card sc-print"    onclick="printAllReports()">
          <div class="share-card-icon">ğŸ–¨ï¸</div>
          <div class="share-card-label">Print / PDF</div>
          <div class="share-card-desc">Print or save as PDF</div>
        </div>
        <div class="share-card sc-csv"      onclick="exportAllReportsToCSV()">
          <div class="share-card-icon">ğŸ“Š</div>
          <div class="share-card-label">Export CSV</div>
          <div class="share-card-desc">Spreadsheet format</div>
        </div>
        <div class="share-card sc-email"    onclick="shareEmail()">
          <div class="share-card-icon">ğŸ“§</div>
          <div class="share-card-label">Email</div>
          <div class="share-card-desc">Open mail app with report</div>
        </div>
        <div class="share-card sc-whatsapp" onclick="shareWhatsApp()">
          <div class="share-card-icon">ğŸ’¬</div>
          <div class="share-card-label">WhatsApp</div>
          <div class="share-card-desc">Send summary via WhatsApp</div>
        </div>
        <div class="share-card sc-copy"     onclick="shareCopy()">
          <div class="share-card-icon">ğŸ“‹</div>
          <div class="share-card-label">Copy Text</div>
          <div class="share-card-desc">Paste into any app</div>
        </div>
        <div class="share-card sc-system"   onclick="shareSystem()">
          <div class="share-card-icon">ğŸ”—</div>
          <div class="share-card-label">Share Sheet</div>
          <div class="share-card-desc">AirDrop, Nearby Shareâ€¦</div>
        </div>
        <div class="share-card sc-bt"       onclick="shareBluetooth()">
          <div class="share-card-icon">ğŸ”µ</div>
          <div class="share-card-label">Bluetooth</div>
          <div class="share-card-desc">Send to nearby device</div>
        </div>
        <div class="share-card sc-print"    onclick="shareQR()" style="border-color:rgba(244,63,94,.3)">
          <div class="share-card-icon">ğŸ“±</div>
          <div class="share-card-label">QR Code</div>
          <div class="share-card-desc">Scan to receive on phone</div>
        </div>
      </div>

      <!-- Status / feedback -->
      <div id="shareMsg" class="share-msg"></div>

      <!-- QR display area -->
      <div id="qrArea" style="display:none;text-align:center;margin-top:1rem;">
        <div style="font-size:.8rem;color:var(--muted);margin-bottom:.6rem;">Scan with phone camera to receive report</div>
        <canvas id="qrCanvas" style="border-radius:10px;"></canvas>
        <div style="font-size:.72rem;color:var(--muted);margin-top:.5rem;">Valid for this session only</div>
      </div>
    </div>
  </div>
</div>
<div class="toast" id="toast">
  <span class="toast-icon">âœ“</span>
  <span id="toastMsg">Saved successfully</span>
</div>

<!-- Bulk Import Modal -->
<div id="bulkImportModal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <h3>ğŸ“‹ Paste Multiple Medications</h3>
      <button class="modal-close" onclick="closeBulkImportDialog()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="help-text">
        <strong>How to use:</strong>
        Paste medication list from your clipboard. The system will automatically detect dosage, frequency, and route.
        <br><br>
        <strong>Smart Detection:</strong>
        <br>â€¢ Dosage: Extracts patterns like "500mg", "10mcg", "1g", "2.5mg"
        <br>â€¢ Frequency: Recognizes BID, TID, QID, PRN, BD, OD, Once daily, Twice daily, etc.
        <br>â€¢ Route: Auto-detects - "Tabs/Tablet" = PO, "Injection" = IV/IM, "Cream/Ointment" = Topical
        <br><br>
        <strong>Supported formats:</strong>
        <br>â€¢ Simple list: One medication per line
        <br>â€¢ With details: <code>Drug Name | Dosage | Route | Frequency | Instructions</code>
        <br>â€¢ From spreadsheet: Copy and paste directly from Excel
        <br><br>
        <strong>Examples:</strong>
        <br><code>Metformin 500mg tabs BD - Take with meals</code>
        <br><code>Lisinopril 10mg once daily</code>
        <br><code>Aspirin 81mg PO daily</code>
        <br><code>Insulin Injection 10 units BD</code>
      </div>
      <div class="form-group">
        <label>Paste Medications Here:</label>
        <textarea id="bulkMedInput" placeholder="Paste your medication list here...
Examples:
Metformin 500mg tabs BD - Take with meals
Lisinopril 10mg once daily
Aspirin 81mg PO daily for cardioprotection
Insulin Injection 10 units BD
Paracetamol 500mg tabs PRN for pain" 
          style="min-height: 200px; font-family: 'Courier New', monospace; font-size: 0.85rem;"></textarea>
      </div>
      <div class="form-group">
        <label>Delimiter (optional - auto-detected if blank):</label>
        <select id="bulkDelimiter" style="max-width: 200px;">
          <option value="">Auto-detect</option>
          <option value="|">Pipe (|)</option>
          <option value=",">Comma (,)</option>
          <option value="\t">Tab</option>
          <option value=";">Semicolon (;)</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeBulkImportDialog()">Cancel</button>
      <button class="btn btn-primary" onclick="processBulkImport()">Import Medications</button>
    </div>
  </div>
</div>

<!-- Paste Vitals Modal -->
<div id="pasteVitalsModal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <h3>ğŸ“‹ Paste Vitals Data</h3>
      <button class="modal-close" onclick="closePasteVitalsDialog()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="help-text">
        <strong>How to use:</strong>
        Paste vitals data copied from any source. The system will automatically detect and align the data.
        <br><br>
        <strong>Supported formats:</strong>
        <br>â€¢ Spreadsheet data (Excel, Google Sheets) - just copy and paste
        <br>â€¢ Comma-separated values (CSV)
        <br>â€¢ Tab-separated values (TSV)
        <br>â€¢ Space-separated values
        <br><br>
        <strong>Column detection:</strong>
        The system automatically recognizes:
        <br>â€¢ Date (DD/MM/YYYY, YYYY-MM-DD, MM-DD-YYYY, etc.)
        <br>â€¢ Time (HH:MM, HH:MM AM/PM)
        <br>â€¢ BP (120/80, 120 80, 120-80)
        <br>â€¢ HR (60-100 bpm, just numbers)
        <br>â€¢ Temperature (36.5, 98.6, with Â°C or Â°F)
        <br>â€¢ RR (12-20, respiratory rate)
        <br>â€¢ SpOâ‚‚ (95-100, oxygen saturation)
        <br><br>
        <strong>Examples:</strong>
        <br><code>01/15/2024  08:00  120/80  72  36.5  16  98</code>
        <br><code>2024-01-15, 08:00 AM, 120/80, 72 bpm, 36.5Â°C, 16/min, 98%</code>
        <br>Or copy directly from Excel/Sheets (with or without headers)
      </div>
      <div class="form-group">
        <label>Paste Vitals Data Here:</label>
        <textarea id="pasteVitalsInput" placeholder="Paste your vitals data here...

Examples:
01/15/2024  08:00  120/80  72  36.5  16  98
01/15/2024  14:00  118/76  68  36.7  14  99
01/16/2024  08:00  122/82  75  36.4  15  97

Or with commas:
Date, Time, BP, HR, Temp, RR, SpO2
01/15/2024, 08:00, 120/80, 72, 36.5, 16, 98
01/15/2024, 14:00, 118/76, 68, 36.7, 14, 99" 
          style="min-height: 250px; font-family: 'Courier New', monospace; font-size: 0.85rem;"></textarea>
      </div>
      <div id="pasteVitalsPreview" style="display: none; margin-top: 1rem;">
        <div style="font-size: 0.85rem; font-weight: 600; color: var(--teal); margin-bottom: 0.5rem;">
          Preview (detected <span id="previewCount">0</span> entries):
        </div>
        <div id="pasteVitalsPreviewTable" style="max-height: 200px; overflow-y: auto; background: var(--navy); border: 1px solid var(--border); border-radius: 8px; padding: 0.5rem;"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closePasteVitalsDialog()">Cancel</button>
      <button class="btn btn-primary" id="parseVitalsBtn" onclick="parseAndPreviewVitals()">Parse & Preview</button>
      <button class="btn btn-primary" id="importVitalsBtn" onclick="importParsedVitals()" style="display: none;">Import Vitals</button>
    </div>
  </div>
</div>

<!-- HMS Smart Paste Modal -->
<div id="hmsPasteModal" class="modal-overlay hidden">
  <div class="modal" style="max-width: 680px;">
    <div class="modal-header">
      <h3>ğŸ“‹ Import from GlobalCare HMS</h3>
      <button class="modal-close" onclick="closeHMSPasteModal()">Ã—</button>
    </div>
    <div class="modal-body">

      <!-- Tabs -->
      <div class="hms-paste-tabs">
        <button class="hms-paste-tab active" onclick="switchHMSTab('smart', this)">ğŸ§  Smart Auto-Parse</button>
        <button class="hms-paste-tab" onclick="switchHMSTab('manual', this)">âœï¸ Manual Fill</button>
        <button class="hms-paste-tab" onclick="switchHMSTab('api', this)">ğŸ”— API Credentials</button>
      </div>

      <!-- SMART PARSE TAB -->
      <div class="hms-tab-panel active" id="hmsTab-smart">
        <div class="help-text">
          <strong>How to use Smart Auto-Parse:</strong>
          Open GlobalCare HMS in any tab â†’ navigate to the patient â†’ select all text on that page (Ctrl+A) â†’ copy (Ctrl+C) â†’ come back here and paste below.
          <br><br>
          The parser will automatically extract: Patient Name, EMR Number, Date of Birth, Gender, Diagnosis, Allergies, Attending Physician, Ward, and Admission Date.
        </div>
        <div class="form-group">
          <label>Paste HMS Page Text Here (Ctrl+V):</label>
          <textarea id="hmsPasteInput" 
            placeholder="Paste the copied text from your GlobalCare HMS patient page here...

The system will automatically detect and extract:
â€¢ Patient full name
â€¢ EMR / patient number
â€¢ Date of birth
â€¢ Gender
â€¢ Diagnosis / condition
â€¢ Known allergies
â€¢ Attending physician
â€¢ Ward assignment
â€¢ Admission date

Just paste everything â€” the parser handles messy or structured text." 
            style="min-height: 200px; font-family: 'Courier New', monospace; font-size: 0.82rem; line-height: 1.5;"
            oninput="liveParseHMS()"></textarea>
        </div>
        <div id="parsePreviewCard" class="parse-preview-card" style="display: none;">
          <div class="preview-title">âœ¨ Detected Patient Data â€” Review before applying</div>
          <div id="parseFieldRows"></div>
          <div style="font-size: 0.75rem; color: var(--muted); margin-top: 0.5rem; font-style: italic;" id="parseStats"></div>
        </div>
      </div>

      <!-- MANUAL FILL TAB -->
      <div class="hms-tab-panel" id="hmsTab-manual">
        <div class="help-text">
          <strong>Manual Quick-Fill:</strong>
          Open HMS in another tab, read the patient information, and type or paste each field below. Click "Apply to Record" when done.
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem;">
          <div class="split-field-group">
            <label>Full Name</label>
            <input type="text" id="manualName" placeholder="Patient full name">
          </div>
          <div class="split-field-group">
            <label>EMR / Patient Number</label>
            <input type="text" id="manualEMR" placeholder="e.g. EMR-2024-0001">
          </div>
          <div class="split-field-group">
            <label>Date of Birth</label>
            <input type="date" id="manualDOB">
          </div>
          <div class="split-field-group">
            <label>Gender</label>
            <select id="manualGender">
              <option value="">Select</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="split-field-group">
            <label>Attending Physician</label>
            <input type="text" id="manualAttending" placeholder="Dr. Name">
          </div>
          <div class="split-field-group">
            <label>Admission Date</label>
            <input type="date" id="manualAdmission">
          </div>
          <div class="split-field-group" style="grid-column: 1/-1;">
            <label>Diagnosis</label>
            <textarea id="manualDiagnosis" placeholder="Primary diagnosis / condition" style="min-height: 60px;"></textarea>
          </div>
          <div class="split-field-group" style="grid-column: 1/-1;">
            <label>Known Allergies</label>
            <textarea id="manualAllergies" placeholder="List any known allergies" style="min-height: 60px;"></textarea>
          </div>
        </div>
      </div>

      <!-- API TAB -->
      <div class="hms-tab-panel" id="hmsTab-api">
        <div class="help-text">
          <strong>API Integration:</strong>
          If your GlobalCare HMS exposes a REST API, enter the endpoint and credentials below. Once configured, clicking "API Fetch" will automatically retrieve patient data by EMR number without opening HMS.
          <br><br>
          <strong>GlobalCare HMS API format (typical):</strong><br>
          <code>https://na.globalcarehms.com/api/patients/{emr}</code><br><br>
          Contact your HMS administrator for the correct API endpoint and credentials.
        </div>
        <div class="form-group">
          <label>HMS API Endpoint URL</label>
          <input type="text" id="quickApiUrl" placeholder="https://na.globalcarehms.com/api/patients/{emr}"
            style="font-family: 'Courier New', monospace; font-size: 0.82rem;">
          <div style="font-size: 0.72rem; color: var(--muted); margin-top: 3px;">Use <code>{emr}</code> as placeholder for the patient EMR number</div>
        </div>
        <div class="form-group">
          <label>Authentication</label>
          <select id="quickApiAuth" onchange="toggleQuickApiAuth()">
            <option value="none">No Authentication (Open API)</option>
            <option value="bearer">Bearer Token</option>
            <option value="apikey">API Key</option>
            <option value="basic">Username / Password</option>
          </select>
        </div>
        <div id="quickApiBearer" style="display: none;" class="form-group">
          <label>Bearer Token</label>
          <input type="password" id="quickBearerToken" placeholder="Paste your bearer token">
        </div>
        <div id="quickApiKeyFields" style="display: none;" class="form-group">
          <label>API Key</label>
          <input type="password" id="quickApiKey" placeholder="Your API key">
          <label style="margin-top:0.5rem;">Header Name</label>
          <input type="text" id="quickApiKeyHeader" placeholder="X-API-Key" value="X-API-Key">
        </div>
        <div id="quickApiBasic" style="display: none;" class="form-group">
          <label>Username</label>
          <input type="text" id="quickApiUsername" placeholder="API username">
          <label style="margin-top:0.5rem;">Password</label>
          <input type="password" id="quickApiPassword" placeholder="API password">
        </div>
        <div style="display: flex; gap: 0.6rem; margin-top: 1rem; align-items: center;">
          <button class="btn btn-secondary" onclick="testQuickApiConnection()">ğŸ” Test Connection</button>
          <button class="btn btn-primary" onclick="saveQuickApiSettings()">ğŸ’¾ Save & Apply Settings</button>
          <div id="quickApiTestResult" style="font-size: 0.82rem; margin-left: 0.5rem;"></div>
        </div>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeHMSPasteModal()">Cancel</button>
      <button class="btn btn-secondary" onclick="openHMSInNewTab()">ğŸŒ Open HMS in New Tab</button>
      <button class="btn btn-primary" id="hmsPasteApplyBtn" onclick="applyHMSData()" style="display:none;">âœ… Apply to Patient Record</button>
      <button class="btn btn-primary" id="hmsManualApplyBtn" onclick="applyManualData()" style="display:none;">âœ… Apply to Patient Record</button>
    </div>
  </div>
</div>

<!-- Split Screen Overlay -->
<div id="splitScreenOverlay" class="split-screen-overlay hidden">
  <div class="split-screen-header">
    <div class="split-screen-title">
      âŠ Split View â€” GlobalCare HMS + Patient Form
      <span style="font-size: 0.72rem; font-weight: 400; color: var(--muted);">Fill the form on the right using data from HMS on the left</span>
    </div>
    <div style="display: flex; gap: 0.6rem; align-items: center;">
      <span id="splitStatusIndicator" style="font-size: 0.78rem; color: var(--muted);">ğŸ“‹ Fill the form fields from HMS data</span>
      <button class="btn btn-primary btn-small" onclick="applySplitData()">âœ… Apply & Close</button>
      <button class="btn btn-danger btn-small" onclick="closeSplitScreen()">âœ• Close</button>
    </div>
  </div>
  <div class="split-screen-body">
    <!-- Left pane: HMS iframe -->
    <div class="split-pane">
      <div class="split-pane-header">
        ğŸ¥ GlobalCare HMS â€” Patient Lookup
        <div style="display: flex; gap: 6px;">
          <input type="text" id="splitHmsUrl" 
            value="https://na.globalcarehms.com/ords/r/hms_na/f_11310211811810812510212/15?clear=15&session=16811471341665"
            style="font-size: 0.72rem; padding: 4px 8px; border-radius: 5px; border: 1px solid var(--border); background: var(--navy); color: var(--text); width: 280px; font-family: monospace;">
          <button class="btn btn-secondary btn-small" onclick="reloadHMSFrame()" style="font-size: 0.7rem;">â†» Load</button>
        </div>
      </div>
      <div style="flex: 1; display: flex; flex-direction: column; background: #1a1a2e; align-items: center; justify-content: center; padding: 2rem; text-align: center; color: var(--muted);">
        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.4;">ğŸ¥</div>
        <div style="font-size: 0.95rem; font-weight: 600; color: var(--text); margin-bottom: 0.5rem;">GlobalCare HMS Opens in New Tab</div>
        <div style="font-size: 0.82rem; color: var(--muted); max-width: 320px; line-height: 1.6; margin-bottom: 1.5rem;">
          Due to browser security restrictions, HMS cannot be embedded directly. Click below to open HMS in a new tab â€” then come back and use the Smart Paste feature to import patient data.
        </div>
        <div style="display: flex; gap: 0.6rem; flex-wrap: wrap; justify-content: center;">
          <button class="btn btn-primary" onclick="openHMSInNewTab()">ğŸŒ Open HMS in New Tab</button>
          <button class="btn btn-secondary" onclick="closeSplitScreen(); showHMSPasteModal();">ğŸ“‹ Use Smart Paste Instead</button>
        </div>
        <div style="margin-top: 2rem; background: rgba(45,212,191,0.08); border: 1px solid rgba(45,212,191,0.2); border-radius: 10px; padding: 1rem; max-width: 360px; text-align: left;">
          <div style="font-size: 0.75rem; font-weight: 600; color: var(--teal); margin-bottom: 0.5rem;">ğŸ’¡ Workflow Tip</div>
          <div style="font-size: 0.78rem; color: var(--text); line-height: 1.6;">
            1. Open HMS â†’ find your patient<br>
            2. Select all text on the page (Ctrl+A)<br>
            3. Copy (Ctrl+C)<br>
            4. Come back â†’ click <strong>Smart Paste</strong><br>
            5. Fields fill automatically âœ“
          </div>
        </div>
      </div>
    </div>

    <!-- Right pane: Patient Form -->
    <div class="split-form-pane">
      <div class="split-pane-header">
        ğŸ“‹ Patient Information â€” Fill from HMS
        <button class="btn btn-secondary btn-small" onclick="showHMSPasteModal()" style="font-size: 0.7rem;">ğŸ“‹ Smart Paste</button>
      </div>
      <div class="split-form-scroll">
        <div class="split-field-group">
          <label>Full Name</label>
          <input type="text" id="splitName" placeholder="Patient full name">
        </div>
        <div class="split-field-group">
          <label>EMR Number</label>
          <input type="text" id="splitEMR" placeholder="e.g. EMR-2024-0001">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.7rem;">
          <div class="split-field-group">
            <label>Date of Birth</label>
            <input type="date" id="splitDOB">
          </div>
          <div class="split-field-group">
            <label>Gender</label>
            <select id="splitGender">
              <option value="">Select</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.7rem;">
          <div class="split-field-group">
            <label>Attending Physician</label>
            <input type="text" id="splitAttending" placeholder="Dr. Name">
          </div>
          <div class="split-field-group">
            <label>Admission Date</label>
            <input type="date" id="splitAdmission">
          </div>
        </div>
        <div class="split-field-group">
          <label>Diagnosis</label>
          <textarea id="splitDiagnosis" placeholder="Primary diagnosis" style="min-height: 70px;"></textarea>
        </div>
        <div class="split-field-group">
          <label>Known Allergies</label>
          <textarea id="splitAllergies" placeholder="Known allergies" style="min-height: 60px;"></textarea>
        </div>
        <div class="split-field-group">
          <label>Ward Assignment</label>
          <select id="splitWard">
            <option value="">Select Ward</option>
            <option value="Ward A">Ward A - General Medicine</option>
            <option value="Ward B">Ward B - Surgical</option>
            <option value="Ward C">Ward C - Pediatrics</option>
            <option value="Ward D">Ward D - Cardiology</option>
            <option value="Ward E">Ward E - Orthopedics</option>
            <option value="Ward F">Ward F - ICU</option>
            <option value="Ward G">Ward G - Maternity</option>
            <option value="Ward H">Ward H - Oncology</option>
          </select>
        </div>
      </div>
      <div class="split-apply-btn">
        <button class="btn btn-primary" style="flex: 1;" onclick="applySplitData()">âœ… Apply to Patient Record</button>
        <button class="btn btn-secondary" onclick="clearSplitForm()">ğŸ—‘ Clear</button>
      </div>
    </div>
  </div>
</div>

<!-- EMR Settings Modal -->
<div id="emrSettingsModal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <h3>âš™ï¸ EMR Integration Settings</h3>
      <button class="modal-close" onclick="closeEMRSettings()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="help-text">
        <strong>Configure Hospital EMR Integration:</strong>
        Enter your hospital's EMR system API endpoint to enable automatic patient data retrieval.
        <br><br>
        <strong>How it works:</strong>
        <br>â€¢ Enter an EMR number in the patient form
        <br>â€¢ Click "Fetch from EMR" button
        <br>â€¢ Patient demographics will be automatically populated
        <br>â€¢ Saves time and reduces data entry errors
      </div>
      
      <div class="form-group">
        <label>EMR System API Endpoint URL *</label>
        <input type="text" id="emrApiUrl" placeholder="https://your-hospital-emr.com/api/patients" 
          style="font-family: 'Courier New', monospace;">
        <div style="font-size: 0.75rem; color: var(--muted); margin-top: 0.3rem;">
          Example: https://emr.hospital.com/api/v1/patients/{emr}
        </div>
      </div>

      <div class="form-group">
        <label>API Authentication Method</label>
        <select id="emrAuthMethod" onchange="toggleAuthFields()">
          <option value="none">No Authentication</option>
          <option value="bearer">Bearer Token</option>
          <option value="apikey">API Key</option>
          <option value="basic">Basic Auth</option>
        </select>
      </div>

      <div class="form-group" id="bearerTokenGroup" style="display: none;">
        <label>Bearer Token</label>
        <input type="password" id="emrBearerToken" placeholder="Enter your API bearer token">
      </div>

      <div class="form-group" id="apiKeyGroup" style="display: none;">
        <label>API Key</label>
        <input type="password" id="emrApiKey" placeholder="Enter your API key">
        <label style="margin-top: 0.5rem;">API Key Header Name</label>
        <input type="text" id="emrApiKeyHeader" placeholder="e.g., X-API-Key" value="X-API-Key">
      </div>

      <div class="form-group" id="basicAuthGroup" style="display: none;">
        <label>Username</label>
        <input type="text" id="emrUsername" placeholder="API username">
        <label style="margin-top: 0.5rem;">Password</label>
        <input type="password" id="emrPassword" placeholder="API password">
      </div>

      <div class="form-group">
        <label>Response Data Mapping (JSON Path)</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.85rem;">
          <div>
            <label style="font-size: 0.75rem; color: var(--muted);">Patient Name Path:</label>
            <input type="text" id="emrNamePath" placeholder="data.name" value="name">
          </div>
          <div>
            <label style="font-size: 0.75rem; color: var(--muted);">EMR Number Path:</label>
            <input type="text" id="emrNumberPath" placeholder="data.emr" value="emr">
          </div>
          <div>
            <label style="font-size: 0.75rem; color: var(--muted);">Date of Birth Path:</label>
            <input type="text" id="emrDobPath" placeholder="data.dob" value="dob">
          </div>
          <div>
            <label style="font-size: 0.75rem; color: var(--muted);">Gender Path:</label>
            <input type="text" id="emrGenderPath" placeholder="data.gender" value="gender">
          </div>
          <div>
            <label style="font-size: 0.75rem; color: var(--muted);">Diagnosis Path:</label>
            <input type="text" id="emrDiagnosisPath" placeholder="data.diagnosis" value="diagnosis">
          </div>
          <div>
            <label style="font-size: 0.75rem; color: var(--muted);">Allergies Path:</label>
            <input type="text" id="emrAllergiesPath" placeholder="data.allergies" value="allergies">
          </div>
        </div>
        <div style="font-size: 0.75rem; color: var(--muted); margin-top: 0.5rem;">
          Use dot notation to access nested fields (e.g., "patient.demographics.name")
        </div>
      </div>

      <div class="form-group">
        <button class="btn btn-secondary" onclick="testEMRConnection()">ğŸ” Test Connection</button>
        <div id="emrTestResult" style="margin-top: 0.5rem; font-size: 0.85rem;"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeEMRSettings()">Cancel</button>
      <button class="btn btn-primary" onclick="saveEMRSettings()">Save Settings</button>
    </div>
  </div>
</div>

<!-- Medication Plan Page (Full Page Overlay) -->
<div id="medicationPlanPage" class="modal-overlay hidden" style="z-index: 2000;">
  <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--navy); display: flex; flex-direction: column;">
    <!-- Header -->
    <div style="background: var(--deep); border-bottom: 1px solid var(--border); padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;">
      <div>
        <h2 style="font-size: 1.5rem; color: var(--text); margin-bottom: 0.3rem;">ğŸ“ Prescribed Medications Plan</h2>
        <p style="font-size: 0.85rem; color: var(--muted);">Patient: <span id="medPlanPatientName" style="color: var(--teal); font-weight: 600;"></span></p>
      </div>
      <div style="display: flex; gap: 0.8rem; align-items: center;">
        <button class="btn btn-primary" onclick="saveMedicationPlanAndClose()">ğŸ’¾ Save & Close</button>
        <button class="btn btn-danger btn-small" onclick="closeMedicationPlanPage()">âœ• Close</button>
      </div>
    </div>

    <!-- Content -->
    <div style="flex: 1; overflow-y: auto; padding: 2rem;">
      <div style="max-width: 1400px; margin: 0 auto;">
        
        <!-- Action Buttons -->
        <div style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
          <div style="font-size: 0.9rem; font-weight: 600; color: var(--muted); margin-bottom: 1rem; letter-spacing: 0.05em; text-transform: uppercase;">
            Quick Actions
          </div>
          <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <button class="btn btn-secondary" onclick="addPrescribedMedRowInPlan()">
              + Add Single Medication
            </button>
            <button class="btn btn-secondary" onclick="showBulkImportDialog()">
              ğŸ“‹ Paste Multiple Medications
            </button>
            <button class="btn btn-primary" onclick="copyAllToAdminLogFromPlan()" 
              style="background: linear-gradient(135deg, #06b6d4, #0ea5e9);">
              ğŸ“‹ Copy All to Administration Log
            </button>
          </div>
        </div>

        <!-- Medications Table -->
        <div style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
          <div style="font-size: 0.9rem; font-weight: 600; color: var(--muted); margin-bottom: 1rem; letter-spacing: 0.05em; text-transform: uppercase;">
            Medication List
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Drug Name</th>
                  <th>Dosage</th>
                  <th>Route</th>
                  <th>Frequency</th>
                  <th>Start Date</th>
                  <th>End Date</th>
                  <th>Special Instructions</th>
                  <th style="width: 100px;"></th>
                </tr>
              </thead>
              <tbody id="medPlanTableBody"></tbody>
            </table>
          </div>
          <div id="medPlanEmpty" style="text-align: center; padding: 3rem; color: var(--muted);">
            <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ’Š</div>
            <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">No medications added yet</div>
            <div style="font-size: 0.85rem;">Use the buttons above to add medications to this plan</div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Medication Administration Log Page -->
<div id="medAdminPage" class="modal-overlay hidden" style="z-index: 2000;">
  <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--navy); display: flex; flex-direction: column;">
    <div style="background: var(--deep); border-bottom: 1px solid var(--border); padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;">
      <div>
        <h2 style="font-size: 1.5rem; color: var(--text); margin-bottom: 0.3rem;">ğŸ’Š Medication Administration Log</h2>
        <p style="font-size: 0.85rem; color: var(--muted);">Patient: <span id="medAdminPatientName" style="color: var(--teal); font-weight: 600;"></span></p>
      </div>
      <div style="display: flex; gap: 0.8rem; align-items: center;">
        <button class="btn btn-primary" onclick="saveMedAdminAndClose()">ğŸ’¾ Save & Close</button>
        <button class="btn btn-danger btn-small" onclick="closeMedAdminPage()">âœ• Close</button>
      </div>
    </div>
    <div style="flex: 1; overflow-y: auto; padding: 2rem;">
      <div style="max-width: 1600px; margin: 0 auto;">
        <div style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
          <div style="font-size: 0.9rem; font-weight: 600; color: var(--muted); margin-bottom: 1rem; letter-spacing: 0.05em; text-transform: uppercase;">
            Quick Actions
          </div>
          <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <button class="btn btn-secondary" onclick="addMedicationRowInPage()">
              + Add Single Entry
            </button>
          </div>
        </div>
        <div style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
          <div style="font-size: 0.9rem; font-weight: 600; color: var(--muted); margin-bottom: 1rem; letter-spacing: 0.05em; text-transform: uppercase;">
            Administration Records
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Select Drug</th>
                  <th>Drug Name</th>
                  <th>Dosage</th>
                  <th>Route</th>
                  <th>Status</th>
                  <th>Nurse</th>
                  <th>Notes</th>
                  <th style="width: 80px;"></th>
                </tr>
              </thead>
              <tbody id="medAdminPageTableBody"></tbody>
            </table>
          </div>
          <div id="medAdminPageEmpty" style="text-align: center; padding: 3rem; color: var(--muted);">
            <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ’Š</div>
            <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">No administration records yet</div>
            <div style="font-size: 0.85rem;">Use the button above to add medication administration entries</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Glucose Monitoring Page -->
<div id="glucosePage" class="modal-overlay hidden" style="z-index: 2000;">
  <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--navy); display: flex; flex-direction: column;">
    <div style="background: var(--deep); border-bottom: 1px solid var(--border); padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;">
      <div>
        <h2 style="font-size: 1.5rem; color: var(--text); margin-bottom: 0.3rem;">ğŸ©¸ Blood Glucose Monitoring (6-Point)</h2>
        <p style="font-size: 0.85rem; color: var(--muted);">Patient: <span id="glucosePatientName" style="color: var(--teal); font-weight: 600;"></span></p>
      </div>
      <div style="display: flex; gap: 0.8rem; align-items: center;">
        <button class="btn btn-primary" onclick="saveGlucoseAndClose()">ğŸ’¾ Save & Close</button>
        <button class="btn btn-danger btn-small" onclick="closeGlucosePage()">âœ• Close</button>
      </div>
    </div>
    <div style="flex: 1; overflow-y: auto; padding: 2rem;">
      <div style="max-width: 1600px; margin: 0 auto;">
        <div style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
          <div style="font-size: 0.9rem; font-weight: 600; color: var(--muted); margin-bottom: 1rem; letter-spacing: 0.05em; text-transform: uppercase;">
            Quick Actions
          </div>
          <p style="font-size: 0.82rem; color: var(--muted); margin-bottom: 1rem;">
            ğŸ’¡ Normal ranges: Fasting 4.0-7.8 mmol/L â€¢ Post-meal &lt;10 mmol/L
          </p>
          <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <button class="btn btn-secondary" onclick="addGlycemicRowInPage()">
              + Add Glucose Reading
            </button>
          </div>
        </div>
        <div style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
          <div style="font-size: 0.9rem; font-weight: 600; color: var(--muted); margin-bottom: 1rem; letter-spacing: 0.05em; text-transform: uppercase;">
            Glucose Readings
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Fasting</th>
                  <th>Post-BF</th>
                  <th>Pre-Lunch</th>
                  <th>Post-Lunch</th>
                  <th>Pre-Dinner</th>
                  <th>Bedtime</th>
                  <th>Nurse</th>
                  <th style="width: 80px;"></th>
                </tr>
              </thead>
              <tbody id="glucosePageTableBody"></tbody>
            </table>
          </div>
          <div id="glucosePageEmpty" style="text-align: center; padding: 3rem; color: var(--muted);">
            <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ©¸</div>
            <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">No glucose readings yet</div>
            <div style="font-size: 0.85rem;">Use the button above to add glucose readings</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Fluid Chart Page -->
<div id="fluidChartPage" class="modal-overlay hidden" style="z-index: 2000;">
  <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--navy); display: flex; flex-direction: column;">
    <div style="background: var(--deep); border-bottom: 1px solid var(--border); padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;">
      <div>
        <h2 style="font-size: 1.5rem; color: var(--text); margin-bottom: 0.3rem;">ğŸ’§ Fluid Intake & Output Chart</h2>
        <p style="font-size: 0.85rem; color: var(--muted);">Patient: <span id="fluidPatientName" style="color: var(--teal); font-weight: 600;"></span></p>
      </div>
      <div style="display: flex; gap: 0.8rem; align-items: center;">
        <button class="btn btn-primary" onclick="saveFluidChartAndClose()">ğŸ’¾ Save & Close</button>
        <button class="btn btn-danger btn-small" onclick="closeFluidChartPage()">âœ• Close</button>
      </div>
    </div>
    <div style="flex: 1; overflow-y: auto; padding: 2rem;">
      <div style="max-width: 1600px; margin: 0 auto;">
        <!-- Balance Summary -->
        <div style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
          <div style="font-size: 0.9rem; font-weight: 600; color: var(--muted); margin-bottom: 1rem; letter-spacing: 0.05em; text-transform: uppercase;">
            24-Hour Balance
          </div>
          <div class="vitals-grid">
            <div class="vital-card">
              <div class="vital-label">Total Intake (24h)</div>
              <div class="vital-value" id="totalIntakePage">0<span class="vital-unit">mL</span></div>
            </div>
            <div class="vital-card">
              <div class="vital-label">Total Output (24h)</div>
              <div class="vital-value" id="totalOutputPage">0<span class="vital-unit">mL</span></div>
            </div>
            <div class="vital-card" id="fluidBalanceCardPage">
              <div class="vital-label">Net Balance (24h)</div>
              <div class="vital-value" id="fluidBalancePage">0<span class="vital-unit">mL</span></div>
            </div>
          </div>
        </div>
        <div style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
          <div style="font-size: 0.9rem; font-weight: 600; color: var(--muted); margin-bottom: 1rem; letter-spacing: 0.05em; text-transform: uppercase;">
            Quick Actions
          </div>
          <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <button class="btn btn-secondary" onclick="addFluidRowInPage()">
              + Add Fluid Entry
            </button>
          </div>
        </div>
        <div style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
          <div style="font-size: 0.9rem; font-weight: 600; color: var(--muted); margin-bottom: 1rem; letter-spacing: 0.05em; text-transform: uppercase;">
            Fluid Records
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Type</th>
                  <th>Intake Oral</th>
                  <th>Intake IV</th>
                  <th>Output Urine</th>
                  <th>Output Other</th>
                  <th>Notes</th>
                  <th>Nurse</th>
                  <th style="width: 80px;"></th>
                </tr>
              </thead>
              <tbody id="fluidPageTableBody"></tbody>
            </table>
          </div>
          <div id="fluidPageEmpty" style="text-align: center; padding: 3rem; color: var(--muted);">
            <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ’§</div>
            <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">No fluid entries yet</div>
            <div style="font-size: 0.85rem;">Use the button above to add fluid intake/output entries</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Vitals Monitoring Page -->
<div id="vitalsMonitoringPage" class="modal-overlay hidden" style="z-index: 2000;">
  <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--navy); display: flex; flex-direction: column;">
    <div style="background: var(--deep); border-bottom: 1px solid var(--border); padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;">
      <div>
        <h2 style="font-size: 1.5rem; color: var(--text); margin-bottom: 0.3rem;">ğŸ“Š Vitals Monitoring Log</h2>
        <p style="font-size: 0.85rem; color: var(--muted);">Patient: <span id="vitalsPagePatientName" style="color: var(--teal); font-weight: 600;"></span></p>
      </div>
      <div style="display: flex; gap: 0.8rem; align-items: center;">
        <button class="btn btn-primary" onclick="saveVitalsPageAndClose()">ğŸ’¾ Save & Close</button>
        <button class="btn btn-danger btn-small" onclick="closeVitalsMonitoringPage()">âœ• Close</button>
      </div>
    </div>
    <div style="flex: 1; overflow-y: auto; padding: 2rem;">
      <div style="max-width: 1600px; margin: 0 auto;">
        <!-- Latest Vitals Summary -->
        <div style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
          <div style="font-size: 0.9rem; font-weight: 600; color: var(--muted); margin-bottom: 1rem; letter-spacing: 0.05em; text-transform: uppercase;">
            Latest Readings
          </div>
          <div class="vitals-grid" style="margin-bottom: 0;">
            <div class="vital-card" id="vitalsPageBP">
              <div class="vital-label">Blood Pressure</div>
              <div class="vital-value" id="vitalsPageBPVal">â€”<span class="vital-unit">mmHg</span></div>
            </div>
            <div class="vital-card" id="vitalsPageHR">
              <div class="vital-label">Heart Rate</div>
              <div class="vital-value" id="vitalsPageHRVal">â€”<span class="vital-unit">bpm</span></div>
            </div>
            <div class="vital-card" id="vitalsPageTemp">
              <div class="vital-label">Temperature</div>
              <div class="vital-value" id="vitalsPageTempVal">â€”<span class="vital-unit">Â°C</span></div>
            </div>
            <div class="vital-card" id="vitalsPageRR">
              <div class="vital-label">Resp. Rate</div>
              <div class="vital-value" id="vitalsPageRRVal">â€”<span class="vital-unit">/min</span></div>
            </div>
            <div class="vital-card" id="vitalsPageSPO2">
              <div class="vital-label">SpOâ‚‚</div>
              <div class="vital-value" id="vitalsPageSPO2Val">â€”<span class="vital-unit">%</span></div>
            </div>
          </div>
        </div>
        <!-- Quick Actions -->
        <div style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
          <div style="font-size: 0.9rem; font-weight: 600; color: var(--muted); margin-bottom: 1rem; letter-spacing: 0.05em; text-transform: uppercase;">
            Quick Actions
          </div>
          <p style="font-size: 0.82rem; color: var(--muted); margin-bottom: 1rem;">
            ğŸ’¡ Normal ranges: BP 90-140/60-90 mmHg â€¢ HR 60-100 bpm â€¢ Temp 36.1-37.2Â°C â€¢ RR 12-20 /min â€¢ SpOâ‚‚ â‰¥95%
          </p>
          <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <button class="btn btn-secondary" onclick="addVitalsRowInPage()">+ Add Vitals Entry</button>
            <button class="btn btn-secondary" onclick="showPasteVitalsDialog()">ğŸ“‹ Paste Vitals</button>
          </div>
        </div>
        <!-- Vitals Table -->
        <div style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
          <div style="font-size: 0.9rem; font-weight: 600; color: var(--muted); margin-bottom: 1rem; letter-spacing: 0.05em; text-transform: uppercase;">
            Vitals Records
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Time</th>
                  <th>BP (mmHg)</th>
                  <th>HR (bpm)</th>
                  <th>Temp (Â°C)</th>
                  <th>RR (/min)</th>
                  <th>SpOâ‚‚ (%)</th>
                  <th>Recorded By</th>
                  <th style="width: 80px;"></th>
                </tr>
              </thead>
              <tbody id="vitalsPageTableBody"></tbody>
            </table>
          </div>
          <div id="vitalsPageEmpty" style="text-align: center; padding: 3rem; color: var(--muted);">
            <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“Š</div>
            <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">No vitals recorded yet</div>
            <div style="font-size: 0.85rem;">Use the button above to add vitals entries</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Care Management Modals -->
<!-- Vital Signs Modal -->
<div id="vitalSignsModal" class="modal-overlay hidden">
  <div class="modal care-modal-content">
    <div class="modal-header">
      <h3>ğŸ’“ Add Vital Signs</h3>
      <button class="modal-close" onclick="closeVitalSignsModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="careVitalDate">
        </div>
        <div class="form-group">
          <label>Time</label>
          <input type="time" id="careVitalTime">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Blood Pressure (mmHg)</label>
          <input type="text" id="careVitalBP" placeholder="120/80">
        </div>
        <div class="form-group">
          <label>Heart Rate (bpm)</label>
          <input type="number" id="careVitalHR" placeholder="72">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Temperature (Â°C)</label>
          <input type="number" step="0.1" id="careVitalTemp" placeholder="36.5">
        </div>
        <div class="form-group">
          <label>Respiratory Rate (/min)</label>
          <input type="number" id="careVitalRR" placeholder="16">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>SpOâ‚‚ (%)</label>
          <input type="number" id="careVitalSPO2" placeholder="98">
        </div>
      </div>
      <div class="form-row full-width">
        <div class="form-group">
          <label>Notes (Optional)</label>
          <textarea id="careVitalNotes" placeholder="Any observations or concerns..." rows="3"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeVitalSignsModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveCareVitalSigns()">ğŸ’¾ Save Vital Signs</button>
    </div>
  </div>
</div>

<!-- Medication Modal -->
<div id="medicationModal" class="modal-overlay hidden">
  <div class="modal care-modal-content">
    <div class="modal-header">
      <h3>ğŸ’Š Add Medication Administration</h3>
      <button class="modal-close" onclick="closeMedicationModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="careMedDate">
        </div>
        <div class="form-group">
          <label>Time</label>
          <input type="time" id="careMedTime">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Drug Name</label>
          <input type="text" id="careMedDrug" placeholder="Medication name">
        </div>
        <div class="form-group">
          <label>Dosage</label>
          <input type="text" id="careMedDosage" placeholder="e.g., 500mg">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Route</label>
          <select id="careMedRoute">
            <option value="PO">PO (Oral)</option>
            <option value="IV">IV (Intravenous)</option>
            <option value="IM">IM (Intramuscular)</option>
            <option value="SC">SC (Subcutaneous)</option>
            <option value="Topical">Topical</option>
            <option value="Inhalation">Inhalation</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Status</label>
          <select id="careMedStatus">
            <option value="Given">Given</option>
            <option value="Missed">Missed</option>
            <option value="Refused">Refused</option>
            <option value="Held">Held</option>
          </select>
        </div>
      </div>
      <div class="form-row full-width">
        <div class="form-group">
          <label>Notes (Optional)</label>
          <textarea id="careMedNotes" placeholder="Any additional information..." rows="3"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeMedicationModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveCareMedication()">ğŸ’¾ Save Medication</button>
    </div>
  </div>
</div>

<!-- Glycemic Chart Modal -->
<div id="glycemicModal" class="modal-overlay hidden">
  <div class="modal care-modal-content">
    <div class="modal-header">
      <h3>ğŸ©¸ Add Blood Glucose Reading</h3>
      <button class="modal-close" onclick="closeGlycemicModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="careGlycemicDate">
        </div>
      </div>
      <p style="font-size: 0.85rem; color: var(--muted); margin: 1rem 0 0.5rem 0;">
        ğŸ’¡ Enter readings in mmol/L (leave blank if not taken)
      </p>
      <div class="form-row">
        <div class="form-group">
          <label>Fasting</label>
          <input type="number" step="0.1" id="careGlycemicFasting" placeholder="4.0-7.8">
        </div>
        <div class="form-group">
          <label>Post-Breakfast</label>
          <input type="number" step="0.1" id="careGlycemicPostBF" placeholder="<10.0">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Pre-Lunch</label>
          <input type="number" step="0.1" id="careGlycemicPreLunch" placeholder="4.0-7.8">
        </div>
        <div class="form-group">
          <label>Post-Lunch</label>
          <input type="number" step="0.1" id="careGlycemicPostLunch" placeholder="<10.0">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Pre-Dinner</label>
          <input type="number" step="0.1" id="careGlycemicPreDinner" placeholder="4.0-7.8">
        </div>
        <div class="form-group">
          <label>Bedtime</label>
          <input type="number" step="0.1" id="careGlycemicBedtime" placeholder="4.0-7.8">
        </div>
      </div>
      <div class="form-row full-width">
        <div class="form-group">
          <label>Notes (Optional)</label>
          <textarea id="careGlycemicNotes" placeholder="Any observations..." rows="2"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeGlycemicModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveCareGlycemic()">ğŸ’¾ Save Glucose Reading</button>
    </div>
  </div>
</div>

<!-- Urine Chart Modal -->
<div id="urineChartModal" class="modal-overlay hidden">
  <div class="modal care-modal-content">
    <div class="modal-header">
      <h3>ğŸ’§ Add Fluid Intake & Output</h3>
      <button class="modal-close" onclick="closeUrineChartModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="careUrineDate">
        </div>
        <div class="form-group">
          <label>Time</label>
          <input type="time" id="careUrineTime">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Intake - Oral (mL)</label>
          <input type="number" id="careUrineIntakeOral" placeholder="0">
        </div>
        <div class="form-group">
          <label>Intake - IV (mL)</label>
          <input type="number" id="careUrineIntakeIV" placeholder="0">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Output - Urine (mL)</label>
          <input type="number" id="careUrineOutputUrine" placeholder="0">
        </div>
        <div class="form-group">
          <label>Output - Other (mL)</label>
          <input type="number" id="careUrineOutputOther" placeholder="0">
        </div>
      </div>
      <div class="form-row full-width">
        <div class="form-group">
          <label>Notes (Optional)</label>
          <textarea id="careUrineNotes" placeholder="Type of fluid, color, consistency..." rows="3"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeUrineChartModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveCareUrine()">ğŸ’¾ Save Fluid Entry</button>
    </div>
  </div>
</div>

<!-- Daily Care Report Modal -->
<div id="dailyCareModal" class="modal-overlay hidden">
  <div class="modal care-modal-content" style="max-width: 700px;">
    <div class="modal-header">
      <h3>ğŸ“‹ Daily Care Report</h3>
      <button class="modal-close" onclick="closeDailyCareModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="careDailyDate">
        </div>
        <div class="form-group">
          <label>Shift</label>
          <select id="careDailyShift">
            <option value="Morning">Morning (7AM-3PM)</option>
            <option value="Afternoon">Afternoon (3PM-11PM)</option>
            <option value="Night">Night (11PM-7AM)</option>
          </select>
        </div>
      </div>
      <div class="form-row full-width">
        <div class="form-group">
          <label>General Condition</label>
          <textarea id="careDailyCondition" placeholder="Patient's overall condition and status..." rows="3"></textarea>
        </div>
      </div>
      <div class="form-row full-width">
        <div class="form-group">
          <label>Activities of Daily Living (ADL)</label>
          <textarea id="careDailyADL" placeholder="Bathing, feeding, mobility, toileting..." rows="3"></textarea>
        </div>
      </div>
      <div class="form-row full-width">
        <div class="form-group">
          <label>Diet & Nutrition</label>
          <textarea id="careDailyDiet" placeholder="Meals taken, appetite, special diet..." rows="2"></textarea>
        </div>
      </div>
      <div class="form-row full-width">
        <div class="form-group">
          <label>Wounds & Skin Care</label>
          <textarea id="careDailyWounds" placeholder="Wound dressing changes, skin assessment..." rows="2"></textarea>
        </div>
      </div>
      <div class="form-row full-width">
        <div class="form-group">
          <label>Pain Assessment</label>
          <textarea id="careDailyPain" placeholder="Pain level, location, management..." rows="2"></textarea>
        </div>
      </div>
      <div class="form-row full-width">
        <div class="form-group">
          <label>Concerns & Follow-up</label>
          <textarea id="careDailyConcerns" placeholder="Any concerns, incidents, or follow-up needed..." rows="3"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeDailyCareModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveCareDailyReport()">ğŸ’¾ Save Daily Care Report</button>
    </div>
  </div>
</div>

<script>

  // â”€â”€ IN-MEMORY STORAGE SHIM (replaces localStorage) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // All data lives in memory for this session; persists across navigations
  // within the same page load but resets on full page refresh.
  // Use localStorage for persistence across page reloads
  const _memStore = {
    getItem(key) { 
      try {
        return localStorage.getItem(key);
      } catch (e) {
        console.error('localStorage getItem error:', e);
        return null;
      }
    },
    setItem(key, value) { 
      try {
        localStorage.setItem(key, String(value));
      } catch (e) {
        console.error('localStorage setItem error:', e);
      }
    },
    removeItem(key) { 
      try {
        localStorage.removeItem(key);
      } catch (e) {
        console.error('localStorage removeItem error:', e);
      }
    },
    clear() { 
      try {
        localStorage.clear();
      } catch (e) {
        console.error('localStorage clear error:', e);
      }
    },
    key(i) { 
      try {
        return localStorage.key(i);
      } catch (e) {
        console.error('localStorage key error:', e);
        return null;
      }
    },
    get length() { 
      try {
        return localStorage.length;
      } catch (e) {
        console.error('localStorage length error:', e);
        return 0;
      }
    }
  };
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€ GLOBAL STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let patients = {};
let activeId = null;
let currentPatientId = null; // For care management
let users = {};
let currentUser = null;
let statusFilter = 'active'; // Filter patients by status: 'active', 'all', 'discharged'

// â”€â”€â”€ AUTHENTICATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadUsers() {
  try {
    if (!window._db) {
      const stored = _memStore.getItem('medrecord_users');
      if (stored) users = JSON.parse(stored);
      return;
    }
    const snap = await window._db.collection('app_data').doc('users').get();
    if (snap.exists) {
      users = snap.data().users || {};
      _memStore.setItem('medrecord_users', JSON.stringify(users));
    } else {
      const stored = _memStore.getItem('medrecord_users');
      if (stored) users = JSON.parse(stored);
    }
  } catch(e) {
    console.error('loadUsers error:', e);
    const stored = _memStore.getItem('medrecord_users');
    if (stored) users = JSON.parse(stored);
  }
}

async function saveUsers() {
  _memStore.setItem('medrecord_users', JSON.stringify(users));
  try {
    if (!window._db) return;
    await window._db.collection('app_data').doc('users').set({ users });
  } catch(e) {
    console.error('saveUsers error:', e);
  }
}

async function checkAuth() {
  await loadUsers();
  const session = _memStore.getItem('medrecord_session');
  if (session && users[session]) {
    currentUser = users[session];
    showApp();
    return;
  }
  showAuth();
}

function showAuth() {
  document.getElementById('authView').classList.remove('hidden');
  document.getElementById('appView').classList.add('hidden');
  displayCurrentOverallNurse();
  populateOverallNurseLoginDropdown();
  displayLoginHistory();
}

// â”€â”€â”€ OVERALL NURSE OF THE DAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function displayCurrentOverallNurse() {
  const stored = _memStore.getItem('medrecord_overall_nurse');
  const statusEl = document.getElementById('overallNurseStatus');
  const dateEl = document.getElementById('overallNurseDate');
  
  if (stored) {
    const assignment = JSON.parse(stored);
    statusEl.textContent = 'Overall Nurse is on duty';
    statusEl.style.color = 'var(--teal)';
    dateEl.textContent = `Active since ${assignment.dateDisplay}`;
  } else {
    statusEl.textContent = 'No overall nurse on duty';
    statusEl.style.color = 'var(--muted)';
    dateEl.textContent = '';
  }
}

function toggleOverallNurseStatus() {
  const stored = _memStore.getItem('medrecord_overall_nurse');
  
  if (stored) {
    const assignment = JSON.parse(stored);
    
    // Check if current user is the overall nurse
    if (assignment.username === currentUser.name) {
      // User is ending their shift
      if (confirm('End your Overall Nurse shift?')) {
        _memStore.removeItem('medrecord_overall_nurse');
        updateOverallNurseButton();
        updateViewAllReportsButton();
        showToast('âœ“ Overall Nurse shift ended');
      }
    } else {
      // Someone else is overall nurse
      if (confirm(`Another nurse is currently on Overall Nurse duty.\n\nDo you want to take over the Overall Nurse role?`)) {
        assignSelfAsOverallNurse();
      }
    }
  } else {
    // No overall nurse assigned
    if (confirm('Designate yourself as Overall Nurse of the Day?\n\nYou will coordinate nursing operations across all wards.')) {
      assignSelfAsOverallNurse();
    }
  }
}

function assignSelfAsOverallNurse() {
  const assignment = {
    username: currentUser.name,
    role: currentUser.role,
    ward: currentUser.ward || null,
    date: new Date().toISOString(),
    dateDisplay: new Date().toLocaleDateString('en-US', { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    })
  };
  
  _memStore.setItem('medrecord_overall_nurse', JSON.stringify(assignment));
  updateOverallNurseButton();
  updateViewAllReportsButton();
  showToast('âœ“ You are now the Overall Nurse of the Day');
}

function updateOverallNurseButton() {
  const btn = document.getElementById('overallNurseToggle');
  if (!btn) return;
  
  const stored = _memStore.getItem('medrecord_overall_nurse');
  
  if (stored) {
    const assignment = JSON.parse(stored);
    if (assignment.username === currentUser.name) {
      // Current user is the overall nurse
      btn.textContent = 'ğŸ‘‘ End Overall Nurse Shift';
      btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
    } else {
      // Someone else is overall nurse
      btn.textContent = 'ğŸ‘‘ Take Over Overall Nurse';
      btn.style.background = '';
    }
  } else {
    // No overall nurse
    btn.textContent = 'ğŸ‘‘ Become Overall Nurse';
    btn.style.background = '';
  }
}

function updateViewAllReportsButton() {
  const btn = document.getElementById('viewAllReportsBtn');
  if (!btn) return;
  
  // Check if current user is the Overall Nurse of the Day
  const stored = _memStore.getItem('medrecord_overall_nurse');
  
  if (stored && currentUser) {
    const assignment = JSON.parse(stored);
    if (assignment.username === currentUser.name) {
      // Current user is the overall nurse - show button
      btn.style.display = 'inline-block';
    } else {
      // Someone else is overall nurse - hide button
      btn.style.display = 'none';
    }
  } else {
    // No overall nurse assigned - hide button
    btn.style.display = 'none';
  }
}

function populateOverallNurseLoginDropdown() {
  const select = document.getElementById('overallNurseLoginSelect');
  if (!select) return;
  
  select.innerHTML = '<option value="">-- Select your name --</option>';
  
  // Get all nurses (both ward nurses and overall nurses)
  Object.entries(users).forEach(([username, user]) => {
    if (user.role === 'nurse' || user.role === 'overall_nurse') {
      const wardInfo = user.ward ? ` - ${user.ward}` : ' (Supervisor)';
      const optionValue = JSON.stringify({
        username: user.name,
        fullUsername: username,
        role: user.role,
        ward: user.ward
      });
      select.innerHTML += `<option value='${optionValue.replace(/'/g, "&apos;")}'>${user.name}${wardInfo}</option>`;
    }
  });
}

function assignOverallNurseFromLogin() {
  const select = document.getElementById('overallNurseLoginSelect');
  const value = select.value;
  
  if (!value) return;
  
  try {
    const nurseData = JSON.parse(value);
    
    const stored = _memStore.getItem('medrecord_overall_nurse');
    if (stored) {
      const current = JSON.parse(stored);
      if (current.username === nurseData.username) {
        alert('You are already assigned as Overall Nurse of the Day.');
        return;
      }
      
      if (!confirm(`Another nurse (${current.username}) is currently on duty.\n\nReplace with ${nurseData.username} as Overall Nurse?`)) {
        select.value = '';
        return;
      }
    }
    
    const assignment = {
      username: nurseData.username,
      role: nurseData.role,
      ward: nurseData.ward || null,
      date: new Date().toISOString(),
      dateDisplay: new Date().toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      })
    };
    
    _memStore.setItem('medrecord_overall_nurse', JSON.stringify(assignment));
    displayCurrentOverallNurse();
    alert(`âœ“ ${nurseData.username} is now the Overall Nurse of the Day`);
    select.value = '';
    
  } catch (e) {
    console.error('Error assigning overall nurse:', e);
    alert('Error assigning overall nurse. Please try again.');
    select.value = '';
  }
}

function endOverallNurseFromLogin() {
  const stored = _memStore.getItem('medrecord_overall_nurse');
  
  if (!stored) {
    alert('No overall nurse is currently on duty.');
    return;
  }
  
  const assignment = JSON.parse(stored);
  
  if (confirm(`End the current Overall Nurse shift for ${assignment.username}?`)) {
    _memStore.removeItem('medrecord_overall_nurse');
    displayCurrentOverallNurse();
    
    // Reset dropdown
    const select = document.getElementById('overallNurseLoginSelect');
    if (select) select.value = '';
    
    alert('âœ“ Overall Nurse shift ended');
  }
}

// â”€â”€â”€ LOGIN HISTORY CLIPBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function trackLogin(username, password) {
  // Get existing login history
  let loginHistory = JSON.parse(_memStore.getItem('medrecord_login_history') || '[]');
  
  const user = users[username];
  
  // Check if this user already exists in history
  const existingIndex = loginHistory.findIndex(entry => entry.username === username);
  
  const loginEntry = {
    username: username,
    password: password,
    name: user.name,
    role: user.role,
    ward: user.ward || null,
    lastLogin: new Date().toISOString(),
    loginCount: existingIndex >= 0 ? loginHistory[existingIndex].loginCount + 1 : 1
  };
  
  if (existingIndex >= 0) {
    // Update existing entry
    loginHistory[existingIndex] = loginEntry;
  } else {
    // Add new entry
    loginHistory.push(loginEntry);
  }
  
  // Keep only the last 50 entries
  if (loginHistory.length > 50) {
    loginHistory = loginHistory.slice(-50);
  }
  
  _memStore.setItem('medrecord_login_history', JSON.stringify(loginHistory));
  displayLoginHistory();
}

function displayLoginHistory() {
  // This function is called on auth view load but doesn't show anything
  // The dropdown will only appear when the button is clicked
}

function toggleLoginHistory() {
  const dropdown = document.getElementById('loginHistoryDropdown');
  
  if (dropdown.classList.contains('hidden')) {
    // Show dropdown
    renderLoginHistoryDropdown();
    dropdown.classList.remove('hidden');
  } else {
    // Hide dropdown
    dropdown.classList.add('hidden');
  }
}

function renderLoginHistoryDropdown() {
  const dropdown = document.getElementById('loginHistoryDropdown');
  const loginHistory = JSON.parse(_memStore.getItem('medrecord_login_history') || '[]');
  
  if (loginHistory.length === 0) {
    dropdown.innerHTML = '<div class="login-history-empty">No saved logins yet</div>';
    return;
  }
  
  // Sort by last login (most recent first)
  loginHistory.sort((a, b) => new Date(b.lastLogin) - new Date(a.lastLogin));
  
  dropdown.innerHTML = loginHistory.map(entry => {
    const roleDisplay = entry.role === 'nurse' ? 'Ward Nurse' :
                        entry.role === 'overall_nurse' ? 'Overall Nurse' :
                        entry.role === 'ward_master' ? 'Ward Master' : entry.role;
    
    const wardInfo = entry.ward ? ` â€¢ ${entry.ward}` : '';
    
    return `
      <div class="login-history-item" onclick="fillLoginFromHistory('${escHtml(entry.username)}', '${escHtml(entry.password)}')">
        <div class="login-history-item-header">
          <div class="login-history-item-name">${escHtml(entry.name)}</div>
          <div class="login-history-item-role">${roleDisplay}</div>
        </div>
        <div class="login-history-item-credentials">
          <div><strong>User:</strong> <span>${escHtml(entry.username)}</span></div>
          <div><strong>Pass:</strong> <span>${escHtml(entry.password)}</span></div>
        </div>
        ${wardInfo ? `<div style="font-size: 0.75rem; color: var(--muted); margin-top: 0.3rem;">${wardInfo}</div>` : ''}
      </div>
    `;
  }).join('');
}

function fillLoginFromHistory(username, password) {
  document.getElementById('loginUsername').value = username;
  document.getElementById('loginPassword').value = password;
  
  // Hide dropdown after selection
  document.getElementById('loginHistoryDropdown').classList.add('hidden');
  
  showToast('âœ“ Credentials filled - click Login');
}

// Remove old functions that are no longer needed
function quickFillLogin(username, password) {
  fillLoginFromHistory(username, password);
}

function showApp() {
  const role = currentUser.role || 'nurse';
  
  // Overall nurses see reports view by default
  if (role === 'overall_nurse') {
    showOverallReportsView();
    return;
  }
  
  // Regular interface for Ward Masters and ward nurses
  document.getElementById('authView').classList.add('hidden');
  document.getElementById('appView').classList.remove('hidden');
  document.getElementById('overallReportsView').classList.add('hidden');
  
  const roleDisplay = role === 'ward_master' ? 'Ward Master' :
                       role === 'overall_nurse' ? 'Overall Nurse' :
                       role === 'nurse' ? 'Ward Nurse' : role;
  
  document.getElementById('roleDisplay').textContent = `ğŸ‘¤ ${currentUser.name} (${roleDisplay})`;
  
  // Check if current user is the Overall Nurse of the Day
  const stored = _memStore.getItem('medrecord_overall_nurse');
  let isOverallNurseOfDay = false;
  
  if (stored && (role === 'nurse' || role === 'overall_nurse')) {
    const assignment = JSON.parse(stored);
    isOverallNurseOfDay = assignment.username === currentUser.name;
  }
  
  // Show buttons based on role and overall nurse status
  const viewAllReportsBtn = document.getElementById('viewAllReportsBtn');
  const overallNurseToggle = document.getElementById('overallNurseToggle');
  
  if (role === 'nurse' || role === 'overall_nurse') {
    if (isOverallNurseOfDay) {
      viewAllReportsBtn.style.display = 'inline-block';
    } else {
      viewAllReportsBtn.style.display = 'none';
    }
    overallNurseToggle.style.display = 'inline-block';
    updateOverallNurseButton();
  } else {
    viewAllReportsBtn.style.display = 'none';
    overallNurseToggle.style.display = 'none';
  }
  
  if (role === 'nurse') {
    document.getElementById('wardDisplay').textContent = `ğŸ“ ${currentUser.ward}`;
    document.getElementById('sidebarTitle').textContent = 'My Ward Patients';
  } else if (role === 'ward_master') {
    document.getElementById('wardDisplay').textContent = `ğŸ¥ Ward Master â€” ${currentUser.ward}`;
    document.getElementById('sidebarTitle').textContent = `${currentUser.ward} Patients`;
  }
  
  loadData();
  renderPatientList();
}

function showOverallReportsView() {
  document.getElementById('authView').classList.add('hidden');
  document.getElementById('appView').classList.add('hidden');
  document.getElementById('overallReportsView').classList.remove('hidden');
  
  const role = currentUser.role || 'nurse';
  const roleDisplayText = role === 'overall_nurse' ? 'Overall Nurse' :
                          role === 'ward_master' ? `Ward Master - ${currentUser.ward}` :
                          role === 'nurse' ? `Nurse - ${currentUser.ward}` :
                          'Staff Member';
  
  document.getElementById('overallRoleDisplay').textContent = `ğŸ‘¤ ${currentUser.name} (${roleDisplayText})`;
  
  loadData();
  loadNotepad();
  renderOverallReports();
}

function switchToPatientView() {
  document.getElementById('overallReportsView').classList.add('hidden');
  document.getElementById('appView').classList.remove('hidden');
  
  // Restore the patient view based on user's actual role
  showApp();
}

function showLogin() {
  document.getElementById('loginForm').classList.remove('hidden');
  document.getElementById('registerForm').classList.add('hidden');
}

function showRegister() {
  document.getElementById('loginForm').classList.add('hidden');
  document.getElementById('registerForm').classList.remove('hidden');
}

function handleRoleChange() {
  const role = document.getElementById('regRole').value;
  const wardGroup = document.getElementById('regWardGroup');
  const wardLabel = document.getElementById('regWardLabel');
  const wardNote  = document.getElementById('regWardNote');

  if (role === 'nurse' || role === 'ward_master') {
    wardGroup.style.display = 'block';
    if (wardLabel) wardLabel.textContent = role === 'ward_master'
      ? 'Ward Assignment (Ward Masters are limited to one per ward)'
      : 'Ward Assignment';
    if (wardNote) wardNote.style.display = role === 'ward_master' ? 'block' : 'none';
    // Grey out wards that already have a Ward Master
    updateWardMasterAvailability();
  } else {
    wardGroup.style.display = 'none';
  }
}

function updateWardMasterAvailability() {
  const role = document.getElementById('regRole').value;
  if (role !== 'ward_master') return;

  const wardSelect = document.getElementById('regWard');
  const takenWards = new Set();

  Object.values(users).forEach(u => {
    if (u.role === 'ward_master' && u.ward) takenWards.add(u.ward);
  });

  Array.from(wardSelect.options).forEach(opt => {
    if (!opt.value) return;
    if (takenWards.has(opt.value)) {
      opt.disabled = true;
      opt.text = opt.value.replace(/^Ward \w+/, m => m) + ' â€” Ward Master assigned';
    } else {
      opt.disabled = false;
      // Reset to original text
      opt.text = {
        'Ward A': 'Ward A - General Medicine',
        'Ward B': 'Ward B - Surgical',
        'Ward C': 'Ward C - Pediatrics',
        'Ward D': 'Ward D - Cardiology',
        'Ward E': 'Ward E - Orthopedics',
        'Ward F': 'Ward F - ICU',
        'Ward G': 'Ward G - Maternity',
        'Ward H': 'Ward H - Oncology',
      }[opt.value] || opt.value;
    }
  });
}

async function register() {
  const name     = document.getElementById('regName').value.trim();
  const username = document.getElementById('regUsername').value.trim();
  const password = document.getElementById('regPassword').value;
  const role     = document.getElementById('regRole').value;
  const ward     = document.getElementById('regWard').value;

  if (!name || !username || !password || !role) {
    alert('Please fill in all required fields (Name, Username, Password, Role)');
    return;
  }

  if ((role === 'nurse' || role === 'ward_master') && !ward) {
    alert(`Please select a ward for ${role === 'ward_master' ? 'Ward Master' : 'Ward Nurse'} assignment`);
    return;
  }

  // Load latest users from Firestore first
  await loadUsers();

  if (role === 'ward_master') {
    const existingWM = Object.values(users).find(u => u.role === 'ward_master' && u.ward === ward);
    if (existingWM) {
      alert(`âš ï¸ A Ward Master already exists for ${ward}.\n\nOnly one Ward Master is allowed per ward.\nExisting Ward Master: ${existingWM.name}`);
      return;
    }
  }

  if (users[username]) {
    alert('Username already exists. Please choose a different username.');
    return;
  }

  users[username] = {
    name,
    password,
    role,
    ward: (role === 'nurse' || role === 'ward_master') ? ward : null
  };

  await saveUsers();

  const roleLabel = role === 'ward_master' ? 'Ward Master' :
                    role === 'overall_nurse' ? 'Overall Nurse' : 'Ward Nurse';
  showToast(`âœ“ Account created for ${name} (${roleLabel}). Please login.`);
  showLogin();
}

async function login() {
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value;

  if (!username || !password) {
    alert('Please enter username and password');
    return;
  }

  // Always reload users from Firestore before login check
  await loadUsers();

  if (!users[username] || users[username].password !== password) {
    alert('Invalid username or password');
    return;
  }

  currentUser = users[username];
  _memStore.setItem('medrecord_session', username);

  const loginHistory = JSON.parse(_memStore.getItem('medrecord_login_history') || '[]');
  const existingUser = loginHistory.find(entry => entry.username === username);
  if (!existingUser) {
    const saveLogin = confirm(`Welcome ${currentUser.name}!\n\nWould you like to save your login details for quick access next time?`);
    if (saveLogin) trackLogin(username, password);
  } else {
    trackLogin(username, password);
  }

  showApp();
}

function logout() {
  if (confirm('Are you sure you want to logout?')) {
    _memStore.removeItem('medrecord_session');
    currentUser = null;
    activeId = null;
    showAuth();
  }
}

// â”€â”€â”€ DATA PERSISTENCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _firestoreUnsubscribe = null;

async function loadData() {
  _memStore.setItem('medrecord_patients', JSON.stringify(patients));
  try {
    if (!window._db) {
      const stored = _memStore.getItem('medrecord_patients');
      if (stored) patients = JSON.parse(stored);
      return;
    }
    // Real-time listener â€” updates all devices instantly
    if (_firestoreUnsubscribe) _firestoreUnsubscribe();
    _firestoreUnsubscribe = window._db.collection('app_data').doc('patients')
      .onSnapshot((snap) => {
        if (snap.exists) {
          patients = snap.data().patients || {};
          _memStore.setItem('medrecord_patients', JSON.stringify(patients));
          renderPatientList();
          if (activeId && patients[activeId]) loadPatientRecord();
        }
      }, (err) => {
        console.error('Firestore listener error:', err);
      });
  } catch(e) {
    console.error('loadData error:', e);
    const stored = _memStore.getItem('medrecord_patients');
    if (stored) patients = JSON.parse(stored);
  }
}

async function saveData() {
  _memStore.setItem('medrecord_patients', JSON.stringify(patients));
  try {
    if (!window._db) return;
    await window._db.collection('app_data').doc('patients').set({ patients });
  } catch(e) {
    console.error('saveData error:', e);
    showToast('âš  Saved locally â€” check internet connection');
  }
}

// â”€â”€â”€ PATIENT LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPatientList() {
  const list = document.getElementById('patientList');
  list.innerHTML = '';

  const isWardMaster = currentUser.role === 'ward_master';
  
  // Filter patients based on role
  const wardPatients = Object.entries(patients).filter(([id, p]) => {
    if (isWardMaster) {
      // Ward Masters see all patients assigned to their ward
      const matchesWard = p.ward === currentUser.ward;
      const patientStatus = p.status || 'active';
      if (statusFilter === 'all') {
        return matchesWard;
      } else if (statusFilter === 'active') {
        return matchesWard && patientStatus === 'active';
      } else if (statusFilter === 'discharged') {
        return matchesWard && (patientStatus === 'discharged' || patientStatus === 'transferred');
      }
      return false;
    } else {
      // Nurses see only their ward patients
      const matchesWard = p.ward === currentUser.ward;
      const patientStatus = p.status || 'active';
      
      if (statusFilter === 'all') {
        return matchesWard;
      } else if (statusFilter === 'active') {
        return matchesWard && patientStatus === 'active';
      } else if (statusFilter === 'discharged') {
        return matchesWard && (patientStatus === 'discharged' || patientStatus === 'transferred');
      }
      return false;
    }
  });

  if (wardPatients.length === 0) {
    const emptyMsg = statusFilter === 'active' ? (isWardMaster ? 'No active patients in your ward.' : 'No active patients in your ward.') :
                     statusFilter === 'discharged' ? 'No discharged or transferred patients.' :
                     (isWardMaster ? 'No patients in your ward yet.' : 'No patients in your ward yet.');
    list.innerHTML = `<div style="padding: 2rem; text-align: center; color: var(--muted); font-size: 0.85rem;">${emptyMsg}<br>${statusFilter === 'active' ? 'Add a new patient to begin.' : ''}</div>`;
    return;
  }

  wardPatients.forEach(([id, p]) => {
    const div = document.createElement('div');
    div.className = 'patient-item';
    if (id === activeId) div.classList.add('active');
    
    const patientStatus = p.status || 'active';
    let statusBadgeHtml = '';
    
    if (patientStatus === 'active') {
      statusBadgeHtml = '<span class="status-badge status-active">ACTIVE</span>';
    } else if (patientStatus === 'discharged') {
      statusBadgeHtml = '<span class="status-badge status-discharged">DISCHARGED</span>';
    } else if (patientStatus === 'transferred') {
      statusBadgeHtml = '<span class="status-badge status-transferred">TRANSFERRED OUT</span>';
    }
    
    div.innerHTML = `
      <div class="patient-name">${escHtml(p.name || 'Unnamed Patient')}</div>
      <div class="patient-meta">
        <span class="emr-badge">${escHtml(p.emr || 'NO EMR')}</span>
        <span class="ward-badge">${escHtml(p.ward || 'No Ward')}</span>
        ${statusBadgeHtml}
      </div>
    `;
    
    div.onclick = () => selectPatient(id);
    list.appendChild(div);
  });
}

function filterByStatus(status) {
  statusFilter = status;
  
  // Update active tab
  document.querySelectorAll('.status-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  event.target.classList.add('active');
  
  renderPatientList();
}

function searchPatients() {
  const query = document.getElementById('searchPatient').value.toLowerCase();
  const items = document.querySelectorAll('.patient-item');
  
  items.forEach(item => {
    const text = item.textContent.toLowerCase();
    item.style.display = text.includes(query) ? 'block' : 'none';
  });
}

function selectPatient(id) {
  activeId = id;
  currentPatientId = id; // Set for care management
  renderPatientList();
  loadPatientRecord();
  displayCareHistory(); // Display care history when patient selected
  initializeWardStatistics(); // Load ward statistics
  
  document.getElementById('emptyState').classList.add('hidden');
  document.getElementById('recordView').classList.remove('hidden');
}

function addNewPatient() {
  const id = 'p_' + Date.now();
  const isWardMaster = currentUser.role === 'ward_master';
  
  patients[id] = {
    name: '',
    emr: '',
    ward: currentUser.ward, // Always scoped to the logged-in user's ward
    status: 'active',
    statusHistory: [],
    dob: '',
    gender: '',
    attending: '',
    admissionDate: '',
    diagnosis: '',
    allergies: '',
    vitals: [],
    prescribedMedications: [],
    medications: [],
    glycemicLog: [],
    fluidLog: [],
    nursingReports: []
  };
  
  saveData();
  selectPatient(id);
}

// â”€â”€â”€ PATIENT RECORD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadPatientRecord() {
  if (!activeId) return;
  const p = patients[activeId];
  
  // Initialize status fields if they don't exist
  if (!p.status) p.status = 'active';
  if (!p.statusHistory) p.statusHistory = [];
  
  const isWardMaster = currentUser.role === 'ward_master';
  const isNurse = currentUser.role === 'nurse' || (!currentUser.role && currentUser.role !== 'ward_master'); // Nurses only
  
  // Show/hide read-only message for nurses
  if (isNurse) {
    document.getElementById('patientInfoReadOnly').classList.remove('hidden');
  } else {
    document.getElementById('patientInfoReadOnly').classList.add('hidden');
  }
  // Ward Master info message
  const wardMasterNote = document.getElementById('patientInfoWardMasterNote');
  if (wardMasterNote) wardMasterNote.style.display = isWardMaster ? 'block' : 'none';
  
  // Set patient info fields as read-only for nurses
  const patientInfoFields = ['patientName', 'emrNumber', 'dob', 'gender', 'patientWard', 'attending', 'admissionDate', 'diagnosis', 'allergies'];
  patientInfoFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
      if (isNurse) {
        field.setAttribute('readonly', true);
        field.setAttribute('disabled', true);
        field.style.backgroundColor = 'var(--border)';
        field.style.cursor = 'not-allowed';
        field.style.opacity = '0.7';
      } else {
        field.removeAttribute('readonly');
        field.removeAttribute('disabled');
        field.style.backgroundColor = '';
        field.style.cursor = '';
        field.style.opacity = '';
      }
    }
  });
  
  // Header â€” use new GC header updater
  updateGCHeader(p);

  // Form fields
  document.getElementById('patientName').value = p.name || '';
  document.getElementById('emrNumber').value = p.emr || '';
  document.getElementById('dob').value = p.dob || '';
  document.getElementById('gender').value = p.gender || '';
  document.getElementById('patientWard').value = p.ward || '';
  document.getElementById('attending').value = p.attending || '';
  document.getElementById('admissionDate').value = p.admissionDate || '';
  document.getElementById('diagnosis').value = p.diagnosis || '';
  document.getElementById('allergies').value = p.allergies || '';
  
  // Status fields
  document.getElementById('patientStatus').value = p.status || 'active';
  handleStatusChange(); // Update visibility of status-related fields
  
  // Display status history
  if (p.statusHistory && p.statusHistory.length > 0) {
    document.getElementById('statusHistory').style.display = 'block';
    const historyHtml = p.statusHistory.map(h => {
      const statusText = h.status === 'active' ? 'âœ… Set to Active' :
                         h.status === 'discharged' ? 'ğŸ¥ Discharged' :
                         h.status === 'transferred' ? `ğŸ”„ Transferred to ${h.transferWard}` : h.status;
      return `<div style="margin-bottom: 0.5rem; padding: 0.5rem; background: var(--card); border-radius: 6px; border-left: 3px solid var(--teal);">
        <div style="font-weight: 600;">${statusText}</div>
        <div style="font-size: 0.7rem; color: var(--muted); margin-top: 0.25rem;">
          ${h.date || ''} â€¢ By: ${escHtml(h.recordedBy || 'Unknown')}
          ${h.notes ? `<br>Notes: ${escHtml(h.notes)}` : ''}
        </div>
      </div>`;
    }).reverse().join('');
    document.getElementById('statusHistoryList').innerHTML = historyHtml;
  } else {
    document.getElementById('statusHistory').style.display = 'none';
  }
  
  // Render tables
  renderPrescribedMedTable();
  renderVitalsTable();
  renderMedicationTable();
  renderGlycemicTable();
  renderFluidTable();
  renderNursingReportTable();
  updateLatestVitals();
}

function handleStatusChange() {
  const status = document.getElementById('patientStatus').value;
  const transferWardGroup = document.getElementById('transferWardGroup');
  const statusDateGroup = document.getElementById('statusDateGroup');
  const statusNotesGroup = document.getElementById('statusNotesGroup');
  const statusDateLabel = document.getElementById('statusDateLabel');
  const statusNotesLabel = document.getElementById('statusNotesLabel');
  
  // Reset and hide all conditional fields
  transferWardGroup.style.display = 'none';
  statusDateGroup.style.display = 'none';
  statusNotesGroup.style.display = 'none';
  
  if (status === 'transferred') {
    transferWardGroup.style.display = 'block';
    statusDateGroup.style.display = 'block';
    statusNotesGroup.style.display = 'block';
    statusDateLabel.textContent = 'Transfer Date *';
    statusNotesLabel.textContent = 'Transfer Reason';
    
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('statusDate').value = today;
  } else if (status === 'discharged') {
    statusDateGroup.style.display = 'block';
    statusNotesGroup.style.display = 'block';
    statusDateLabel.textContent = 'Discharge Date *';
    statusNotesLabel.textContent = 'Discharge Summary';
    
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('statusDate').value = today;
  }
}

function saveRecord() {
  if (!activeId) return;
  
  const isWardMaster = currentUser.role === 'ward_master';
  const isNurse = currentUser.role === 'nurse' || !currentUser.role;
  
  const p = patients[activeId];
  const previousStatus = p.status || 'active';
  const previousWard = p.ward;
  
  // Only Ward Masters can edit patient information
  if (isWardMaster) {
    p.name = document.getElementById('patientName').value;
    p.emr = document.getElementById('emrNumber').value;
    p.dob = document.getElementById('dob').value;
    p.gender = document.getElementById('gender').value;
    p.ward = document.getElementById('patientWard').value;
    p.attending = document.getElementById('attending').value;
    p.admissionDate = document.getElementById('admissionDate').value;
    p.diagnosis = document.getElementById('diagnosis').value;
    p.allergies = document.getElementById('allergies').value;
  }
  
  const newStatus = document.getElementById('patientStatus').value;
  
  // Handle status changes
  if (newStatus !== previousStatus) {
    if (newStatus === 'transferred') {
      const transferWard = document.getElementById('transferWard').value;
      const transferDate = document.getElementById('statusDate').value;
      const transferNotes = document.getElementById('statusNotes').value;
      
      if (!transferWard) {
        alert('Please select a destination ward for transfer');
        return;
      }
      
      if (!transferDate) {
        alert('Please enter transfer date');
        return;
      }
      
      if (transferWard === currentUser.ward) {
        alert('Cannot transfer patient to the same ward');
        return;
      }
      
      // Confirm transfer
      if (!confirm(`Transfer ${p.name || 'this patient'} to ${transferWard}?\n\nYou will no longer see this patient in your ward list.`)) {
        document.getElementById('patientStatus').value = previousStatus;
        handleStatusChange();
        return;
      }
      
      // Update patient ward and status
      p.ward = transferWard;
      p.status = 'transferred';
      
      // Add to status history
      if (!p.statusHistory) p.statusHistory = [];
      p.statusHistory.push({
        status: 'transferred',
        fromWard: previousWard,
        transferWard: transferWard,
        date: transferDate,
        notes: transferNotes,
        recordedBy: currentUser.name,
        timestamp: new Date().toISOString()
      });
      
      showToast(`âœ“ Patient transferred to ${transferWard}`);
      
    } else if (newStatus === 'discharged') {
      const dischargeDate = document.getElementById('statusDate').value;
      const dischargeNotes = document.getElementById('statusNotes').value;
      
      if (!dischargeDate) {
        alert('Please enter discharge date');
        return;
      }
      
      // Confirm discharge
      if (!confirm(`Discharge ${p.name || 'this patient'}?\n\nThis will mark the patient as discharged.`)) {
        document.getElementById('patientStatus').value = previousStatus;
        handleStatusChange();
        return;
      }
      
      p.status = 'discharged';
      
      // Add to status history
      if (!p.statusHistory) p.statusHistory = [];
      p.statusHistory.push({
        status: 'discharged',
        date: dischargeDate,
        notes: dischargeNotes,
        recordedBy: currentUser.name,
        timestamp: new Date().toISOString()
      });
      
      showToast('âœ“ Patient discharged');
      
    } else if (newStatus === 'active') {
      // Reactivate patient
      if (previousStatus === 'discharged' || previousStatus === 'transferred') {
        if (!confirm(`Reactivate ${p.name || 'this patient'} in your ward?`)) {
          document.getElementById('patientStatus').value = previousStatus;
          handleStatusChange();
          return;
        }
      }
      
      p.status = 'active';
      p.ward = currentUser.ward; // Ensure ward is set to current user's ward
      
      // Add to status history
      if (!p.statusHistory) p.statusHistory = [];
      p.statusHistory.push({
        status: 'active',
        date: new Date().toISOString().split('T')[0],
        recordedBy: currentUser.name,
        timestamp: new Date().toISOString()
      });
      
      showToast('âœ“ Patient reactivated');
    }
  }
  
  // Validate ward matches nurse's ward for active patients (nurses only)
  if (isNurse && p.status === 'active' && p.ward !== currentUser.ward) {
    if (!confirm(`Warning: You are assigning this patient to ${p.ward}, but you work in ${currentUser.ward}. You will lose access to this patient. Continue?`)) {
      document.getElementById('patientWard').value = currentUser.ward;
      p.ward = currentUser.ward;
    }
  }
  
  saveData();
  renderPatientList();
  loadPatientRecord();
  updateGCHeader(patients[activeId]); // refresh GC header
  autoPopulateWardStatPatientDetails(); // refresh ward stat patient details panel

  // If patient was transferred or discharged, switch to appropriate view
  if (p.status === 'transferred' || p.status === 'discharged') {
    setTimeout(() => {
      filterByStatus('discharged');
    }, 500);
  }
}

// â”€â”€â”€ VITALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderVitalsTable() {
  if (!activeId) return;
  const p = patients[activeId];
  if (!p.vitals) p.vitals = [];
  const tbody = document.getElementById('vitalsTableBody');
  const emptyState = document.getElementById('vitalsEmpty');
  tbody.innerHTML = '';

  const rows = p.vitals || [];

  if (rows.length === 0) {
    if (emptyState) emptyState.style.display = 'block';
    return;
  }

  if (emptyState) emptyState.style.display = 'none';

  rows.forEach((row) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="padding: 0.75rem;">${row.date || 'â€”'}</td>
      <td style="padding: 0.75rem;">${row.time || 'â€”'}</td>
      <td style="padding: 0.75rem;">${escHtml(row.bp || 'â€”')}</td>
      <td style="padding: 0.75rem;">${row.hr || 'â€”'}</td>
      <td style="padding: 0.75rem;">${row.temp || 'â€”'}</td>
      <td style="padding: 0.75rem;">${row.rr || 'â€”'}</td>
      <td style="padding: 0.75rem;">${row.spo2 || 'â€”'}</td>
      <td style="padding: 0.75rem;">${escHtml(row.recorder || 'â€”')}</td>
    `;
    tbody.appendChild(tr);
  });
}

function addVitalsRow() {
  if (!activeId) return;
  if (!patients[activeId].vitals) patients[activeId].vitals = [];
  const i = patients[activeId].vitals.length;
  patients[activeId].vitals.push({});
  addVitalsRowDOM({}, i);
}

function addVitalsRowDOM(data, index) {
  const tbody = document.getElementById('vitalsTableBody');
  const tr = document.createElement('tr');
  tr.dataset.vindex = index;
  
  tr.innerHTML = `
    <td><input type="date" value="${data.date || ''}" style="min-width:110px"
        onchange="updateVitals(${index},'date',this.value)"></td>
    <td><input type="time" value="${data.time || ''}" style="min-width:80px"
        onchange="updateVitals(${index},'time',this.value)"></td>
    <td id="vtd_${index}_bp"><input type="text" value="${data.bp || ''}" placeholder="120/80"
        style="min-width:70px" oninput="updateVitals(${index},'bp',this.value)"></td>
    <td id="vtd_${index}_hr"><input type="number" value="${data.hr || ''}" placeholder="70"
        style="min-width:60px" oninput="updateVitals(${index},'hr',this.value)"></td>
    <td id="vtd_${index}_temp"><input type="number" step="0.1" value="${data.temp || ''}" placeholder="36.5"
        style="min-width:60px" oninput="updateVitals(${index},'temp',this.value)"></td>
    <td id="vtd_${index}_rr"><input type="number" value="${data.rr || ''}" placeholder="16"
        style="min-width:60px" oninput="updateVitals(${index},'rr',this.value)"></td>
    <td id="vtd_${index}_spo2"><input type="number" value="${data.spo2 || ''}" placeholder="98"
        style="min-width:60px" oninput="updateVitals(${index},'spo2',this.value)"></td>
    <td><input type="text" value="${escHtml(data.recorder || '')}" placeholder="Nurse name"
        style="min-width:80px" onchange="updateVitals(${index},'recorder',this.value)"></td>
    <td><button class="row-del" onclick="deleteVitalsRow(${index})" title="Remove">âœ•</button></td>
  `;
  tbody.appendChild(tr);
  
  // Apply color coding
  highlightVitalCell(index, 'hr', data.hr);
  highlightVitalCell(index, 'temp', data.temp);
  highlightVitalCell(index, 'rr', data.rr);
  highlightVitalCell(index, 'spo2', data.spo2);
}

function updateVitals(i, field, val) {
  if (!activeId) return;
  if (!patients[activeId].vitals[i]) patients[activeId].vitals[i] = {};
  patients[activeId].vitals[i][field] = val;
  
  if (field !== 'date' && field !== 'time' && field !== 'recorder' && field !== 'bp') {
    highlightVitalCell(i, field, val);
  }
  
  updateLatestVitals();
}

function highlightVitalCell(index, field, value) {
  const cell = document.getElementById(`vtd_${index}_${field}`);
  if (!cell) return;
  
  const num = parseFloat(value);
  if (isNaN(num)) {
    cell.className = '';
    return;
  }
  
  let abnormal = false;
  
  // Normal ranges
  if (field === 'hr' && (num < 60 || num > 100)) abnormal = true;
  if (field === 'temp' && (num < 36.1 || num > 37.2)) abnormal = true;
  if (field === 'rr' && (num < 12 || num > 20)) abnormal = true;
  if (field === 'spo2' && num < 95) abnormal = true;
  
  if (abnormal) {
    if ((field === 'hr' && num < 60) || (field === 'temp' && num < 36.1) || 
        (field === 'rr' && num < 12) || (field === 'spo2' && num < 95)) {
      cell.className = 'abnormal-low';
    } else {
      cell.className = 'abnormal-high';
    }
  } else {
    cell.className = '';
  }
}

function deleteVitalsRow(i) {
  if (!activeId) return;
  patients[activeId].vitals.splice(i, 1);
  renderVitalsTable();
  updateLatestVitals();
}

function updateLatestVitals() {
  if (!activeId) return;
  const vitals = patients[activeId].vitals || [];
  if (vitals.length === 0) return;
  
  const latest = vitals[vitals.length - 1];
  
  // BP
  const bpCard = document.getElementById('vitalBP');
  if (latest.bp) {
    bpCard.querySelector('.vital-value').innerHTML = `${latest.bp}<span class="vital-unit">mmHg</span>`;
    bpCard.className = 'vital-card alert-ok';
  }
  
  // HR
  const hrCard = document.getElementById('vitalHR');
  if (latest.hr) {
    hrCard.querySelector('.vital-value').innerHTML = `${latest.hr}<span class="vital-unit">bpm</span>`;
    const hr = parseFloat(latest.hr);
    if (hr < 60 || hr > 100) hrCard.className = 'vital-card alert-high';
    else hrCard.className = 'vital-card alert-ok';
  }
  
  // Temp
  const tempCard = document.getElementById('vitalTemp');
  if (latest.temp) {
    tempCard.querySelector('.vital-value').innerHTML = `${latest.temp}<span class="vital-unit">Â°C</span>`;
    const temp = parseFloat(latest.temp);
    if (temp < 36.1 || temp > 37.2) tempCard.className = 'vital-card alert-high';
    else tempCard.className = 'vital-card alert-ok';
  }
  
  // RR
  const rrCard = document.getElementById('vitalRR');
  if (latest.rr) {
    rrCard.querySelector('.vital-value').innerHTML = `${latest.rr}<span class="vital-unit">/min</span>`;
    const rr = parseFloat(latest.rr);
    if (rr < 12 || rr > 20) rrCard.className = 'vital-card alert-high';
    else rrCard.className = 'vital-card alert-ok';
  }
  
  // SpO2
  const spo2Card = document.getElementById('vitalSPO2');
  if (latest.spo2) {
    spo2Card.querySelector('.vital-value').innerHTML = `${latest.spo2}<span class="vital-unit">%</span>`;
    const spo2 = parseFloat(latest.spo2);
    if (spo2 < 95) spo2Card.className = 'vital-card alert-low';
    else spo2Card.className = 'vital-card alert-ok';
  }
}

// â”€â”€â”€ PASTE VITALS FUNCTIONALITY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let parsedVitalsData = [];

function showPasteVitalsDialog() {
  document.getElementById('pasteVitalsModal').classList.remove('hidden');
  document.getElementById('pasteVitalsInput').value = '';
  document.getElementById('pasteVitalsPreview').style.display = 'none';
  document.getElementById('parseVitalsBtn').style.display = 'inline-block';
  document.getElementById('importVitalsBtn').style.display = 'none';
  parsedVitalsData = [];
}

function closePasteVitalsDialog() {
  document.getElementById('pasteVitalsModal').classList.add('hidden');
}

function parseAndPreviewVitals() {
  const input = document.getElementById('pasteVitalsInput').value.trim();
  
  if (!input) {
    alert('Please paste vitals data first.');
    return;
  }
  
  parsedVitalsData = parseVitalsData(input);
  
  if (parsedVitalsData.length === 0) {
    alert('Could not parse any vitals data. Please check the format and try again.');
    return;
  }
  
  // Show preview
  displayVitalsPreview(parsedVitalsData);
  document.getElementById('parseVitalsBtn').style.display = 'none';
  document.getElementById('importVitalsBtn').style.display = 'inline-block';
}

function parseVitalsData(input) {
  const lines = input.split('\n').filter(line => line.trim());
  const results = [];
  
  for (let line of lines) {
    // Skip header lines (contain words like "date", "time", "bp", etc.)
    if (/^(date|time|bp|hr|temp|rr|spo2|blood|heart|temperature|respiratory|oxygen)/i.test(line.trim())) {
      continue;
    }
    
    // Try different delimiters
    let parts;
    if (line.includes('\t')) {
      parts = line.split('\t');
    } else if (line.includes('|')) {
      parts = line.split('|');
    } else if (line.includes(',')) {
      parts = line.split(',');
    } else {
      parts = line.split(/\s+/);
    }
    
    parts = parts.map(p => p.trim()).filter(p => p);
    
    if (parts.length < 3) continue; // Need at least date/time and some vitals
    
    const vital = {
      date: '',
      time: '',
      bp: '',
      hr: '',
      temp: '',
      rr: '',
      spo2: '',
      recordedBy: currentUser ? currentUser.name : ''
    };
    
    // Parse each part and assign to appropriate field
    for (let part of parts) {
      // Date detection (various formats)
      if (/^\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4}$/.test(part)) {
        vital.date = convertToStandardDate(part);
      }
      // Date YYYY-MM-DD
      else if (/^\d{4}[\/\-\.]\d{1,2}[\/\-\.]\d{1,2}$/.test(part)) {
        vital.date = part.replace(/[\/\.]/g, '-');
      }
      // Time detection
      else if (/^\d{1,2}:\d{2}(\s*(AM|PM|am|pm))?$/.test(part)) {
        vital.time = part.replace(/\s*(AM|PM|am|pm)/, '').trim();
        // Convert 12-hour to 24-hour if needed
        if (/PM|pm/.test(part) && !part.startsWith('12:')) {
          const [h, m] = vital.time.split(':');
          vital.time = `${parseInt(h) + 12}:${m}`;
        }
      }
      // Blood pressure (120/80, 120-80, 120 80)
      else if (/^\d{2,3}[\/\-\s]\d{2,3}$/.test(part)) {
        vital.bp = part.replace(/[\-\s]/g, '/');
      }
      // Temperature (with decimal, may have Â°C or Â°F)
      else if (/^\d{2,3}\.\d/.test(part)) {
        vital.temp = part.replace(/[Â°CFcf]/g, '').trim();
      }
      // Numbers with units or %
      else if (/^\d+\s*(bpm|\/min|%)?$/.test(part)) {
        const num = parseInt(part);
        // Heart rate (60-150)
        if (num >= 40 && num <= 200 && !vital.hr) {
          vital.hr = num.toString();
        }
        // SpO2 (90-100%)
        else if (num >= 70 && num <= 100 && (part.includes('%') || !vital.spo2)) {
          vital.spo2 = num.toString();
        }
        // Respiratory rate (8-30)
        else if (num >= 8 && num <= 40 && !vital.rr) {
          vital.rr = num.toString();
        }
      }
      // Plain numbers - try to guess based on range and what's missing
      else if (/^\d+$/.test(part)) {
        const num = parseInt(part);
        if (num >= 40 && num <= 200 && !vital.hr) {
          vital.hr = num.toString();
        } else if (num >= 8 && num <= 40 && !vital.rr) {
          vital.rr = num.toString();
        } else if (num >= 90 && num <= 100 && !vital.spo2) {
          vital.spo2 = num.toString();
        }
      }
    }
    
    // If we have at least date or time and one vital sign, add it
    if ((vital.date || vital.time) && (vital.bp || vital.hr || vital.temp || vital.rr || vital.spo2)) {
      // Set default date/time if missing
      if (!vital.date) vital.date = new Date().toISOString().split('T')[0];
      if (!vital.time) vital.time = new Date().toTimeString().slice(0, 5);
      
      results.push(vital);
    }
  }
  
  return results;
}

function convertToStandardDate(dateStr) {
  // Convert various date formats to YYYY-MM-DD
  const parts = dateStr.split(/[\/\-\.]/);
  
  if (parts.length !== 3) return dateStr;
  
  let day, month, year;
  
  // Detect format based on number sizes
  if (parts[0].length === 4) {
    // YYYY-MM-DD or YYYY-DD-MM
    year = parts[0];
    month = parts[1].padStart(2, '0');
    day = parts[2].padStart(2, '0');
  } else if (parts[2].length === 4) {
    // DD-MM-YYYY or MM-DD-YYYY
    year = parts[2];
    // Assume MM-DD-YYYY if first part > 12
    if (parseInt(parts[0]) > 12) {
      day = parts[0].padStart(2, '0');
      month = parts[1].padStart(2, '0');
    } else {
      month = parts[0].padStart(2, '0');
      day = parts[1].padStart(2, '0');
    }
  } else {
    // Assume DD-MM-YY or MM-DD-YY
    year = '20' + parts[2];
    if (parseInt(parts[0]) > 12) {
      day = parts[0].padStart(2, '0');
      month = parts[1].padStart(2, '0');
    } else {
      month = parts[0].padStart(2, '0');
      day = parts[1].padStart(2, '0');
    }
  }
  
  return `${year}-${month}-${day}`;
}

function displayVitalsPreview(data) {
  document.getElementById('pasteVitalsPreview').style.display = 'block';
  document.getElementById('previewCount').textContent = data.length;
  
  const container = document.getElementById('pasteVitalsPreviewTable');
  let html = '<table style="width: 100%; font-size: 0.75rem; color: var(--text);">';
  html += '<thead><tr style="border-bottom: 1px solid var(--border);">';
  html += '<th style="padding: 0.3rem; text-align: left;">Date</th>';
  html += '<th style="padding: 0.3rem; text-align: left;">Time</th>';
  html += '<th style="padding: 0.3rem; text-align: left;">BP</th>';
  html += '<th style="padding: 0.3rem; text-align: left;">HR</th>';
  html += '<th style="padding: 0.3rem; text-align: left;">Temp</th>';
  html += '<th style="padding: 0.3rem; text-align: left;">RR</th>';
  html += '<th style="padding: 0.3rem; text-align: left;">SpOâ‚‚</th>';
  html += '</tr></thead><tbody>';
  
  data.forEach(v => {
    html += '<tr style="border-bottom: 1px solid var(--border);">';
    html += `<td style="padding: 0.3rem;">${v.date}</td>`;
    html += `<td style="padding: 0.3rem;">${v.time}</td>`;
    html += `<td style="padding: 0.3rem;">${v.bp || '-'}</td>`;
    html += `<td style="padding: 0.3rem;">${v.hr || '-'}</td>`;
    html += `<td style="padding: 0.3rem;">${v.temp || '-'}</td>`;
    html += `<td style="padding: 0.3rem;">${v.rr || '-'}</td>`;
    html += `<td style="padding: 0.3rem;">${v.spo2 || '-'}</td>`;
    html += '</tr>';
  });
  
  html += '</tbody></table>';
  container.innerHTML = html;
}

function importParsedVitals() {
  if (!activeId) {
    alert('Please select a patient first.');
    return;
  }
  
  if (parsedVitalsData.length === 0) {
    alert('No vitals data to import.');
    return;
  }
  
  // Add all parsed vitals to patient record
  if (!patients[activeId].vitals) patients[activeId].vitals = [];
  
  parsedVitalsData.forEach(vital => {
    patients[activeId].vitals.push(vital);
  });
  
  // Sort by date and time (newest first)
  patients[activeId].vitals.sort((a, b) => {
    const dateA = new Date(`${a.date} ${a.time}`);
    const dateB = new Date(`${b.date} ${b.time}`);
    return dateB - dateA;
  });
  
  saveData();
  renderVitalsTable();
  updateLatestVitals();
  
  showToast(`âœ“ Imported ${parsedVitalsData.length} vitals entries`);
  closePasteVitalsDialog();
}

// â”€â”€â”€ PRESCRIBED MEDICATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPrescribedMedTable() {
  if (!activeId) return;
  const p = patients[activeId];
  if (!p.prescribedMedications) p.prescribedMedications = [];
  const tbody = document.getElementById('prescribedMedTableBody');
  const emptyState = document.getElementById('prescribedMedEmpty');
  tbody.innerHTML = '';
  
  const rows = p.prescribedMedications || [];
  
  if (rows.length === 0 || !rows.some(r => r.drug)) {
    // Show empty state
    if (emptyState) emptyState.style.display = 'block';
  } else {
    // Hide empty state and show medications
    if (emptyState) emptyState.style.display = 'none';
    rows.forEach((row, i) => {
      if (row.drug) { // Only show rows with actual drug names
        addPrescribedMedRowDOM(row, i);
      }
    });
  }
  
  // Update medication helper message
  if (typeof updateMedicationHelperMessage === 'function') {
    updateMedicationHelperMessage();
  }
}

// Alias for compatibility
function loadPrescribedMedications() {
  renderPrescribedMedTable();
}

function addPrescribedMedRow() {
  if (!activeId) return;
  if (!patients[activeId].prescribedMedications) patients[activeId].prescribedMedications = [];
  const i = patients[activeId].prescribedMedications.length;
  patients[activeId].prescribedMedications.push({});
  addPrescribedMedRowDOM({}, i);
}

function addPrescribedMedRowDOM(data, index) {
  const tbody = document.getElementById('prescribedMedTableBody');
  const emptyState = document.getElementById('prescribedMedEmpty');
  
  // Hide empty state if we have data
  if (data && data.drug) {
    if (emptyState) emptyState.style.display = 'none';
  }
  
  const tr = document.createElement('tr');
  tr.dataset.pmindex = index;
  
  // Check if medication is currently active
  const today = new Date();
  const startDate = data.startDate ? new Date(data.startDate) : null;
  const endDate = data.endDate ? new Date(data.endDate) : null;
  
  let isActive = true;
  if (startDate && today < startDate) isActive = false;
  if (endDate && today > endDate) isActive = false;
  
  if (!isActive) {
    tr.style.opacity = '0.5';
  }
  
  // Read-only display
  tr.innerHTML = `
    <td style="padding: 0.75rem;">${escHtml(data.drug || 'â€”')}</td>
    <td style="padding: 0.75rem;">${escHtml(data.dosage || 'â€”')}</td>
    <td style="padding: 0.75rem;">${data.route || 'â€”'}</td>
    <td style="padding: 0.75rem;">${data.frequency || 'â€”'}</td>
    <td style="padding: 0.75rem;">${data.startDate || 'â€”'}</td>
    <td style="padding: 0.75rem;">${data.endDate || 'â€”'}</td>
    <td style="padding: 0.75rem;">${escHtml(data.instructions || 'â€”')}</td>
  `;
  tbody.appendChild(tr);
}

function copyToAdminLog(prescribedIndex) {
  if (!activeId) return;
  const prescribed = patients[activeId].prescribedMedications[prescribedIndex];
  
  if (!prescribed || !prescribed.drug) {
    alert('Please enter a drug name first');
    return;
  }
  
  // Create new administration entry with current date/time
  const now = new Date();
  const today = now.toISOString().split('T')[0];
  const currentTime = now.toTimeString().slice(0, 5);
  
  if (!patients[activeId].medications) patients[activeId].medications = [];
  
  patients[activeId].medications.push({
    date: today,
    time: currentTime,
    drug: prescribed.drug,
    dosage: prescribed.dosage,
    route: prescribed.route,
    medStatus: '', // Nurse will select status
    nurse: currentUser.name, // Auto-fill current nurse
    remarks: ''
  });
  
  renderMedicationTable();
  showToast(`âœ“ ${prescribed.drug} added to administration log`);
  
  // Scroll to medication admin section
  document.querySelector('#medTableBody').parentElement.parentElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function showBulkImportDialog() {
  document.getElementById('bulkImportModal').classList.remove('hidden');
  document.getElementById('bulkMedInput').value = '';
  document.getElementById('bulkDelimiter').value = '';
}

function closeBulkImportDialog() {
  document.getElementById('bulkImportModal').classList.add('hidden');
}

function processBulkImport() {
  if (!activeId) return;
  
  const input = document.getElementById('bulkMedInput').value.trim();
  if (!input) {
    alert('Please paste medication data');
    return;
  }
  
  let delimiter = document.getElementById('bulkDelimiter').value;
  const lines = input.split('\n').filter(line => line.trim());
  
  if (lines.length === 0) {
    alert('No medication data found');
    return;
  }
  
  let importedCount = 0;
  let errors = [];
  
  lines.forEach((line, index) => {
    line = line.trim();
    if (!line) return;
    
    // Auto-detect delimiter if not specified
    let currentDelimiter = delimiter;
    if (!currentDelimiter) {
      if (line.includes('|')) currentDelimiter = '|';
      else if (line.includes('\t')) currentDelimiter = '\t';
      else if (line.includes(',') && !line.match(/\d+,\d+/)) currentDelimiter = ','; // Avoid splitting decimals
      else if (line.includes(';')) currentDelimiter = ';';
      else currentDelimiter = null; // Parse as single string
    }
    
    let drugName = '';
    let dosage = '';
    let route = '';
    let frequency = '';
    let instructions = '';
    
    if (currentDelimiter) {
      // Split by delimiter
      const parts = line.split(currentDelimiter).map(p => p.trim());
      
      drugName = parts[0] || '';
      
      // Try to extract from structured fields first
      for (let i = 1; i < parts.length; i++) {
        const part = parts[i];
        
        // Check if it's a dosage
        if (!dosage && part.match(/\d+\.?\d*\s*(mg|mcg|g|ml|units?|iu|mmol)/i)) {
          dosage = part;
        }
        // Check if it's a frequency
        else if (!frequency && part.match(/\b(OD|BD|TDS|TID|QDS|QID|BID|PRN|STAT|NOCTE|MANE|once|twice|three|four|daily|morning|evening|night|hourly|weekly|4hrly|6hrly|8hrly)\b/i)) {
          frequency = part;
        }
        // Check if it's a route
        else if (!route && part.match(/\b(PO|IV|IM|SC|PR|SL|TOP|INH|topical|oral|injection|inhalation)\b/i)) {
          route = part;
        }
        // Otherwise, it's instructions
        else if (part && part.length > 0) {
          instructions = instructions ? instructions + ' ' + part : part;
        }
      }
    } else {
      // Parse single string - extract everything from one line
      drugName = line;
    }
    
    // Smart extraction from drug name if fields not found
    const fullText = drugName + ' ' + instructions;
    
    // Extract dosage if not found
    if (!dosage) {
      const dosageMatch = fullText.match(/\b(\d+\.?\d*\s*(?:mg|mcg|g|ml|units?|iu|mmol))\b/i);
      if (dosageMatch) {
        dosage = dosageMatch[1];
        // Remove from drug name and instructions
        drugName = drugName.replace(dosageMatch[0], '').trim();
        instructions = instructions.replace(dosageMatch[0], '').trim();
      }
    }
    
    // Extract frequency if not found
    if (!frequency) {
      const freqPatterns = [
        /\b(once\s+daily|OD)\b/i,
        /\b(twice\s+daily|BD|BID)\b/i,
        /\b(three\s+times?\s+(?:a\s+)?daily?|TDS|TID)\b/i,
        /\b(four\s+times?\s+(?:a\s+)?daily?|QDS|QID)\b/i,
        /\b(PRN|as\s+needed|when\s+required)\b/i,
        /\b(STAT|immediately)\b/i,
        /\b(every\s+\d+\s+hours?|q\d+h)\b/i,
        /\b(morning|evening|night|bedtime)\b/i,
        /\b(weekly|monthly)\b/i,
        /\b(hourly)\b/i
      ];
      
      for (const pattern of freqPatterns) {
        const match = fullText.match(pattern);
        if (match) {
          frequency = match[1];
          // Standardize common abbreviations
          if (frequency.match(/once\s+daily/i)) frequency = 'OD';
          if (frequency.match(/twice\s+daily/i)) frequency = 'BD';
          if (frequency.match(/three\s+times/i)) frequency = 'TDS';
          if (frequency.match(/four\s+times/i)) frequency = 'QDS';
          if (frequency.match(/every\s+4\s*h/i)) frequency = '4hrly';
          if (frequency.match(/every\s+6\s*h/i)) frequency = '6hrly';
          if (frequency.match(/every\s+8\s*h/i)) frequency = '8hrly';
          if (frequency.match(/nocte|bedtime|night/i)) frequency = 'Nocte';
          if (frequency.match(/morning|mane/i)) frequency = 'Mane';
          
          // Remove from drug name and instructions
          drugName = drugName.replace(match[0], '').trim();
          instructions = instructions.replace(match[0], '').trim();
          break;
        }
      }
    }
    
    // Extract route if not found - smart detection
    if (!route) {
      const routePatterns = [
        { pattern: /\b(tabs?|tablets?|capsules?|cap)\b/i, route: 'PO' },
        { pattern: /\b(PO|oral|by\s+mouth)\b/i, route: 'PO' },
        { pattern: /\b(IV|intravenous|infusion)\b/i, route: 'IV' },
        { pattern: /\b(IM|intramuscular|injection)\b/i, route: 'IM' },
        { pattern: /\b(SC|subcutaneous|subcut)\b/i, route: 'SC' },
        { pattern: /\b(cream|ointment|gel|topical|TOP|apply)\b/i, route: 'Topical' },
        { pattern: /\b(inhaler?|nebulizer?|INH|inhalation)\b/i, route: 'Inhalation' },
        { pattern: /\b(PR|rectal|suppository)\b/i, route: 'PR' },
        { pattern: /\b(SL|sublingual|under\s+tongue)\b/i, route: 'SL' }
      ];
      
      for (const { pattern, route: detectedRoute } of routePatterns) {
        const match = fullText.match(pattern);
        if (match) {
          route = detectedRoute;
          // Remove from drug name and instructions
          drugName = drugName.replace(match[0], '').trim();
          instructions = instructions.replace(match[0], '').trim();
          break;
        }
      }
    }
    
    // Clean up drug name - remove extra spaces and dashes
    drugName = drugName.replace(/\s+/g, ' ').replace(/^[-\s]+|[-\s]+$/g, '').trim();
    
    // Clean up instructions - remove leading/trailing dashes and spaces
    instructions = instructions.replace(/^[-\s]+|[-\s]+$/g, '').trim();
    
    if (!drugName) {
      errors.push(`Line ${index + 1}: No drug name found`);
      return;
    }
    
    // Create medication object
    const medication = {
      drug: drugName,
      dosage: dosage,
      route: route,
      frequency: frequency,
      startDate: new Date().toISOString().split('T')[0],
      endDate: '',
      instructions: instructions
    };
    
    // Add to patient's prescribed medications
    if (!patients[activeId].prescribedMedications) {
      patients[activeId].prescribedMedications = [];
    }
    
    patients[activeId].prescribedMedications.push(medication);
    importedCount++;
  });
  
  if (importedCount > 0) {
    renderPrescribedMedTable();
    saveData();
    closeBulkImportDialog();
    
    let message = `âœ“ Imported ${importedCount} medication${importedCount > 1 ? 's' : ''}`;
    if (errors.length > 0) {
      message += `\n\nWarnings:\n${errors.join('\n')}`;
    }
    
    if (errors.length > 0) {
      alert(message);
    } else {
      showToast(message);
    }
  } else {
    alert('No medications could be imported. Please check your format.');
  }
}

function copyAllToAdminLog() {
  if (!activeId) return;
  
  const prescribed = patients[activeId].prescribedMedications || [];
  
  if (prescribed.length === 0) {
    alert('No prescribed medications to copy');
    return;
  }
  
  // Filter only active medications (within date range)
  const today = new Date();
  const activeMeds = prescribed.filter(med => {
    const startDate = med.startDate ? new Date(med.startDate) : null;
    const endDate = med.endDate ? new Date(med.endDate) : null;
    
    let isActive = true;
    if (startDate && today < startDate) isActive = false;
    if (endDate && today > endDate) isActive = false;
    
    return isActive && med.drug;
  });
  
  if (activeMeds.length === 0) {
    alert('No active prescribed medications to copy');
    return;
  }
  
  if (!confirm(`Copy ${activeMeds.length} active medication${activeMeds.length > 1 ? 's' : ''} to administration log?`)) {
    return;
  }
  
  const now = new Date();
  const todayDate = now.toISOString().split('T')[0];
  const currentTime = now.toTimeString().slice(0, 5);
  
  if (!patients[activeId].medications) patients[activeId].medications = [];
  
  activeMeds.forEach(med => {
    patients[activeId].medications.push({
      date: todayDate,
      time: currentTime,
      drug: med.drug,
      dosage: med.dosage,
      route: med.route,
      medStatus: '',
      nurse: currentUser.name,
      remarks: ''
    });
  });
  
  renderMedicationTable();
  showToast(`âœ“ ${activeMeds.length} medication${activeMeds.length > 1 ? 's' : ''} copied to administration log`);
  
  // Scroll to medication admin section
  document.querySelector('#medTableBody').parentElement.parentElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function updatePrescribedMed(i, field, val) {
  if (!activeId) return;
  if (!patients[activeId].prescribedMedications[i]) patients[activeId].prescribedMedications[i] = {};
  patients[activeId].prescribedMedications[i][field] = val;
  
  // Re-render to update active status styling
  if (field === 'startDate' || field === 'endDate') {
    renderPrescribedMedTable();
  }
}

function deletePrescribedMedRow(i) {
  if (!activeId) return;
  patients[activeId].prescribedMedications.splice(i, 1);
  renderPrescribedMedTable();
}

// â”€â”€â”€ MEDICATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMedicationTable() {
  if (!activeId) return;
  const p = patients[activeId];
  if (!p.medications) p.medications = [];
  const tbody = document.getElementById('medTableBody');
  const emptyState = document.getElementById('medAdminEmpty');
  tbody.innerHTML = '';
  
  const rows = p.medications || [];
  
  if (rows.length === 0 || !rows.some(r => r.drug)) {
    if (emptyState) emptyState.style.display = 'block';
  } else {
    if (emptyState) emptyState.style.display = 'none';
    rows.forEach((row, i) => {
      if (row.drug) addMedicationRowDOM(row, i);
    });
  }
}

function addMedicationRowDOM(data, index) {
  const tbody = document.getElementById('medTableBody');
  const tr = document.createElement('tr');
  tr.dataset.mindex = index;
  
  // Determine row class based on status
  let rowClass = '';
  if (data.status === 'Given') {
    rowClass = 'med-status-given';
  } else if (data.status === 'Missed' || data.status === 'Refused' || data.status === 'Held') {
    rowClass = 'med-status-issue';
  }
  
  if (rowClass) {
    tr.className = rowClass;
  }
  
  // Read-only display
  tr.innerHTML = `
    <td style="padding: 0.75rem;">${data.date || 'â€”'}</td>
    <td style="padding: 0.75rem;">${data.time || 'â€”'}</td>
    <td style="padding: 0.75rem;">${escHtml(data.drug || 'â€”')}</td>
    <td style="padding: 0.75rem;">${escHtml(data.dosage || 'â€”')}</td>
    <td style="padding: 0.75rem;">${data.route || 'â€”'}</td>
    <td style="padding: 0.75rem;">${data.status || 'â€”'}</td>
    <td style="padding: 0.75rem;">${escHtml(data.nurse || 'â€”')}</td>
    <td style="padding: 0.75rem;">${escHtml(data.notes || data.remarks || 'â€”')}</td>
  `;
  tbody.appendChild(tr);
}

function updateMedicationDrug(index, selectElement) {
  if (!activeId) return;
  
  const selectedValue = selectElement.value;
  const customInput = document.getElementById(`customDrug_${index}`);
  const dosageInput = document.getElementById(`dosage_${index}`);
  const routeSelect = document.getElementById(`route_${index}`);
  
  if (selectedValue === '__custom__') {
    // Show custom input
    selectElement.style.display = 'none';
    customInput.style.display = 'block';
    customInput.focus();
  } else if (selectedValue) {
    // Get dosage and route from selected option
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const dosage = selectedOption.getAttribute('data-dosage');
    const route = selectedOption.getAttribute('data-route');
    
    // Update medication data
    if (!patients[activeId].medications[index]) patients[activeId].medications[index] = {};
    patients[activeId].medications[index].drug = selectedValue;
    
    // Auto-fill dosage and route if available
    if (dosage && !patients[activeId].medications[index].dosage) {
      patients[activeId].medications[index].dosage = dosage;
      dosageInput.value = dosage;
    }
    if (route && !patients[activeId].medications[index].route) {
      patients[activeId].medications[index].route = route;
      routeSelect.value = route;
    }
  }
}

function updateMedicationStatus(index, status) {
  if (!activeId) return;
  if (!patients[activeId].medications[index]) patients[activeId].medications[index] = {};
  patients[activeId].medications[index].medStatus = status;
  
  // Re-render the table to update row styling
  renderMedicationTable();
}

function updateMedication(i, field, val) {
  if (!activeId) return;
  if (!patients[activeId].medications[i]) patients[activeId].medications[i] = {};
  patients[activeId].medications[i][field] = val;
}

function deleteMedicationRow(i) {
  if (!activeId) return;
  patients[activeId].medications.splice(i, 1);
  renderMedicationTable();
}

// â”€â”€â”€ EXPORT CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportToCSV() {
  if (!activeId) return;
  const p = patients[activeId];
  
  let csv = 'Medication Administration Record\n\n';
  csv += `Patient: ${p.name}\n`;
  csv += `EMR: ${p.emr}\n`;
  csv += `Ward: ${p.ward}\n`;
  csv += `DOB: ${p.dob}\n\n`;
  
  csv += 'Date,Time,Drug,Dosage,Route,Status,Nurse,Additional Notes\n';
  (p.medications || []).forEach(m => {
    csv += `${m.date || ''},${m.time || ''},${m.drug || ''},${m.dosage || ''},${m.route || ''},${m.medStatus || ''},${m.nurse || ''},${m.remarks || ''}\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `MAR_${p.emr || 'patient'}_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  showToast('âœ“ CSV exported');
}

// â”€â”€â”€ PRINT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function printRecord() {
  if (!activeId) return;
  const p = patients[activeId];
  
  const vitalsRows = (p.vitals || []).map(v => 
    `<tr><td>${v.date || ''}</td><td>${v.time || ''}</td><td>${v.bp || ''}</td><td>${v.hr || ''}</td><td>${v.temp || ''}</td><td>${v.rr || ''}</td><td>${v.spo2 || ''}</td><td>${escHtml(v.recorder || '')}</td></tr>`
  ).join('');
  
  const prescribedRows = (p.prescribedMedications || []).map(m => 
    `<tr><td>${escHtml(m.drug || '')}</td><td>${escHtml(m.dosage || '')}</td><td>${m.route || ''}</td><td>${escHtml(m.frequency || '')}</td><td>${m.startDate || ''}</td><td>${m.endDate || ''}</td><td>${escHtml(m.instructions || '')}</td></tr>`
  ).join('');
  
  const rows = (p.medications || []).map(m => 
    `<tr><td>${m.date || ''}</td><td>${m.time || ''}</td><td>${escHtml(m.drug || '')}</td><td>${escHtml(m.dosage || '')}</td><td>${m.route || ''}</td><td>${escHtml(m.medStatus || '')}</td><td>${escHtml(m.nurse || '')}</td><td>${escHtml(m.remarks || '')}</td></tr>`
  ).join('');
  
  const glycemicRows = (p.glycemicLog || []).map(g => 
    `<tr><td>${g.date || ''}</td><td>${g.fasting || ''}</td><td>${g.postBreakfast || ''}</td><td>${g.preLunch || ''}</td><td>${g.postLunch || ''}</td><td>${g.preDinner || ''}</td><td>${g.bedtime || ''}</td><td>${escHtml(g.recorder || '')}</td></tr>`
  ).join('');
  
  const fluidRows = (p.fluidLog || []).map(f => 
    `<tr><td>${f.date || ''}</td><td>${f.time || ''}</td><td>${f.type || ''}</td><td>${f.intakeOral || ''}</td><td>${f.intakeIV || ''}</td><td>${f.outputUrine || ''}</td><td>${f.outputOther || ''}</td><td>${escHtml(f.notes || '')}</td><td>${escHtml(f.recorder || '')}</td></tr>`
  ).join('');
  
  const win = window.open('', '_blank');
  win.document.write(`
  <html><head><title>Medical Record - ${escHtml(p.name)}</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { color: #0f1b2d; border-bottom: 2px solid #2dd4bf; padding-bottom: 10px; }
    h2 { color: #162236; margin-top: 20px; font-size: 1.2rem; }
    .info { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
    .info div { padding: 8px; background: #f0f0f0; border-radius: 4px; }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 0.9rem; }
    th { background: #2dd4bf; color: white; font-weight: bold; }
    @media print { button { display: none; } }
  </style></head><body>
    <h1>Medication Administration Record</h1>
    <div class="info">
      <div><strong>Patient:</strong> ${escHtml(p.name || '')}</div>
      <div><strong>EMR:</strong> ${escHtml(p.emr || '')}</div>
      <div><strong>Ward:</strong> ${escHtml(p.ward || '')}</div>
      <div><strong>DOB:</strong> ${p.dob || ''}</div>
      <div><strong>Gender:</strong> ${p.gender || ''}</div>
      <div><strong>Attending:</strong> ${escHtml(p.attending || '')}</div>
    </div>
    <div><strong>Diagnosis:</strong> ${escHtml(p.diagnosis || '')}</div>
    <div><strong>Allergies:</strong> ${escHtml(p.allergies || '')}</div>
    <h2>Vitals Log</h2>
    <table>
      <thead><tr><th>Date</th><th>Time</th><th>BP</th><th>HR</th><th>Temp</th><th>RR</th><th>SpOâ‚‚</th><th>Recorded By</th></tr></thead>
      <tbody>${vitalsRows || '<tr><td colspan="8">No vitals recorded</td></tr>'}</tbody>
    </table>
    <h2>Prescribed Medications</h2>
    <table>
      <thead><tr><th>Drug</th><th>Dosage</th><th>Route</th><th>Frequency</th><th>Start Date</th><th>End Date</th><th>Instructions</th></tr></thead>
      <tbody>${prescribedRows || '<tr><td colspan="7">No prescribed medications</td></tr>'}</tbody>
    </table>
    <h2>Administration Log</h2>
    <table>
      <thead><tr><th>Date</th><th>Time</th><th>Drug</th><th>Dosage</th><th>Route</th><th>Status</th><th>Nurse on Duty</th><th>Notes</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
    <h2>Blood Glucose Monitoring (6-Point)</h2>
    <table>
      <thead><tr><th>Date</th><th>Fasting</th><th>Post-Breakfast</th><th>Pre-Lunch</th><th>Post-Lunch</th><th>Pre-Dinner</th><th>Bedtime</th><th>Recorded By</th></tr></thead>
      <tbody>${glycemicRows || '<tr><td colspan="8">No glucose readings recorded</td></tr>'}</tbody>
    </table>
    <h2>Fluid Intake & Output Chart</h2>
    <table>
      <thead><tr><th>Date</th><th>Time</th><th>Type</th><th>Intake Oral (mL)</th><th>Intake IV (mL)</th><th>Output Urine (mL)</th><th>Output Other (mL)</th><th>Notes</th><th>Recorded By</th></tr></thead>
      <tbody>${fluidRows || '<tr><td colspan="9">No fluid I/O recorded</td></tr>'}</tbody>
    </table>
  </body></html>`);
  win.document.close();
  win.print();
}

// â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  document.getElementById('toastMsg').textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
}

// â”€â”€â”€ GLYCEMIC CHART (6-POINT) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGlycemicTable() {
  if (!activeId) return;
  const p = patients[activeId];
  if (!p.glycemicLog) p.glycemicLog = [];
  const tbody = document.getElementById('glycemicTableBody');
  const emptyState = document.getElementById('glycemicEmpty');
  tbody.innerHTML = '';

  const rows = p.glycemicLog || [];
  
  if (rows.length === 0 || !rows.some(r => r.date)) {
    if (emptyState) emptyState.style.display = 'block';
  } else {
    if (emptyState) emptyState.style.display = 'none';
    rows.forEach((row, i) => {
      if (row.date) addGlycemicRowDOM(row, i);
    });
  }
}

function addGlycemicRowDOM(data, index) {
  const tbody = document.getElementById('glycemicTableBody');
  const tr = document.createElement('tr');
  tr.dataset.gindex = index;

  const fields = ['fasting', 'postBreakfast', 'preLunch', 'postLunch', 'preDinner', 'bedtime'];
  const cellsHtml = fields.map(f => {
    const val = data[f] || '';
    const numVal = parseFloat(val);
    let cls = '';
    if (!isNaN(numVal)) {
      if (f === 'fasting' || f === 'preLunch' || f === 'preDinner') {
        if (numVal < 4.0) cls = 'abnormal-low';
        else if (numVal > 7.8) cls = 'abnormal-high';
      } else {
        if (numVal < 4.0) cls = 'abnormal-low';
        else if (numVal > 10.0) cls = 'abnormal-high';
      }
    }
    return `<td class="${cls}" style="padding: 0.75rem;">${val || 'â€”'}</td>`;
  }).join('');

  tr.innerHTML = `
    <td style="padding: 0.75rem;">${data.date || 'â€”'}</td>
    ${cellsHtml}
    <td style="padding: 0.75rem;">${escHtml(data.nurse || data.recorder || 'â€”')}</td>
  `;
  tbody.appendChild(tr);
}

// â”€â”€â”€ FLUID INTAKE/OUTPUT CHART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFluidTable() {
  if (!activeId) return;
  const p = patients[activeId];
  if (!p.fluidLog) p.fluidLog = [];
  const tbody = document.getElementById('fluidTableBody');
  const emptyState = document.getElementById('fluidEmpty');
  tbody.innerHTML = '';

  const rows = p.fluidLog || [];
  
  if (rows.length === 0 || !rows.some(r => r.date)) {
    if (emptyState) emptyState.style.display = 'block';
  } else {
    if (emptyState) emptyState.style.display = 'none';
    rows.forEach((row, i) => {
      if (row.date) addFluidRowDOM(row, i);
    });
  }
  
  calculateFluidBalance();
}

function addFluidRowDOM(data, index) {
  const tbody = document.getElementById('fluidTableBody');
  const tr = document.createElement('tr');
  tr.dataset.findex = index;

  tr.innerHTML = `
    <td style="padding: 0.75rem;">${data.date || 'â€”'}</td>
    <td style="padding: 0.75rem;">${data.time || 'â€”'}</td>
    <td style="padding: 0.75rem;">${data.type || 'â€”'}</td>
    <td style="padding: 0.75rem;">${data.intakeOral || '0'}</td>
    <td style="padding: 0.75rem;">${data.intakeIV || '0'}</td>
    <td style="padding: 0.75rem;">${data.outputUrine || '0'}</td>
    <td style="padding: 0.75rem;">${data.outputOther || '0'}</td>
    <td style="padding: 0.75rem;">${escHtml(data.notes || 'â€”')}</td>
    <td style="padding: 0.75rem;">${escHtml(data.nurse || data.recorder || 'â€”')}</td>
  `;
  tbody.appendChild(tr);
}

function calculateFluidBalance() {
  if (!activeId) return;
  const rows = patients[activeId].fluidLog || [];
  
  const now = new Date();
  const yesterday = new Date(now - 24 * 60 * 60 * 1000);
  
  let totalIntake = 0;
  let totalOutput = 0;
  
  rows.forEach(row => {
    if (row.date) {
      const rowDate = new Date(row.date);
      if (rowDate >= yesterday) {
        totalIntake += (parseFloat(row.intakeOral) || 0) + (parseFloat(row.intakeIV) || 0);
        totalOutput += (parseFloat(row.outputUrine) || 0) + (parseFloat(row.outputOther) || 0);
      }
    } else {
      totalIntake += (parseFloat(row.intakeOral) || 0) + (parseFloat(row.intakeIV) || 0);
      totalOutput += (parseFloat(row.outputUrine) || 0) + (parseFloat(row.outputOther) || 0);
    }
  });
  
  const balance = totalIntake - totalOutput;
  
  document.getElementById('totalIntake').textContent = totalIntake.toFixed(0);
  document.getElementById('totalOutput').textContent = totalOutput.toFixed(0);
  document.getElementById('fluidBalance').textContent = (balance >= 0 ? '+' : '') + balance.toFixed(0);
  
  const card = document.getElementById('fluidBalanceCard');
  if (Math.abs(balance) > 1000) {
    card.className = 'vital-card alert-high';
  } else if (Math.abs(balance) > 500) {
    card.className = 'vital-card alert-low';
  } else {
    card.className = 'vital-card alert-ok';
  }
}

// â”€â”€â”€ NURSING REPORTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderNursingReportTable() {
  if (!activeId) return;
  const p = patients[activeId];
  if (!p.nursingReports) p.nursingReports = [];
  const tbody = document.getElementById('nursingReportTableBody');
  tbody.innerHTML = '';

  const rows = p.nursingReports || [];
  rows.forEach((row, i) => addNursingReportRowDOM(row, i));

  if (rows.length === 0) addNursingReportRowDOM({}, 0);
}

function addNursingReportRow() {
  if (!activeId) return;
  if (!patients[activeId].nursingReports) patients[activeId].nursingReports = [];
  const i = patients[activeId].nursingReports.length;
  patients[activeId].nursingReports.push({});
  addNursingReportRowDOM({}, i);
}

function addNursingReportRowDOM(data, index) {
  const tbody = document.getElementById('nursingReportTableBody');
  const tr = document.createElement('tr');
  tr.dataset.nrindex = index;

  const currentWard = patients[activeId].ward || '';

  tr.innerHTML = `
    <td><input type="date" value="${data.date || ''}" style="min-width:110px"
        onchange="updateNursingReport(${index},'date',this.value)"></td>
    <td>
      <select style="min-width:100px" onchange="updateNursingReport(${index},'shift',this.value)">
        <option value="">Select Shift</option>
        <option ${data.shift === 'Morning (7am-3pm)' ? 'selected' : ''}>Morning (7am-3pm)</option>
        <option ${data.shift === 'Afternoon (3pm-11pm)' ? 'selected' : ''}>Afternoon (3pm-11pm)</option>
        <option ${data.shift === 'Night (11pm-7am)' ? 'selected' : ''}>Night (11pm-7am)</option>
      </select>
    </td>
    <td><textarea rows="3" value="${escHtml(data.report || '')}" placeholder="Enter comprehensive patient care report for 24 hours..."
        style="min-width:300px; width: 100%;" onchange="updateNursingReport(${index},'report',this.value)">${escHtml(data.report || '')}</textarea></td>
    <td><input type="text" value="${escHtml(data.nurse || currentUser.name)}" placeholder="Nurse name"
        style="min-width:120px" onchange="updateNursingReport(${index},'nurse',this.value)"></td>
    <td><input type="text" value="${escHtml(data.ward || currentWard)}" placeholder="Ward" readonly
        style="min-width:100px; background: var(--border); cursor: not-allowed;"></td>
    <td><button class="row-del" onclick="deleteNursingReportRow(${index})" title="Remove">âœ•</button></td>
  `;
  tbody.appendChild(tr);
}

function updateNursingReport(i, field, val) {
  if (!activeId) return;
  if (!patients[activeId].nursingReports[i]) patients[activeId].nursingReports[i] = {};
  patients[activeId].nursingReports[i][field] = val;
  
  // Auto-set nurse name and ward if not already set
  if (!patients[activeId].nursingReports[i].nurse) {
    patients[activeId].nursingReports[i].nurse = currentUser.name;
  }
  if (!patients[activeId].nursingReports[i].ward) {
    patients[activeId].nursingReports[i].ward = patients[activeId].ward;
  }
}

function deleteNursingReportRow(i) {
  if (!activeId) return;
  patients[activeId].nursingReports.splice(i, 1);
  renderNursingReportTable();
}

// â”€â”€â”€ SAVE 24-HOUR NURSING REPORTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveWardNursingReport() {
  if (!activeId) {
    alert('Please select a patient first.');
    return;
  }
  
  const patient = patients[activeId];
  const reports = patient.nursingReports || [];
  
  if (reports.length === 0) {
    alert('No nursing reports to save. Please add at least one report.');
    return;
  }
  
  // Validate that all reports have required fields
  let hasIncomplete = false;
  reports.forEach((report, index) => {
    if (!report.date || !report.shift || !report.report) {
      hasIncomplete = true;
    }
  });
  
  if (hasIncomplete) {
    if (!confirm('Some reports have incomplete information (missing date, shift, or report content). Save anyway?')) {
      return;
    }
  }
  
  // Save data
  saveData();
  
  // Generate summary
  const today = new Date().toISOString().split('T')[0];
  const todayReports = reports.filter(r => r.date === today);
  const ward = currentUser.ward || patient.ward || 'Unknown Ward';
  
  showToast(`âœ“ Saved ${reports.length} nursing report(s) for ${patient.name || 'patient'} in ${ward}`);
  
  // Optional: Create a timestamped backup
  const backupKey = `medrecord_nursing_backup_${patient.emr}_${new Date().getTime()}`;
  _memStore.setItem(backupKey, JSON.stringify({
    patient: patient.name,
    emr: patient.emr,
    ward: ward,
    reports: reports,
    savedBy: currentUser.name,
    savedAt: new Date().toISOString()
  }));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WARD STATISTICS FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function initializeWardStatistics() {
  if (!activeId) return;
  const patient = patients[activeId];
  
  // Initialize ward statistics if not exists
  if (!patient.wardStatistics) {
    patient.wardStatistics = {
      morning: {},
      night: {},
      patientDetails: {}
    };
  }
  
  // Initialize blood transfusions if not exists
  if (!patient.bloodTransfusions) {
    patient.bloodTransfusions = [];
  }
  
  loadWardStatistics();
}

function loadWardStatistics() {
  if (!activeId) return;
  const patient = patients[activeId];
  const stats = patient.wardStatistics || { morning: {}, night: {}, patientDetails: {} };
  
  // Load morning shift data
  const morningFields = ['occ', 'vac', 'adm', 'disc', 'int_trans_in', 'int_trans_out', 'ext_trans_in', 'ext_trans_out', 'dama', 'sil', 'vsil', 'absc', 'death', 'nurses_am', 'nurses_pm'];
  morningFields.forEach(field => {
    const el = document.getElementById(`ward_stat_morning_${field}`);
    if (el) el.value = stats.morning[field] || '';
  });
  
  // Load night shift data
  morningFields.forEach(field => {
    const el = document.getElementById(`ward_stat_night_${field}`);
    if (el) el.value = stats.night[field] || '';
  });
  
  // Load blood transfusion records
  renderBloodTransfusions();
  
  // Auto-populate patient details from the active patient record
  autoPopulateWardStatPatientDetails();
  
  // Load editable contact fields (address, phone, nok_phone)
  const contactFields = ['address', 'phone', 'nok_phone'];
  contactFields.forEach(field => {
    const el = document.getElementById(`ward_stat_patient_${field}`);
    if (el) el.value = stats.patientDetails[field] || '';
  });
  
  // Calculate totals
  calculateWardStatTotals();
}

function saveWardStatField(shift, field, value) {
  if (!activeId) return;
  const patient = patients[activeId];
  
  if (!patient.wardStatistics) {
    patient.wardStatistics = { morning: {}, night: {}, patientDetails: {} };
  }
  
  patient.wardStatistics[shift][field] = value;
  saveData();
  calculateWardStatTotals();
}

function saveWardStatPatientField(field, value) {
  if (!activeId) return;
  const patient = patients[activeId];
  
  if (!patient.wardStatistics) {
    patient.wardStatistics = { morning: {}, night: {}, patientDetails: {} };
  }
  
  patient.wardStatistics.patientDetails[field] = value;
  saveData();
}

function calculateWardStatTotals() {
  if (!activeId) return;
  const patient = patients[activeId];
  const stats = patient.wardStatistics || { morning: {}, night: {} };
  
  const numericFields = ['occ', 'vac', 'adm', 'disc', 'int_trans_in', 'int_trans_out', 'ext_trans_in', 'ext_trans_out', 'dama', 'sil', 'vsil', 'absc', 'death'];
  
  numericFields.forEach(field => {
    const morningVal = parseFloat(stats.morning[field]) || 0;
    const nightVal = parseFloat(stats.night[field]) || 0;
    const total = morningVal + nightVal;
    
    const totalEl = document.getElementById(`ward_stat_total_${field}`);
    if (totalEl) {
      totalEl.textContent = total > 0 ? total : 'â€”';
    }
  });
}

function saveWardStatistics() {
  if (!activeId) {
    alert('Please select a patient first.');
    return;
  }
  
  saveData();
  showToast('âœ“ Ward statistics saved successfully');
}

function autoPopulateWardStatPatientDetails() {
  if (!activeId) return;
  const p = patients[activeId];
  if (!p) return;

  // Helper to set a display div
  const setField = (id, value) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value || 'â€”';
  };

  // Name
  setField('ward_stat_patient_name', p.name);

  // Age â€” calculated from DOB
  if (p.dob) {
    const ageDays = (Date.now() - new Date(p.dob)) / (1000 * 60 * 60 * 24);
    let ageStr;
    if (ageDays < 30) {
      ageStr = Math.floor(ageDays) + ' day(s)';
    } else if (ageDays < 365) {
      ageStr = Math.floor(ageDays / 30) + ' month(s)';
    } else {
      ageStr = Math.floor(ageDays / 365) + ' year(s)';
    }
    setField('ward_stat_patient_age', ageStr);
  } else {
    setField('ward_stat_patient_age', 'â€”');
  }

  // Sex/Gender
  setField('ward_stat_patient_sex', p.gender);

  // EMR
  setField('ward_stat_patient_emr', p.emr);

  // Date of Admission
  setField('ward_stat_patient_doa', p.admissionDate);

  // Ward
  setField('ward_stat_patient_ward', p.ward);

  // Diagnosis
  setField('ward_stat_patient_diagnosis', p.diagnosis);

  // Attending physician
  setField('ward_stat_patient_attending', p.attending);
}

function saveAllNursingReports() {
  // Count all nursing reports across all patients
  let totalReports = 0;
  let patientsWithReports = 0;
  const wardSummary = {};
  
  Object.entries(patients).forEach(([patientId, patient]) => {
    if (patient.nursingReports && patient.nursingReports.length > 0) {
      patientsWithReports++;
      totalReports += patient.nursingReports.length;
      
      const ward = patient.ward || 'Unknown';
      if (!wardSummary[ward]) {
        wardSummary[ward] = {
          patients: 0,
          reports: 0
        };
      }
      wardSummary[ward].patients++;
      wardSummary[ward].reports += patient.nursingReports.length;
    }
  });
  
  if (totalReports === 0) {
    alert('No nursing reports found across all wards.');
    return;
  }
  
  // Save all data
  saveData();
  
  // Create comprehensive backup with timestamp
  const timestamp = new Date().toISOString();
  const backupData = {
    savedBy: currentUser.name,
    savedAt: timestamp,
    totalReports: totalReports,
    patientsWithReports: patientsWithReports,
    wardSummary: wardSummary,
    allReports: []
  };
  
  // Collect all reports
  Object.entries(patients).forEach(([patientId, patient]) => {
    if (patient.nursingReports && patient.nursingReports.length > 0) {
      patient.nursingReports.forEach(report => {
        backupData.allReports.push({
          patientName: patient.name,
          patientEMR: patient.emr,
          ward: report.ward || patient.ward,
          date: report.date,
          shift: report.shift,
          report: report.report,
          nurse: report.nurse
        });
      });
    }
  });
  
  // Save backup
  const backupKey = `medrecord_all_nursing_backup_${new Date().getTime()}`;
  _memStore.setItem(backupKey, JSON.stringify(backupData));
  
  // Show detailed summary
  let summaryText = `Successfully saved all nursing reports!\n\n`;
  summaryText += `Total Reports: ${totalReports}\n`;
  summaryText += `Patients: ${patientsWithReports}\n\n`;
  summaryText += `By Ward:\n`;
  
  Object.entries(wardSummary).forEach(([ward, data]) => {
    summaryText += `â€¢ ${ward}: ${data.reports} report(s) from ${data.patients} patient(s)\n`;
  });
  
  summaryText += `\nSaved by: ${currentUser.name}\n`;
  summaryText += `Time: ${new Date().toLocaleString()}`;
  
  alert(summaryText);
  showToast(`âœ“ Saved ${totalReports} nursing reports across all wards`);
}

// â”€â”€â”€ OVERALL NURSE REPORTS VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderOverallReports() {
  const container = document.getElementById('allWardsReports');
  container.innerHTML = '';

  if (currentUser && currentUser.role !== 'nurse' && currentUser.role !== 'overall_nurse') {
    container.innerHTML = `
      <div class="empty-state">
        <div class="icon">ğŸ”’</div>
        <h3>Access Restricted</h3>
        <p>Only nurses can view the overall nursing reports dashboard.</p>
      </div>`;
    return;
  }

  const filterDate = document.getElementById('reportFilterDate').value;

  // Group patients by ward
  const wardGroups = {};
  const WARDS = ['Ward A','Ward B','Ward C','Ward D','Ward E','Ward F','Ward G','Ward H'];
  WARDS.forEach(w => wardGroups[w] = []);

  Object.entries(patients).forEach(([pid, patient]) => {
    const ward = patient.ward || 'Unknown';
    if (!wardGroups[ward]) wardGroups[ward] = [];
    wardGroups[ward].push({ pid, patient });
  });

  let anyRendered = false;

  Object.entries(wardGroups).forEach(([ward, list]) => {
    if (list.length === 0) return;
    anyRendered = true;

    const wardDiv = document.createElement('div');
    wardDiv.style.marginBottom = '3rem';

    // Ward heading
    wardDiv.innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 1.5rem;">
        <div style="width: 4px; height: 28px; background: var(--teal); border-radius: 2px;"></div>
        <h2 style="font-family: 'Playfair Display', serif; font-size: 1.4rem; color: var(--light);">ğŸ¥ ${ward}</h2>
        <span style="font-size: 0.78rem; color: var(--muted); margin-left: 6px;">${list.length} patient${list.length !== 1 ? 's' : ''}</span>
      </div>`;

    list.forEach(({ pid, patient }) => {
      const stats = patient.wardStatistics || { morning: {}, night: {}, patientDetails: {} };
      const reports = patient.nursingReports || [];
      const transfusions = patient.bloodTransfusions || [];

      const filteredReports = filterDate ? reports.filter(r => r.date === filterDate) : reports;

      // Calculate age
      let ageStr = 'â€”';
      if (patient.dob) {
        const days = (Date.now() - new Date(patient.dob)) / 86400000;
        ageStr = days < 30 ? Math.floor(days) + ' day(s)' : days < 365 ? Math.floor(days / 30) + ' month(s)' : Math.floor(days / 365) + ' year(s)';
      }

      // Ward stat totals (numeric only)
      const numFields = ['occ','vac','adm','disc','int_trans_in','int_trans_out','ext_trans_in','ext_trans_out','dama','sil','vsil','absc','death'];
      const totals = {};
      numFields.forEach(f => {
        const m = parseFloat(stats.morning[f]) || 0;
        const n = parseFloat(stats.night[f]) || 0;
        totals[f] = (m + n) > 0 ? (m + n) : 'â€”';
      });

      const fieldVal = (shift, f) => stats[shift][f] !== undefined && stats[shift][f] !== '' ? escHtml(String(stats[shift][f])) : '';

      // Nursing report rows
      const reportRows = filteredReports.length > 0
        ? filteredReports.map(r => `
          <tr>
            <td>${escHtml(r.date || 'â€”')}</td>
            <td>${escHtml(r.shift || 'â€”')}</td>
            <td style="max-width:400px; white-space:pre-wrap;">${escHtml(r.report || 'â€”')}</td>
            <td>${escHtml(r.nurse || 'â€”')}</td>
            <td>${escHtml(r.ward || patient.ward || 'â€”')}</td>
          </tr>`).join('')
        : `<tr><td colspan="5" style="color: var(--muted); text-align:center; padding: 1rem;">No nursing report entries${filterDate ? ' for selected date' : ''}.</td></tr>`;

      // Blood transfusion cards
      const btCards = transfusions.length > 0
        ? transfusions.map((t, i) => `
          <div style="background: var(--navy); border: 1px solid rgba(244,63,94,0.2); border-radius: 8px; padding: 1rem; margin-bottom: 0.8rem;">
            <div style="font-weight: 700; color: #f43f5e; font-size: 0.82rem; margin-bottom: 0.8rem; text-transform: uppercase; letter-spacing: 0.06em;">ğŸ©¸ Transfusion #${i+1}</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0.7rem; font-size: 0.83rem;">
              <div><span style="color:var(--muted); font-size:0.72rem; text-transform:uppercase;">Bag No.</span><br>${escHtml(t.bagNumber || 'â€”')}</div>
              <div><span style="color:var(--muted); font-size:0.72rem; text-transform:uppercase;">Blood Group</span><br>${escHtml(t.bloodGroup || 'â€”')}</div>
              <div><span style="color:var(--muted); font-size:0.72rem; text-transform:uppercase;">Start</span><br>${escHtml(t.startTime || 'â€”')}</div>
              <div><span style="color:var(--muted); font-size:0.72rem; text-transform:uppercase;">End</span><br>${escHtml(t.endTime || 'â€”')}</div>
              <div><span style="color:var(--muted); font-size:0.72rem; text-transform:uppercase;">Nurse</span><br>${escHtml(t.nurse || 'â€”')}</div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.7rem; margin-top: 0.7rem; font-size: 0.82rem;">
              <div style="background: rgba(245,158,11,0.07); border: 1px solid rgba(245,158,11,0.2); border-radius: 6px; padding: 0.6rem;">
                <div style="font-weight: 700; color: var(--amber); font-size: 0.72rem; margin-bottom: 0.4rem;">âš ï¸ PRE-TRANSFUSION</div>
                ${['bp','hr','temp','rr','spo2'].map(v => `<span style="margin-right:10px; color:var(--muted); font-size:0.72rem;">${v.toUpperCase()}: <strong style="color:var(--text);">${escHtml(t.preVitals && t.preVitals[v] ? t.preVitals[v] : 'â€”')}</strong></span>`).join('')}
              </div>
              <div style="background: rgba(16,185,129,0.07); border: 1px solid rgba(16,185,129,0.2); border-radius: 6px; padding: 0.6rem;">
                <div style="font-weight: 700; color: var(--success); font-size: 0.72rem; margin-bottom: 0.4rem;">âœ… POST-TRANSFUSION</div>
                ${['bp','hr','temp','rr','spo2'].map(v => `<span style="margin-right:10px; color:var(--muted); font-size:0.72rem;">${v.toUpperCase()}: <strong style="color:var(--text);">${escHtml(t.postVitals && t.postVitals[v] ? t.postVitals[v] : 'â€”')}</strong></span>`).join('')}
              </div>
            </div>
            ${t.notes ? `<div style="margin-top:0.5rem; font-size:0.82rem; color:var(--muted);">Notes: <span style="color:var(--text);">${escHtml(t.notes)}</span></div>` : ''}
          </div>`).join('')
        : `<div style="color: var(--muted); font-size: 0.85rem; padding: 0.5rem 0;">No blood transfusion records.</div>`;

      const patientCard = document.createElement('div');
      patientCard.className = 'section';
      patientCard.style.marginBottom = '1.5rem';
      patientCard.innerHTML = `
        <!-- Section header -->
        <div class="section-title-row" style="margin-bottom: 0.8rem;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 42px; height: 42px; border-radius: 50%; background: rgba(45,212,191,0.12); border: 2px solid rgba(45,212,191,0.3); display:flex; align-items:center; justify-content:center; color:var(--teal); font-size:1.1rem; flex-shrink:0;">ğŸ‘¤</div>
            <div>
              <div style="font-family:'Playfair Display',serif; font-size:1.1rem; font-weight:700; color:var(--light);">${escHtml(patient.name || 'Unnamed Patient')}</div>
              <div style="font-size:0.75rem; color:var(--muted);">${escHtml(patient.emr || 'No EMR')} Â· ${escHtml(patient.gender || 'â€”')} Â· ${ageStr} Â· ${escHtml(patient.ward || 'â€”')}</div>
            </div>
          </div>
          <button class="btn btn-secondary btn-small" onclick="viewPatientFromReport('${pid}')">Open Patient â†—</button>
        </div>

        <p style="font-size: 0.82rem; color: var(--muted); margin-bottom: 1.2rem;">
          24-Hour Nursing Report â€” document comprehensive patient care for handover and track ward capacity, patient movements, and nursing staff assignments
        </p>

        <!-- â”€â”€ Ward Statistics â”€â”€ -->
        <div style="font-weight:600; color:var(--text); margin-bottom:0.7rem; font-size:0.88rem; display:flex; align-items:center; gap:6px;">
          <span style="display:inline-block; width:3px; height:14px; background:var(--teal); border-radius:2px;"></span>
          ğŸ“Š Ward Statistics
        </div>
        <div class="table-container" style="margin-bottom:1.5rem;">
          <table style="font-size:0.8rem;">
            <thead>
              <tr>
                <th rowspan="2" style="vertical-align:middle; min-width:75px;">SHIFTS</th>
                <th colspan="2" style="text-align:center;">BED</th>
                <th colspan="1" style="text-align:center;">ADM</th>
                <th colspan="1" style="text-align:center;">DISC</th>
                <th colspan="4" style="text-align:center;">TRANSFERS</th>
                <th colspan="5" style="text-align:center;">SPECIAL CASES</th>
                <th colspan="2" style="text-align:center;">NURSES ON DUTY</th>
              </tr>
              <tr>
                <th>OCC</th><th>VAC</th><th>ADM</th><th>DISC</th>
                <th>INT TRANS IN</th><th>INT TRANS OUT</th><th>EXT TRANS IN</th><th>EXT TRANS OUT</th>
                <th>DAMA</th><th>SIL</th><th>VSIL</th><th>ABSC</th><th>DEATH</th>
                <th>AM Nurses</th><th>PM Nurses</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="font-weight:600;">MORNING</td>
                ${numFields.map(f => `<td style="text-align:center;">${fieldVal('morning',f)||'â€”'}</td>`).join('')}
                <td style="text-align:center; font-size:0.78rem;">${fieldVal('morning','nurses_am')||'â€”'}</td>
                <td style="text-align:center; font-size:0.78rem;">${fieldVal('morning','nurses_pm')||'â€”'}</td>
              </tr>
              <tr>
                <td style="font-weight:600;">NIGHT</td>
                ${numFields.map(f => `<td style="text-align:center;">${fieldVal('night',f)||'â€”'}</td>`).join('')}
                <td style="text-align:center; font-size:0.78rem;">${fieldVal('night','nurses_am')||'â€”'}</td>
                <td style="text-align:center; font-size:0.78rem;">${fieldVal('night','nurses_pm')||'â€”'}</td>
              </tr>
              <tr style="background:rgba(45,212,191,0.1); font-weight:600;">
                <td>TOTAL</td>
                ${numFields.map(f => `<td style="text-align:center;">${totals[f]}</td>`).join('')}
                <td colspan="2" style="color:var(--muted); font-weight:400; font-size:0.72rem; text-align:center;">Names not summed</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- â”€â”€ Patient Details â”€â”€ -->
        <div style="font-weight:600; color:var(--text); margin-bottom:0.7rem; font-size:0.88rem; display:flex; align-items:center; gap:6px;">
          <span style="display:inline-block; width:3px; height:14px; background:var(--teal); border-radius:2px;"></span>
          ğŸ“‹ Patient Details
        </div>
        <div style="background:var(--deep); border:1px solid var(--border); border-radius:8px; padding:1rem; margin-bottom:1.5rem;">
          <div style="display:flex; align-items:center; justify-content:flex-end; margin-bottom:0.8rem;">
            <span style="font-size:0.72rem; color:var(--teal); background:rgba(45,212,191,0.1); border:1px solid rgba(45,212,191,0.25); border-radius:20px; padding:3px 10px; font-weight:600;">âŸ³ Auto-filled from patient record</span>
          </div>
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:0.8rem; margin-bottom:1rem;">
            ${[
              ['NAME', patient.name],
              ['AGE', ageStr],
              ['SEX', patient.gender],
              ['EMR', patient.emr],
              ['DATE OF ADMISSION', patient.admissionDate],
              ['WARD', patient.ward],
              ['DIAGNOSIS', patient.diagnosis],
              ['ATTENDING PHYSICIAN', patient.attending]
            ].map(([label, val]) => `
              <div>
                <div style="font-size:0.72rem; color:var(--muted); font-weight:600; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:4px;">${label}</div>
                <div style="background:rgba(45,212,191,0.05); border:1px solid rgba(45,212,191,0.2); border-radius:6px; padding:8px 10px; font-size:0.83rem; color:var(--text); min-height:34px;">${escHtml(val || 'â€”')}</div>
              </div>`).join('')}
          </div>
          ${(stats.patientDetails.address || stats.patientDetails.phone || stats.patientDetails.nok_phone) ? `
          <div style="border-top:1px solid var(--border); padding-top:0.8rem; margin-top:0.3rem;">
            <div style="font-size:0.72rem; color:var(--muted); font-weight:600; text-transform:uppercase; letter-spacing:0.08em; margin-bottom:0.6rem;">Additional Contact Info</div>
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:0.8rem;">
              ${stats.patientDetails.address ? `<div><div style="font-size:0.72rem; color:var(--muted); font-weight:600; text-transform:uppercase; margin-bottom:4px;">ADDRESS</div><div style="font-size:0.83rem; color:var(--text);">${escHtml(stats.patientDetails.address)}</div></div>` : ''}
              ${stats.patientDetails.phone ? `<div><div style="font-size:0.72rem; color:var(--muted); font-weight:600; text-transform:uppercase; margin-bottom:4px;">PHONE</div><div style="font-size:0.83rem; color:var(--text);">${escHtml(stats.patientDetails.phone)}</div></div>` : ''}
              ${stats.patientDetails.nok_phone ? `<div><div style="font-size:0.72rem; color:var(--muted); font-weight:600; text-transform:uppercase; margin-bottom:4px;">NOK PHONE</div><div style="font-size:0.83rem; color:var(--text);">${escHtml(stats.patientDetails.nok_phone)}</div></div>` : ''}
            </div>
          </div>` : ''}
        </div>

        <!-- â”€â”€ Nursing Report Entries â”€â”€ -->
        <div style="font-weight:600; color:var(--text); margin-bottom:0.7rem; font-size:0.88rem; display:flex; align-items:center; gap:6px;">
          <span style="display:inline-block; width:3px; height:14px; background:var(--teal); border-radius:2px;"></span>
          ğŸ“ Nursing Report Entries
        </div>
        <div class="table-container" style="margin-bottom:1.5rem;">
          <table>
            <thead>
              <tr>
                <th>Date</th><th>Shift</th><th>Report</th><th>Nurse on Duty</th><th>Ward</th>
              </tr>
            </thead>
            <tbody>${reportRows}</tbody>
          </table>
        </div>

        <!-- â”€â”€ Blood Transfusion â”€â”€ -->
        <div style="font-weight:600; color:var(--text); margin-bottom:0.7rem; font-size:0.88rem; display:flex; align-items:center; gap:6px;">
          <span style="display:inline-block; width:3px; height:14px; background:#f43f5e; border-radius:2px;"></span>
          ğŸ©¸ Blood Transfusion Record
        </div>
        ${btCards}
      `;

      wardDiv.appendChild(patientCard);
    });

    container.appendChild(wardDiv);
  });

  if (!anyRendered) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="icon">ğŸ“‹</div>
        <h3>No Patient Records</h3>
        <p>No patients have been added to any ward yet${filterDate ? ' for the selected date' : ''}.</p>
      </div>`;
  }
}

function clearDateFilter() {
  document.getElementById('reportFilterDate').value = '';
  renderOverallReports();
}

function viewPatientFromReport(patientId) {
  switchToPatientView();
  setTimeout(() => {
    selectPatient(patientId);
  }, 100);
}

function exportAllReportsToCSV() {
  let csv = '24-Hour Nursing Reports - All Wards\n\n';
  csv += 'Ward,Patient Name,EMR,Date,Shift,Report,Nurse\n';
  
  Object.entries(patients).forEach(([patientId, patient]) => {
    if (!patient.nursingReports) return;
    
    patient.nursingReports.forEach(report => {
      const ward = report.ward || patient.ward || 'Unknown';
      const name = patient.name || 'Unnamed Patient';
      const emr = patient.emr || 'No EMR';
      csv += `"${ward}","${name}","${emr}","${report.date || ''}","${report.shift || ''}","${(report.report || '').replace(/"/g, '""')}","${report.nurse || ''}"\n`;
    });
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Nursing_Reports_All_Wards_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  showToast('âœ“ All reports exported to CSV');
}

// â”€â”€â”€ PRINT / SAVE / SHARE REPORTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let _shareScope = 'all';

// â”€â”€ Shared helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _getFilterDate() {
  return document.getElementById('reportFilterDate').value || '';
}

function _collectReports(scope) {
  // Returns array of {ward, patientName, emr, date, shift, report, nurse}
  const filterDate = _getFilterDate();
  const rows = [];
  const WARDS = ['Ward A','Ward B','Ward C','Ward D','Ward E','Ward F','Ward G','Ward H'];

  WARDS.forEach(ward => {
    Object.values(patients).forEach(p => {
      if ((p.ward || 'Unknown') !== ward) return;
      if (!p.nursingReports || !p.nursingReports.length) return;
      const rpts = (scope === 'date' && filterDate)
        ? p.nursingReports.filter(r => r.date === filterDate)
        : p.nursingReports;
      rpts.forEach(r => {
        rows.push({
          ward,
          patientName: p.name  || 'Unnamed Patient',
          emr:         p.emr   || 'N/A',
          date:        r.date  || 'â€”',
          shift:       r.shift || 'â€”',
          report:      r.report || '',
          nurse:       r.nurse || 'â€”'
        });
      });
    });
  });
  return rows;
}

function _buildHTML(scope) {
  const filterDate = _getFilterDate();
  const now     = new Date().toLocaleString();
  const by      = currentUser ? currentUser.name : 'â€”';
  const WARDS   = ['Ward A','Ward B','Ward C','Ward D','Ward E','Ward F','Ward G','Ward H'];
  let   sections = '';

  WARDS.forEach(ward => {
    const rows = _collectReports(scope).filter(r => r.ward === ward);
    if (!rows.length) return;
    sections += `
      <h2>${ward}</h2>
      <table>
        <thead><tr><th>Patient</th><th>EMR</th><th>Date</th><th>Shift</th><th>Report</th><th>Nurse</th></tr></thead>
        <tbody>
          ${rows.map(r => `<tr>
            <td><strong>${escHtml(r.patientName)}</strong></td>
            <td>${escHtml(r.emr)}</td>
            <td>${escHtml(r.date)}</td>
            <td>${escHtml(r.shift)}</td>
            <td style="white-space:pre-wrap;max-width:420px">${escHtml(r.report)}</td>
            <td>${escHtml(r.nurse)}</td>
          </tr>`).join('')}
        </tbody>
      </table>`;
  });

  if (!sections) sections = '<p style="color:#64748b">No reports found.</p>';

  return `<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Nursing Reports â€” All Wards</title>
<style>
  body{font-family:Arial,sans-serif;padding:24px;color:#1e293b}
  h1{font-size:1.35rem;border-bottom:3px solid #2dd4bf;padding-bottom:10px;color:#0f1b2d}
  .meta{font-size:.82rem;color:#64748b;margin-bottom:1.5rem}
  h2{background:#0f1b2d;color:#2dd4bf;padding:8px 14px;border-radius:5px;margin-top:2rem;font-size:1rem}
  table{width:100%;border-collapse:collapse;margin:10px 0 20px}
  th,td{border:1px solid #e2e8f0;padding:8px 10px;text-align:left;font-size:.85rem;vertical-align:top}
  th{background:#2dd4bf;color:#fff;font-weight:700}
  tr:nth-child(even){background:#f8fafc}
  @media print{@page{margin:1.5cm}h2{page-break-before:auto}}
</style></head><body>
  <h1>ğŸ“‹ 24-Hour Nursing Reports â€” All Wards</h1>
  <div class="meta">
    <strong>Generated:</strong> ${now} &nbsp;|&nbsp; <strong>By:</strong> ${escHtml(by)}
    ${filterDate ? ' &nbsp;|&nbsp; <strong>Date:</strong> '+filterDate : ''}
  </div>
  ${sections}
  <p style="font-size:.72rem;color:#94a3b8;margin-top:2rem;border-top:1px solid #e2e8f0;padding-top:.6rem">
    MedRecord â€” Medication Administration Records
  </p>
</body></html>`;
}

function _buildText(scope) {
  const rows = scope === 'summary' ? [] : _collectReports(scope);
  const now  = new Date().toLocaleString();
  const by   = currentUser ? currentUser.name : 'â€”';
  let out = '=== 24-HOUR NURSING REPORTS â€” ALL WARDS ===\n';
  out += `Generated : ${now}\nBy        : ${by}\n\n`;

  if (scope === 'summary') {
    const wards = {};
    Object.values(patients).forEach(p => {
      if (!p.nursingReports || !p.nursingReports.length) return;
      const w = p.ward || 'Unknown';
      if (!wards[w]) wards[w] = { patients:0, reports:0 };
      wards[w].patients++;
      wards[w].reports += p.nursingReports.length;
    });
    out += 'SUMMARY BY WARD\n---------------\n';
    Object.entries(wards).forEach(([w,d]) =>
      out += `${w}: ${d.reports} report(s), ${d.patients} patient(s)\n`
    );
    return out;
  }

  const WARDS = ['Ward A','Ward B','Ward C','Ward D','Ward E','Ward F','Ward G','Ward H'];
  WARDS.forEach(ward => {
    const wRows = rows.filter(r => r.ward === ward);
    if (!wRows.length) return;
    out += `\nâ”€â”€ ${ward} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
    wRows.forEach(r => {
      out += `Patient : ${r.patientName}  (EMR: ${r.emr})\n`;
      out += `Date    : ${r.date}   Shift: ${r.shift}   Nurse: ${r.nurse}\n`;
      out += `Report  : ${r.report || '(no text)'}\n`;
      out += '- - - - - - - - - - - - - - - - - -\n';
    });
  });
  return out;
}

// â”€â”€ Modal open / close â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openShareModal() {
  _shareScope = 'all';
  document.querySelectorAll('.share-scope-btn').forEach((b,i) =>
    b.classList.toggle('on', i === 0));
  _shareMsg('');
  document.getElementById('qrArea').style.display = 'none';
  document.getElementById('shareModal').classList.remove('hidden');
}

function closeShareModal() {
  document.getElementById('shareModal').classList.add('hidden');
}

function setScope(val, btn) {
  _shareScope = val;
  document.querySelectorAll('.share-scope-btn').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
}

function _shareMsg(txt, type) {
  const el = document.getElementById('shareMsg');
  if (!txt) { el.style.display='none'; return; }
  el.className = 'share-msg ' + (type||'inf');
  el.textContent = txt;
  el.style.display = 'block';
}

// â”€â”€ 1. Download HTML file â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportReportHTML() {
  const html = _buildHTML(_shareScope);
  const blob = new Blob([html], { type:'text/html;charset=utf-8' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = `NursingReports_AllWards_${new Date().toISOString().split('T')[0]}.html`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 5000);
  _shareMsg('âœ“ File downloaded â€” open in any browser or print from there.', 'ok');
  showToast('âœ“ Report file saved');
}

// â”€â”€ 2. Print (replaces old function) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function printAllReports() {
  const scope = typeof _shareScope !== 'undefined' ? _shareScope : 'all';
  const win   = window.open('', '_blank');
  if (!win) { alert('Please allow pop-ups and try again.'); return; }
  win.document.write(_buildHTML(scope));
  win.document.close();
  win.focus();
  setTimeout(() => win.print(), 350);
}

// â”€â”€ 3. Email â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function shareEmail() {
  const text    = _buildText(_shareScope);
  const subject = encodeURIComponent('Nursing Reports â€” All Wards â€” ' + new Date().toLocaleDateString());
  const body    = encodeURIComponent(
    text.length > 1800 ? text.substring(0,1800)+'\n\n[truncated â€” download full file]' : text
  );
  window.open('mailto:?subject='+subject+'&body='+body, '_self');
  _shareMsg('âœ“ Email app opened with report content.', 'ok');
}

// â”€â”€ 4. WhatsApp â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function shareWhatsApp() {
  const text = _buildText('summary');
  window.open('https://wa.me/?text=' + encodeURIComponent(text.substring(0,1500)),
    '_blank', 'noopener,noreferrer');
  _shareMsg('âœ“ WhatsApp opened with ward summary.', 'ok');
}

// â”€â”€ 5. Copy to clipboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function shareCopy() {
  const text = _buildText(_shareScope);
  try {
    await navigator.clipboard.writeText(text);
  } catch (e) {
    const ta = Object.assign(document.createElement('textarea'),
      { value: text, style: 'position:fixed;opacity:0' });
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
  }
  _shareMsg('âœ“ Full report copied to clipboard â€” paste into any app.', 'ok');
  showToast('âœ“ Report copied to clipboard');
}

// â”€â”€ 6. Native share sheet (AirDrop, Nearby Share, etc.) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function shareSystem() {
  const date = new Date().toISOString().split('T')[0];
  const html = _buildHTML(_shareScope);
  const file = new File([html], `NursingReports_${date}.html`, { type:'text/html' });

  if (!navigator.share) {
    _shareMsg('âš  Native share not supported in this browser â€” downloading file instead.', 'inf');
    exportReportHTML(); return;
  }
  try {
    if (navigator.canShare && navigator.canShare({ files:[file] })) {
      await navigator.share({ title:'Nursing Reports â€” '+date, files:[file] });
    } else {
      await navigator.share({ title:'Nursing Reports â€” '+date, text:_buildText(_shareScope).substring(0,2000) });
    }
    _shareMsg('âœ“ Shared successfully.', 'ok');
  } catch(e) {
    if (e.name !== 'AbortError')
      _shareMsg('Share failed or cancelled.', 'err');
  }
}

// â”€â”€ 7. Bluetooth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function shareBluetooth() {
  const date = new Date().toISOString().split('T')[0];
  const html = _buildHTML(_shareScope);
  const file = new File([html], `NursingReports_${date}.html`, { type:'text/html' });

  // Prefer system share with file (triggers BT on Android / iOS)
  if (navigator.share && navigator.canShare && navigator.canShare({ files:[file] })) {
    try {
      _shareMsg('â³ Opening share sheet â€” choose Bluetooth from the listâ€¦', 'inf');
      await navigator.share({ title:'Nursing Reports â€” '+date, files:[file] });
      _shareMsg('âœ“ Shared via system â€” select Bluetooth on your device.', 'ok');
      return;
    } catch(e) {
      if (e.name === 'AbortError') { _shareMsg('Share cancelled.', 'inf'); return; }
    }
  }

  // Try Web Bluetooth API (Chrome desktop)
  if (navigator.bluetooth) {
    try {
      _shareMsg('â³ Looking for Bluetooth devicesâ€¦', 'inf');
      const dev = await navigator.bluetooth.requestDevice({ acceptAllDevices:true });
      _shareMsg(
        `âœ“ Device "${dev.name||'Unknown'}" found. To transfer the file: ` +
        'download it below, then send via your OS Bluetooth file transfer (right-click on Windows / Files app on Android).',
        'inf'
      );
      exportReportHTML();
      return;
    } catch(e) {
      if (e.name === 'NotFoundError') { _shareMsg('No device selected.', 'inf'); return; }
    }
  }

  // Fallback guide
  _shareMsg(
    'ğŸ’¡ Tip: Download the report file, then use your device\'s Bluetooth "Send file" feature '
    + '(right-click on Windows, or use the Files app on Android) to send it to another device.',
    'inf'
  );
  exportReportHTML();
}

// â”€â”€ 8. QR Code (encodes a data-URL of the text summary) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function shareQR() {
  const area = document.getElementById('qrArea');

  if (area.style.display !== 'none') {
    area.style.display = 'none';
    _shareMsg('');
    return;
  }

  const text = _buildText('summary').substring(0, 900); // QR limit

  // Generate QR using a public CDN library
  const canvas  = document.getElementById('qrCanvas');
  const ctx     = canvas.getContext('2d');
  const size    = 220;
  canvas.width  = size;
  canvas.height = size;

  // Load QRCode library dynamically if not present
  function drawQR() {
    if (typeof QRCode !== 'undefined') {
      // qrcode-generator style
      const qr = QRCode(0, 'M');
      qr.addData(text);
      qr.make();
      const modules = qr.modules;
      const n       = modules.length;
      const cell    = Math.floor(size / (n + 4));
      const offset  = Math.floor((size - cell * n) / 2);
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, size, size);
      ctx.fillStyle = '#000000';
      for (let row = 0; row < n; row++) {
        for (let col = 0; col < n; col++) {
          if (modules[row][col]) {
            ctx.fillRect(offset + col*cell, offset + row*cell, cell, cell);
          }
        }
      }
      area.style.display = 'block';
      _shareMsg('ğŸ“± Show QR to another device or take a screenshot to share.', 'inf');
    } else {
      _shareMsg('âš  QR library unavailable â€” try another share method.', 'err');
    }
  }

  if (typeof QRCode === 'undefined') {
    const s   = document.createElement('script');
    s.src     = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
    s.onload  = () => {
      // qrcodejs renders into a div, so we use a different approach â€” use qrcode-generator
      const s2  = document.createElement('script');
      s2.src    = 'https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js';
      s2.onload = drawQR;
      s2.onerror = () => _shareMsg('âš  Could not load QR library. Try another method.', 'err');
      document.head.appendChild(s2);
    };
    s.onerror = () => {
      const s2  = document.createElement('script');
      s2.src    = 'https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js';
      s2.onload = drawQR;
      s2.onerror = () => _shareMsg('âš  Could not load QR library. Try another method.', 'err');
      document.head.appendChild(s2);
    };
    document.head.appendChild(s);
  } else {
    drawQR();
  }
}

// â”€â”€â”€ NOTEPAD FUNCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let notepadSaveTimeout = null;

function loadNotepad() {
  const stored = _memStore.getItem('medrecord_daily_notepad');
  if (stored) {
    const data = JSON.parse(stored);
    document.getElementById('dailyNotepad').value = data.content || '';
    updateNotepadTimestamp(data.timestamp);
  }
}

function saveNotepad() {
  const content = document.getElementById('dailyNotepad').value;
  const timestamp = new Date().toISOString();
  
  const data = {
    content: content,
    timestamp: timestamp,
    savedBy: currentUser ? currentUser.name : 'Unknown'
  };
  
  _memStore.setItem('medrecord_daily_notepad', JSON.stringify(data));
  updateNotepadTimestamp(timestamp);
  document.getElementById('notepadStatus').textContent = 'Saved âœ“';
  showToast('âœ“ Notes saved successfully');
  
  // Reset status after 2 seconds
  setTimeout(() => {
    document.getElementById('notepadStatus').textContent = 'Auto-saved';
  }, 2000);
}

function notepadModified() {
  document.getElementById('notepadStatus').textContent = 'Unsaved changes...';
  
  // Auto-save after 3 seconds of inactivity
  clearTimeout(notepadSaveTimeout);
  notepadSaveTimeout = setTimeout(() => {
    saveNotepad();
  }, 3000);
}

function updateNotepadTimestamp(timestamp) {
  if (timestamp) {
    const date = new Date(timestamp);
    const timeStr = date.toLocaleString('en-US', {
      month: 'short',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    });
    document.getElementById('notepadTimestamp').textContent = `Last saved: ${timeStr}`;
  }
}

// â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(s) {
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€â”€ EMR INTEGRATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const HMS_DEFAULT_URL = 'https://na.globalcarehms.com/ords/r/hms_na/f_11310211811810812510212/15?clear=15&session=16811471341665';

// â”€â”€ Parsed data store â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _parsedHMSData = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SMART AUTO-PARSE ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function parseHMSText(text) {
  const result = {
    name: '', emr: '', dob: '', gender: '',
    diagnosis: '', allergies: '', attending: '',
    ward: '', admissionDate: '',
    confidence: {}
  };

  if (!text || text.trim().length < 5) return result;

  const t = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
  const lines = t.split('\n').map(l => l.trim()).filter(Boolean);

  // â”€â”€ EMR Number â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const emrPatterns = [
    /(?:emr|patient\s*(?:no|number|id|#)|mrn|medical\s*record(?:\s*no)?)[:\s#\-]*([A-Z0-9\-\/]+)/i,
    /\b(EMR[-\/]?\d{4}[-\/]?\d{3,6})\b/i,
    /\bIP[-\/]?\d{4,10}\b/i,
    /\bOP[-\/]?\d{4,10}\b/i,
    /\b(MRN[-\s]?\d{5,12})\b/i,
    /\b(\d{6,12})\b(?=.*(?:patient|emr|id))/i
  ];
  for (const p of emrPatterns) {
    const m = t.match(p);
    if (m) {
      result.emr = (m[1] || m[0]).trim().toUpperCase();
      result.confidence.emr = 'high';
      break;
    }
  }

  // â”€â”€ Patient Name â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const namePatterns = [
    /(?:patient\s*(?:name|:)|name\s*:)\s*([A-Z][a-z]+(?:\s+[A-Z][a-z]+){1,4})/i,
    /(?:full\s*name\s*:)\s*(.+?)(?:\n|$)/i,
    /^([A-Z][A-Z\s,]+)$/m  // ALL CAPS name line
  ];
  for (const p of namePatterns) {
    const m = t.match(p);
    if (m && m[1] && m[1].trim().length > 3) {
      // Clean up: remove extra spaces, convert ALL CAPS to Title Case
      let name = m[1].trim();
      if (name === name.toUpperCase()) {
        name = name.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
      }
      // Remove trailing commas/ids
      name = name.replace(/[,;]\s*\w{0,10}$/, '').trim();
      if (name.split(' ').length >= 2) {
        result.name = name;
        result.confidence.name = 'high';
        break;
      }
    }
  }

  // â”€â”€ Date of Birth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const dobPatterns = [
    /(?:d\.?o\.?b|date\s*of\s*birth|birth\s*date|born)[:\s]+(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})/i,
    /(?:d\.?o\.?b|date\s*of\s*birth)[:\s]+(\w+\s+\d{1,2},?\s+\d{4})/i
  ];
  for (const p of dobPatterns) {
    const m = t.match(p);
    if (m) {
      result.dob = normalizeDateForInput(m[1]);
      result.confidence.dob = result.dob ? 'high' : 'low';
      break;
    }
  }

  // â”€â”€ Gender â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const genderM = t.match(/(?:gender|sex|m\/f)[:\s]*(male|female|m\b|f\b|other)/i);
  if (genderM) {
    const g = genderM[1].toLowerCase();
    result.gender = g === 'm' ? 'Male' : g === 'f' ? 'Female' : 
                    g.startsWith('m') ? 'Male' : g.startsWith('f') ? 'Female' : 'Other';
    result.confidence.gender = 'high';
  } else {
    // Try to infer from honorific
    if (/\bMr\.\s+/i.test(t)) { result.gender = 'Male'; result.confidence.gender = 'med'; }
    else if (/\b(?:Mrs\.|Miss|Ms\.)\s+/i.test(t)) { result.gender = 'Female'; result.confidence.gender = 'med'; }
  }

  // â”€â”€ Diagnosis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const diagPatterns = [
    /(?:diagnosis|dx|condition|presenting\s*complaint|principal\s*diagnosis|chief\s*complaint)[:\s]+(.+?)(?=\n(?:[A-Z]|\d)|allerg|medic|ward|$)/is,
    /(?:admit(?:ted)?\s*for|admitted\s*with)[:\s]+(.+?)(?:\n|$)/i
  ];
  for (const p of diagPatterns) {
    const m = t.match(p);
    if (m && m[1] && m[1].trim().length > 2) {
      result.diagnosis = m[1].trim().replace(/\n/g, '; ').substring(0, 300);
      result.confidence.diagnosis = 'high';
      break;
    }
  }

  // â”€â”€ Allergies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const allergyM = t.match(/(?:allerg(?:y|ies)|known\s*allerg[a-z]*|drug\s*allerg[a-z]*)[:\s]+(.+?)(?=\n(?:[A-Z]|\d)|medic|diag|ward|$)/is);
  if (allergyM && allergyM[1].trim().length > 1) {
    result.allergies = allergyM[1].trim().replace(/\n/g, ', ').substring(0, 200);
    result.confidence.allergies = 'high';
  } else if (/no\s*(?:known\s*)?allerg/i.test(t)) {
    result.allergies = 'NKDA (No Known Drug Allergies)';
    result.confidence.allergies = 'high';
  }

  // â”€â”€ Attending Physician â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const drPatterns = [
    /(?:attending|consultant|physician|doctor|dr\.?)[:\s]+(?:Dr\.?\s+)?([A-Z][a-z]+(?:\s+[A-Z][a-z]+){0,3})/i,
    /(?:Dr\.\s+)([A-Z][a-z]+(?:\s+[A-Z][a-z]+){1,3})/
  ];
  for (const p of drPatterns) {
    const m = t.match(p);
    if (m && m[1]) {
      result.attending = ('Dr. ' + m[1].trim()).replace(/^Dr\. Dr\./, 'Dr.');
      result.confidence.attending = 'high';
      break;
    }
  }

  // â”€â”€ Ward â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const wardM = t.match(/(?:ward|bed|unit|room)[:\s#]+([A-Za-z0-9\s\-]+?)(?:\n|,|$)/i);
  if (wardM) {
    const raw = wardM[1].trim();
    const wardMap = {
      'A': 'Ward A', 'B': 'Ward B', 'C': 'Ward C',
      'D': 'Ward D', 'E': 'Ward E', 'F': 'Ward F',
      'G': 'Ward G', 'H': 'Ward H',
      'general': 'Ward A', 'surgical': 'Ward B', 'surg': 'Ward B',
      'paed': 'Ward C', 'peds': 'Ward C', 'cardio': 'Ward D',
      'ortho': 'Ward E', 'icu': 'Ward F', 'matern': 'Ward G', 'oncol': 'Ward H'
    };
    for (const [key, val] of Object.entries(wardMap)) {
      if (raw.toLowerCase().includes(key.toLowerCase())) {
        result.ward = val;
        result.confidence.ward = 'med';
        break;
      }
    }
    if (!result.ward && raw.length < 20) {
      result.ward = raw;
      result.confidence.ward = 'low';
    }
  }

  // â”€â”€ Admission Date â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const admitM = t.match(/(?:admission\s*date|admitted|date\s*of\s*admission|admit(?:ted)?\s*on)[:\s]+(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})/i);
  if (admitM) {
    result.admissionDate = normalizeDateForInput(admitM[1]);
    result.confidence.admissionDate = result.admissionDate ? 'high' : 'low';
  }

  return result;
}

function normalizeDateForInput(dateStr) {
  if (!dateStr) return '';
  // Try parsing common formats â†’ YYYY-MM-DD for input[type=date]
  const cleaned = dateStr.trim().replace(/\./g, '/');
  
  // DD/MM/YYYY or MM/DD/YYYY
  const parts = cleaned.split(/[\/\-]/);
  if (parts.length === 3) {
    let [a, b, c] = parts;
    if (c.length === 4) {
      // Assume DD/MM/YYYY for medical context
      return `${c}-${b.padStart(2,'0')}-${a.padStart(2,'0')}`;
    } else if (a.length === 4) {
      // YYYY-MM-DD already
      return `${a}-${b.padStart(2,'0')}-${c.padStart(2,'0')}`;
    }
  }
  // Try native Date parse
  const d = new Date(dateStr);
  if (!isNaN(d)) {
    return d.toISOString().split('T')[0];
  }
  return '';
}

// â”€â”€ Live parse as user types/pastes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function liveParseHMS() {
  const text = document.getElementById('hmsPasteInput').value;
  if (text.trim().length < 10) {
    document.getElementById('parsePreviewCard').style.display = 'none';
    document.getElementById('hmsPasteApplyBtn').style.display = 'none';
    _parsedHMSData = null;
    return;
  }

  _parsedHMSData = parseHMSText(text);
  renderParsePreview(_parsedHMSData);

  const detected = Object.values(_parsedHMSData.confidence).filter(c => c === 'high' || c === 'med').length;
  document.getElementById('hmsPasteApplyBtn').style.display = detected > 0 ? 'inline-block' : 'none';
}

function renderParsePreview(data) {
  const fields = [
    { key: 'name',          label: 'Patient Name',      value: data.name },
    { key: 'emr',           label: 'EMR Number',        value: data.emr },
    { key: 'dob',           label: 'Date of Birth',     value: data.dob },
    { key: 'gender',        label: 'Gender',            value: data.gender },
    { key: 'diagnosis',     label: 'Diagnosis',         value: data.diagnosis },
    { key: 'allergies',     label: 'Allergies',         value: data.allergies },
    { key: 'attending',     label: 'Attending Dr.',     value: data.attending },
    { key: 'ward',          label: 'Ward',              value: data.ward },
    { key: 'admissionDate', label: 'Admission Date',    value: data.admissionDate },
  ];

  let detected = 0;
  const html = fields.map(f => {
    const conf = data.confidence[f.key];
    const hasValue = f.value && f.value.toString().trim();
    if (hasValue) detected++;

    const confLabel = conf === 'high' ? '<span class="parse-confidence high">âœ“ High</span>' :
                      conf === 'med'  ? '<span class="parse-confidence med">~ Medium</span>' :
                      conf === 'low'  ? '<span class="parse-confidence low">? Low</span>' : '';

    const displayVal = f.key === 'dob' && f.value ? 
      new Date(f.value + 'T00:00:00').toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'}) : 
      (f.value || '');

    return `
      <div class="parse-field-row">
        <span class="parse-field-label">${f.label}</span>
        <span class="parse-field-value ${hasValue ? 'detected' : 'empty'}">${hasValue ? escHtml(displayVal) : 'â€”'}</span>
        ${confLabel}
      </div>`;
  }).join('');

  document.getElementById('parseFieldRows').innerHTML = html;
  document.getElementById('parseStats').textContent = `${detected} of ${fields.length} fields detected from pasted text`;
  document.getElementById('parsePreviewCard').style.display = 'block';
}

// â”€â”€ Apply parsed data to the main patient form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyHMSData() {
  if (!_parsedHMSData) return;
  applyDataToForm(_parsedHMSData);
  closeHMSPasteModal();
  showToast('âœ“ Patient data imported from HMS successfully');
}

function applyManualData() {
  const data = {
    name:          document.getElementById('manualName').value.trim(),
    emr:           document.getElementById('manualEMR').value.trim(),
    dob:           document.getElementById('manualDOB').value,
    gender:        document.getElementById('manualGender').value,
    diagnosis:     document.getElementById('manualDiagnosis').value.trim(),
    allergies:     document.getElementById('manualAllergies').value.trim(),
    attending:     document.getElementById('manualAttending').value.trim(),
    admissionDate: document.getElementById('manualAdmission').value,
    ward:          ''
  };
  applyDataToForm(data);
  closeHMSPasteModal();
  showToast('âœ“ Patient data applied from manual entry');
}

function applySplitData() {
  const data = {
    name:          document.getElementById('splitName').value.trim(),
    emr:           document.getElementById('splitEMR').value.trim(),
    dob:           document.getElementById('splitDOB').value,
    gender:        document.getElementById('splitGender').value,
    diagnosis:     document.getElementById('splitDiagnosis').value.trim(),
    allergies:     document.getElementById('splitAllergies').value.trim(),
    attending:     document.getElementById('splitAttending').value.trim(),
    admissionDate: document.getElementById('splitAdmission').value,
    ward:          document.getElementById('splitWard').value
  };
  applyDataToForm(data);
  closeSplitScreen();
  showToast('âœ“ Patient data applied from split view');
}

function applyDataToForm(data) {
  if (data.name)          { document.getElementById('patientName').value = data.name; }
  if (data.emr)           { document.getElementById('emrNumber').value = data.emr; }
  if (data.dob)           { document.getElementById('dob').value = data.dob; }
  if (data.gender)        { document.getElementById('gender').value = data.gender; }
  if (data.diagnosis)     { document.getElementById('diagnosis').value = data.diagnosis; }
  if (data.allergies)     { document.getElementById('allergies').value = data.allergies; }
  if (data.attending)     { document.getElementById('attending').value = data.attending; }
  if (data.admissionDate) { document.getElementById('admissionDate').value = data.admissionDate; }
  if (data.ward) {
    const wardSel = document.getElementById('patientWard');
    // Match ward select options
    for (const opt of wardSel.options) {
      if (opt.value.toLowerCase().includes(data.ward.toLowerCase().replace('ward ', '')) ||
          opt.value === data.ward) {
        wardSel.value = opt.value;
        break;
      }
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showHMSPasteModal() {
  document.getElementById('hmsPasteModal').classList.remove('hidden');
  // Pre-fill EMR into manual tab if already typed
  const emrVal = document.getElementById('emrNumber').value.trim();
  if (emrVal) document.getElementById('manualEMR').value = emrVal;
  // Reset apply button visibility
  document.getElementById('hmsPasteApplyBtn').style.display = 'none';
  document.getElementById('hmsManualApplyBtn').style.display = 'inline-block';
  // Load saved API settings into API tab
  loadQuickApiSettingsIntoTab();
}

function closeHMSPasteModal() {
  document.getElementById('hmsPasteModal').classList.add('hidden');
}

function switchHMSTab(tab, btn) {
  // Deactivate all
  document.querySelectorAll('.hms-paste-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.hms-tab-panel').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('hmsTab-' + tab).classList.add('active');

  // Show/hide correct apply buttons
  document.getElementById('hmsPasteApplyBtn').style.display   = (tab === 'smart' && _parsedHMSData) ? 'inline-block' : 'none';
  document.getElementById('hmsManualApplyBtn').style.display  = (tab === 'manual') ? 'inline-block' : 'none';
}

function openHMSInNewTab() {
  const url = document.getElementById('splitHmsUrl') ?
              document.getElementById('splitHmsUrl').value.trim() : HMS_DEFAULT_URL;
  window.open(url || HMS_DEFAULT_URL, '_blank', 'noopener,noreferrer');
  showToast('ğŸŒ GlobalCare HMS opened â€” copy patient data then use Smart Paste');
}

// â”€â”€ Split Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSplitScreen() {
  // Pre-fill split form from main form if already has data
  const prefill = {
    name: document.getElementById('patientName').value,
    emr:  document.getElementById('emrNumber').value,
    dob:  document.getElementById('dob').value,
    gender: document.getElementById('gender').value,
    diagnosis: document.getElementById('diagnosis').value,
    allergies: document.getElementById('allergies').value,
    attending: document.getElementById('attending').value,
    admissionDate: document.getElementById('admissionDate').value,
    ward: document.getElementById('patientWard').value
  };
  if (prefill.name) document.getElementById('splitName').value = prefill.name;
  if (prefill.emr)  document.getElementById('splitEMR').value = prefill.emr;
  if (prefill.dob)  document.getElementById('splitDOB').value = prefill.dob;
  if (prefill.gender) document.getElementById('splitGender').value = prefill.gender;
  if (prefill.diagnosis) document.getElementById('splitDiagnosis').value = prefill.diagnosis;
  if (prefill.allergies) document.getElementById('splitAllergies').value = prefill.allergies;
  if (prefill.attending) document.getElementById('splitAttending').value = prefill.attending;
  if (prefill.admissionDate) document.getElementById('splitAdmission').value = prefill.admissionDate;
  if (prefill.ward) document.getElementById('splitWard').value = prefill.ward;

  document.getElementById('splitScreenOverlay').classList.remove('hidden');
}

function closeSplitScreen() {
  document.getElementById('splitScreenOverlay').classList.add('hidden');
}

function clearSplitForm() {
  ['splitName','splitEMR','splitDOB','splitAttending','splitAdmission','splitDiagnosis','splitAllergies'].forEach(id => {
    document.getElementById(id).value = '';
  });
  document.getElementById('splitGender').value = '';
  document.getElementById('splitWard').value = '';
}

function reloadHMSFrame() {
  const url = document.getElementById('splitHmsUrl').value.trim();
  if (url) window.open(url, '_blank', 'noopener,noreferrer');
}

// â”€â”€ Quick API settings in tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleQuickApiAuth() {
  const method = document.getElementById('quickApiAuth').value;
  document.getElementById('quickApiBearer').style.display    = method === 'bearer' ? 'block' : 'none';
  document.getElementById('quickApiKeyFields').style.display = method === 'apikey' ? 'block' : 'none';
  document.getElementById('quickApiBasic').style.display     = method === 'basic'  ? 'block' : 'none';
}

function loadQuickApiSettingsIntoTab() {
  const settings = JSON.parse(_memStore.getItem('medrecord_emr_settings') || '{}');
  if (settings.apiUrl)      document.getElementById('quickApiUrl').value = settings.apiUrl;
  if (settings.authMethod)  document.getElementById('quickApiAuth').value = settings.authMethod;
  if (settings.bearerToken) document.getElementById('quickBearerToken').value = settings.bearerToken;
  if (settings.apiKey)      document.getElementById('quickApiKey').value = settings.apiKey;
  if (settings.apiKeyHeader) document.getElementById('quickApiKeyHeader').value = settings.apiKeyHeader;
  if (settings.username)    document.getElementById('quickApiUsername').value = settings.username;
  if (settings.password)    document.getElementById('quickApiPassword').value = settings.password;
  toggleQuickApiAuth();
}

function saveQuickApiSettings() {
  const settings = {
    apiUrl:       document.getElementById('quickApiUrl').value.trim(),
    authMethod:   document.getElementById('quickApiAuth').value,
    bearerToken:  document.getElementById('quickBearerToken').value.trim(),
    apiKey:       document.getElementById('quickApiKey').value.trim(),
    apiKeyHeader: document.getElementById('quickApiKeyHeader').value.trim() || 'X-API-Key',
    username:     document.getElementById('quickApiUsername').value.trim(),
    password:     document.getElementById('quickApiPassword').value.trim(),
    namePath: 'name', numberPath: 'emr', dobPath: 'dob', genderPath: 'gender',
    diagnosisPath: 'diagnosis', allergiesPath: 'allergies'
  };
  if (!settings.apiUrl) { alert('Please enter the API endpoint URL'); return; }
  _memStore.setItem('medrecord_emr_settings', JSON.stringify(settings));
  showToast('âœ“ API settings saved â€” you can now use API Fetch from the patient form');
}

async function testQuickApiConnection() {
  const resultEl = document.getElementById('quickApiTestResult');
  resultEl.innerHTML = '<span style="color: var(--amber);">â³ Testing...</span>';
  const url = document.getElementById('quickApiUrl').value.trim();
  if (!url) { resultEl.innerHTML = '<span style="color: var(--rose);">âœ— Please enter an API URL</span>'; return; }

  // Build a temporary settings object from the quick tab
  const settings = {
    apiUrl:       url,
    authMethod:   document.getElementById('quickApiAuth').value,
    bearerToken:  document.getElementById('quickBearerToken').value.trim(),
    apiKey:       document.getElementById('quickApiKey').value.trim(),
    apiKeyHeader: document.getElementById('quickApiKeyHeader').value.trim() || 'X-API-Key',
    username:     document.getElementById('quickApiUsername').value.trim(),
    password:     document.getElementById('quickApiPassword').value.trim(),
    namePath: 'name', numberPath: 'emr', dobPath: 'dob', genderPath: 'gender',
    diagnosisPath: 'diagnosis', allergiesPath: 'allergies'
  };

  try {
    const testUrl = url.replace(/\{emr\}/gi, 'TEST-001');
    const headers = { 'Accept': 'application/json' };
    if (settings.authMethod === 'bearer' && settings.bearerToken) {
      headers['Authorization'] = `Bearer ${settings.bearerToken}`;
    } else if (settings.authMethod === 'apikey' && settings.apiKey) {
      headers[settings.apiKeyHeader] = settings.apiKey;
    } else if (settings.authMethod === 'basic' && settings.username) {
      headers['Authorization'] = `Basic ${btoa(settings.username + ':' + settings.password)}`;
    }
    const resp = await fetch(testUrl, { method: 'GET', headers, mode: 'cors' });
    if (resp.ok) {
      resultEl.innerHTML = `<span style="color: var(--success);">âœ“ Connected! (HTTP ${resp.status})</span>`;
    } else {
      resultEl.innerHTML = `<span style="color: var(--amber);">âš  HTTP ${resp.status} â€” check credentials or endpoint</span>`;
    }
  } catch (err) {
    resultEl.innerHTML = `<span style="color: var(--rose);">âœ— ${err.message.length > 60 ? err.message.substring(0, 60) + 'â€¦' : err.message}</span>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXISTING EMR SETTINGS MODAL (preserved & enhanced)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showEMRSettings() {
  document.getElementById('emrSettingsModal').classList.remove('hidden');
  loadEMRSettings();
}

function closeEMRSettings() {
  document.getElementById('emrSettingsModal').classList.add('hidden');
}

function toggleAuthFields() {
  const method = document.getElementById('emrAuthMethod').value;
  document.getElementById('bearerTokenGroup').style.display = method === 'bearer' ? 'block' : 'none';
  document.getElementById('apiKeyGroup').style.display      = method === 'apikey' ? 'block' : 'none';
  document.getElementById('basicAuthGroup').style.display   = method === 'basic'  ? 'block' : 'none';
}

function loadEMRSettings() {
  const settings = JSON.parse(_memStore.getItem('medrecord_emr_settings') || '{}');
  document.getElementById('emrApiUrl').value        = settings.apiUrl || '';
  document.getElementById('emrAuthMethod').value    = settings.authMethod || 'none';
  document.getElementById('emrBearerToken').value   = settings.bearerToken || '';
  document.getElementById('emrApiKey').value        = settings.apiKey || '';
  document.getElementById('emrApiKeyHeader').value  = settings.apiKeyHeader || 'X-API-Key';
  document.getElementById('emrUsername').value      = settings.username || '';
  document.getElementById('emrPassword').value      = settings.password || '';
  document.getElementById('emrNamePath').value      = settings.namePath || 'name';
  document.getElementById('emrNumberPath').value    = settings.numberPath || 'emr';
  document.getElementById('emrDobPath').value       = settings.dobPath || 'dob';
  document.getElementById('emrGenderPath').value    = settings.genderPath || 'gender';
  document.getElementById('emrDiagnosisPath').value = settings.diagnosisPath || 'diagnosis';
  document.getElementById('emrAllergiesPath').value = settings.allergiesPath || 'allergies';
  toggleAuthFields();
}

function saveEMRSettings() {
  const settings = {
    apiUrl:        document.getElementById('emrApiUrl').value.trim(),
    authMethod:    document.getElementById('emrAuthMethod').value,
    bearerToken:   document.getElementById('emrBearerToken').value.trim(),
    apiKey:        document.getElementById('emrApiKey').value.trim(),
    apiKeyHeader:  document.getElementById('emrApiKeyHeader').value.trim(),
    username:      document.getElementById('emrUsername').value.trim(),
    password:      document.getElementById('emrPassword').value.trim(),
    namePath:      document.getElementById('emrNamePath').value.trim(),
    numberPath:    document.getElementById('emrNumberPath').value.trim(),
    dobPath:       document.getElementById('emrDobPath').value.trim(),
    genderPath:    document.getElementById('emrGenderPath').value.trim(),
    diagnosisPath: document.getElementById('emrDiagnosisPath').value.trim(),
    allergiesPath: document.getElementById('emrAllergiesPath').value.trim()
  };
  if (!settings.apiUrl) { alert('Please enter the EMR API endpoint URL'); return; }
  _memStore.setItem('medrecord_emr_settings', JSON.stringify(settings));
  showToast('âœ“ EMR settings saved successfully');
  closeEMRSettings();
}

function getNestedValue(obj, path) {
  return path.split('.').reduce((cur, prop) => cur?.[prop], obj);
}

async function testEMRConnection() {
  const resultDiv = document.getElementById('emrTestResult');
  resultDiv.innerHTML = '<span style="color: var(--amber);">Testing connection...</span>';
  try {
    const data = await fetchPatientFromEMR('TEST-001', true);
    if (data) resultDiv.innerHTML = '<span style="color: var(--success);">âœ“ Connection successful!</span>';
  } catch (error) {
    resultDiv.innerHTML = `<span style="color: var(--rose);">âœ— Connection failed: ${error.message}</span>`;
  }
}

// â”€â”€ API Fetch (original flow, now clearly labelled) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchFromEMR() {
  const emrNumber = document.getElementById('emrNumber').value.trim();
  if (!emrNumber) { alert('Please enter an EMR number first'); return; }

  const settings = JSON.parse(_memStore.getItem('medrecord_emr_settings') || '{}');

  if (!settings.apiUrl) {
    if (confirm(`No API configured.\n\nWould you like to:\nâ€¢ OK â†’ Open GlobalCare HMS in new tab\nâ€¢ Cancel â†’ Configure API credentials`)) {
      openHMSInNewTab();
    } else {
      showEMRSettings();
    }
    return;
  }

  if (settings.apiUrl.includes('globalcarehms.com') || settings.redirectMode) {
    let url = settings.apiUrl.replace(/\{emr\}/gi, emrNumber);
    window.open(url, '_blank', 'noopener,noreferrer');
    showToast(`ğŸŒ HMS opened for patient ${emrNumber} â€” use Smart Paste to import data`);
    return;
  }

  showToast('ğŸ“¡ Fetching patient data from EMR API...');
  try {
    const data = await fetchPatientFromEMR(emrNumber);
    if (data) {
      applyDataToForm({
        name: data.name, emr: data.emr, dob: data.dob, gender: data.gender,
        diagnosis: data.diagnosis, allergies: data.allergies
      });
      showToast('âœ“ Patient data loaded from EMR API');
    } else {
      alert('No patient found with EMR number: ' + emrNumber);
    }
  } catch (error) {
    alert('Error fetching patient data: ' + error.message + '\n\nPlease check EMR Settings or use Smart Paste.');
  }
}

async function fetchPatientFromEMR(emrNumber, isTest = false) {
  const settings = JSON.parse(_memStore.getItem('medrecord_emr_settings') || '{}');
  if (!settings.apiUrl) throw new Error('EMR API URL not configured');

  const url = settings.apiUrl.replace(/\{emr\}/gi, emrNumber);
  const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' };

  if (settings.authMethod === 'bearer' && settings.bearerToken) {
    headers['Authorization'] = `Bearer ${settings.bearerToken}`;
  } else if (settings.authMethod === 'apikey' && settings.apiKey) {
    headers[settings.apiKeyHeader || 'X-API-Key'] = settings.apiKey;
  } else if (settings.authMethod === 'basic' && settings.username && settings.password) {
    headers['Authorization'] = `Basic ${btoa(settings.username + ':' + settings.password)}`;
  }

  const response = await fetch(url, { method: 'GET', headers, mode: 'cors' });
  if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);

  const jsonData = await response.json();
  return {
    name:      getNestedValue(jsonData, settings.namePath      || 'name'),
    emr:       getNestedValue(jsonData, settings.numberPath    || 'emr'),
    dob:       getNestedValue(jsonData, settings.dobPath       || 'dob'),
    gender:    getNestedValue(jsonData, settings.genderPath    || 'gender'),
    diagnosis: getNestedValue(jsonData, settings.diagnosisPath || 'diagnosis'),
    allergies: getNestedValue(jsonData, settings.allergiesPath || 'allergies')
  };
}

// â”€â”€â”€ THEME SWITCHING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTheme() {
  const currentTheme = document.documentElement.getAttribute('data-theme');
  const newTheme = currentTheme === 'light' ? 'dark' : 'light';
  
  setTheme(newTheme);
}

function setTheme(theme) {
  if (theme === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
    updateThemeButtons('â˜€ï¸', 'Light');
  } else {
    document.documentElement.removeAttribute('data-theme');
    updateThemeButtons('ğŸŒ™', 'Dark');
  }
  
  // Save preference
  _memStore.setItem('medrecord_theme', theme);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CARE MANAGEMENT FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ Care History Storage & Display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getCareHistory(patientId) {
  const key = `care_history_${patientId}`;
  return JSON.parse(_memStore.getItem(key) || '[]');
}

function saveCareHistory(patientId, careEntry) {
  const history = getCareHistory(patientId);
  history.unshift(careEntry); // Add to beginning
  _memStore.setItem(`care_history_${patientId}`, JSON.stringify(history));
}

function displayCareHistory() {
  if (!currentPatientId) return;
  
  const history = getCareHistory(currentPatientId);
  const container = document.getElementById('careHistoryDisplay');
  const section = document.getElementById('careHistorySection');
  
  if (history.length === 0) {
    section.style.display = 'none';
    return;
  }
  
  section.style.display = 'block';
  container.innerHTML = history.map(entry => {
    const date = new Date(entry.timestamp);
    const dateStr = date.toLocaleDateString();
    const timeStr = date.toLocaleTimeString();
    
    let contentHTML = '';
    
    if (entry.type === 'vital_signs') {
      contentHTML = `
        <div class="field-row">
          <span class="field-label">Blood Pressure:</span>
          <span class="field-value">${entry.data.bp || 'N/A'} mmHg</span>
        </div>
        <div class="field-row">
          <span class="field-label">Heart Rate:</span>
          <span class="field-value">${entry.data.hr || 'N/A'} bpm</span>
        </div>
        <div class="field-row">
          <span class="field-label">Temperature:</span>
          <span class="field-value">${entry.data.temp || 'N/A'} Â°C</span>
        </div>
        <div class="field-row">
          <span class="field-label">Resp. Rate:</span>
          <span class="field-value">${entry.data.rr || 'N/A'} /min</span>
        </div>
        <div class="field-row">
          <span class="field-label">SpOâ‚‚:</span>
          <span class="field-value">${entry.data.spo2 || 'N/A'} %</span>
        </div>
        ${entry.data.notes ? `<div class="field-row"><span class="field-label">Notes:</span><span class="field-value">${escapeHtml(entry.data.notes)}</span></div>` : ''}
      `;
    } else if (entry.type === 'medication') {
      contentHTML = `
        <div class="field-row">
          <span class="field-label">Drug:</span>
          <span class="field-value">${escapeHtml(entry.data.drug)}</span>
        </div>
        <div class="field-row">
          <span class="field-label">Dosage:</span>
          <span class="field-value">${escapeHtml(entry.data.dosage)}</span>
        </div>
        <div class="field-row">
          <span class="field-label">Route:</span>
          <span class="field-value">${entry.data.route}</span>
        </div>
        <div class="field-row">
          <span class="field-label">Status:</span>
          <span class="field-value">${entry.data.status}</span>
        </div>
        ${entry.data.notes ? `<div class="field-row"><span class="field-label">Notes:</span><span class="field-value">${escapeHtml(entry.data.notes)}</span></div>` : ''}
      `;
    } else if (entry.type === 'glycemic') {
      contentHTML = `
        ${entry.data.fasting ? `<div class="field-row"><span class="field-label">Fasting:</span><span class="field-value">${entry.data.fasting} mmol/L</span></div>` : ''}
        ${entry.data.postBF ? `<div class="field-row"><span class="field-label">Post-Breakfast:</span><span class="field-value">${entry.data.postBF} mmol/L</span></div>` : ''}
        ${entry.data.preLunch ? `<div class="field-row"><span class="field-label">Pre-Lunch:</span><span class="field-value">${entry.data.preLunch} mmol/L</span></div>` : ''}
        ${entry.data.postLunch ? `<div class="field-row"><span class="field-label">Post-Lunch:</span><span class="field-value">${entry.data.postLunch} mmol/L</span></div>` : ''}
        ${entry.data.preDinner ? `<div class="field-row"><span class="field-label">Pre-Dinner:</span><span class="field-value">${entry.data.preDinner} mmol/L</span></div>` : ''}
        ${entry.data.bedtime ? `<div class="field-row"><span class="field-label">Bedtime:</span><span class="field-value">${entry.data.bedtime} mmol/L</span></div>` : ''}
        ${entry.data.notes ? `<div class="field-row"><span class="field-label">Notes:</span><span class="field-value">${escapeHtml(entry.data.notes)}</span></div>` : ''}
      `;
    } else if (entry.type === 'urine_chart') {
      contentHTML = `
        <div class="field-row">
          <span class="field-label">Intake - Oral:</span>
          <span class="field-value">${entry.data.intakeOral || 0} mL</span>
        </div>
        <div class="field-row">
          <span class="field-label">Intake - IV:</span>
          <span class="field-value">${entry.data.intakeIV || 0} mL</span>
        </div>
        <div class="field-row">
          <span class="field-label">Output - Urine:</span>
          <span class="field-value">${entry.data.outputUrine || 0} mL</span>
        </div>
        <div class="field-row">
          <span class="field-label">Output - Other:</span>
          <span class="field-value">${entry.data.outputOther || 0} mL</span>
        </div>
        ${entry.data.notes ? `<div class="field-row"><span class="field-label">Notes:</span><span class="field-value">${escapeHtml(entry.data.notes)}</span></div>` : ''}
      `;
    } else if (entry.type === 'daily_care') {
      contentHTML = `
        <div class="field-row">
          <span class="field-label">Shift:</span>
          <span class="field-value">${entry.data.shift}</span>
        </div>
        ${entry.data.condition ? `<div class="field-row"><span class="field-label">General Condition:</span><span class="field-value">${escapeHtml(entry.data.condition)}</span></div>` : ''}
        ${entry.data.adl ? `<div class="field-row"><span class="field-label">ADL:</span><span class="field-value">${escapeHtml(entry.data.adl)}</span></div>` : ''}
        ${entry.data.diet ? `<div class="field-row"><span class="field-label">Diet:</span><span class="field-value">${escapeHtml(entry.data.diet)}</span></div>` : ''}
        ${entry.data.wounds ? `<div class="field-row"><span class="field-label">Wounds/Skin:</span><span class="field-value">${escapeHtml(entry.data.wounds)}</span></div>` : ''}
        ${entry.data.pain ? `<div class="field-row"><span class="field-label">Pain:</span><span class="field-value">${escapeHtml(entry.data.pain)}</span></div>` : ''}
        ${entry.data.concerns ? `<div class="field-row"><span class="field-label">Concerns:</span><span class="field-value">${escapeHtml(entry.data.concerns)}</span></div>` : ''}
      `;
    }
    
    const typeLabels = {
      'vital_signs': 'ğŸ’“ Vital Signs',
      'medication': 'ğŸ’Š Medication',
      'glycemic': 'ğŸ©¸ Blood Glucose',
      'urine_chart': 'ğŸ’§ Fluid I/O',
      'daily_care': 'ğŸ“‹ Daily Care Report'
    };
    
    return `
      <div class="care-entry">
        <div class="care-entry-header">
          <div class="care-entry-type">${typeLabels[entry.type]}</div>
          <div class="care-entry-date">${dateStr} ${timeStr}</div>
        </div>
        <div class="care-entry-content">
          ${contentHTML}
        </div>
        <div class="care-entry-footer">
          Recorded by: ${escapeHtml(entry.recordedBy)}
        </div>
      </div>
    `;
  }).join('');
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// â”€â”€â”€ Modal Functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Vital Signs Modal
function showVitalSignsModal() {
  if (!currentPatientId) {
    alert('Please select a patient first');
    return;
  }
  const today = new Date().toISOString().split('T')[0];
  const now = new Date().toTimeString().slice(0,5);
  document.getElementById('careVitalDate').value = today;
  document.getElementById('careVitalTime').value = now;
  document.getElementById('careVitalBP').value = '';
  document.getElementById('careVitalHR').value = '';
  document.getElementById('careVitalTemp').value = '';
  document.getElementById('careVitalRR').value = '';
  document.getElementById('careVitalSPO2').value = '';
  document.getElementById('careVitalNotes').value = '';
  document.getElementById('vitalSignsModal').classList.remove('hidden');
}

function closeVitalSignsModal() {
  document.getElementById('vitalSignsModal').classList.add('hidden');
}

function saveCareVitalSigns() {
  if (!currentPatientId) return;
  
  const date = document.getElementById('careVitalDate').value;
  const time = document.getElementById('careVitalTime').value;
  const bp = document.getElementById('careVitalBP').value;
  const hr = document.getElementById('careVitalHR').value;
  const temp = document.getElementById('careVitalTemp').value;
  const rr = document.getElementById('careVitalRR').value;
  const spo2 = document.getElementById('careVitalSPO2').value;
  const notes = document.getElementById('careVitalNotes').value;
  
  if (!date || !time) {
    alert('Please enter date and time');
    return;
  }
  
  const careEntry = {
    type: 'vital_signs',
    timestamp: new Date(`${date}T${time}`).toISOString(),
    data: { bp, hr, temp, rr, spo2, notes },
    recordedBy: currentUser.name
  };
  
  saveCareHistory(currentPatientId, careEntry);
  displayCareHistory();
  closeVitalSignsModal();
  showToast('âœ“ Vital signs recorded successfully');
}

// Medication Modal
function showMedicationModal() {
  if (!currentPatientId) {
    alert('Please select a patient first');
    return;
  }
  const today = new Date().toISOString().split('T')[0];
  const now = new Date().toTimeString().slice(0,5);
  document.getElementById('careMedDate').value = today;
  document.getElementById('careMedTime').value = now;
  document.getElementById('careMedDrug').value = '';
  document.getElementById('careMedDosage').value = '';
  document.getElementById('careMedRoute').value = 'PO';
  document.getElementById('careMedStatus').value = 'Given';
  document.getElementById('careMedNotes').value = '';
  document.getElementById('medicationModal').classList.remove('hidden');
}

function closeMedicationModal() {
  document.getElementById('medicationModal').classList.add('hidden');
}

function saveCareMedication() {
  if (!currentPatientId) return;
  
  const date = document.getElementById('careMedDate').value;
  const time = document.getElementById('careMedTime').value;
  const drug = document.getElementById('careMedDrug').value;
  const dosage = document.getElementById('careMedDosage').value;
  const route = document.getElementById('careMedRoute').value;
  const status = document.getElementById('careMedStatus').value;
  const notes = document.getElementById('careMedNotes').value;
  
  if (!date || !time || !drug || !dosage) {
    alert('Please fill in all required fields');
    return;
  }
  
  const careEntry = {
    type: 'medication',
    timestamp: new Date(`${date}T${time}`).toISOString(),
    data: { drug, dosage, route, status, notes },
    recordedBy: currentUser.name
  };
  
  saveCareHistory(currentPatientId, careEntry);
  displayCareHistory();
  closeMedicationModal();
  showToast('âœ“ Medication recorded successfully');
}

// Glycemic Modal
function showGlycemicModal() {
  if (!currentPatientId) {
    alert('Please select a patient first');
    return;
  }
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('careGlycemicDate').value = today;
  document.getElementById('careGlycemicFasting').value = '';
  document.getElementById('careGlycemicPostBF').value = '';
  document.getElementById('careGlycemicPreLunch').value = '';
  document.getElementById('careGlycemicPostLunch').value = '';
  document.getElementById('careGlycemicPreDinner').value = '';
  document.getElementById('careGlycemicBedtime').value = '';
  document.getElementById('careGlycemicNotes').value = '';
  document.getElementById('glycemicModal').classList.remove('hidden');
}

function closeGlycemicModal() {
  document.getElementById('glycemicModal').classList.add('hidden');
}

function saveCareGlycemic() {
  if (!currentPatientId) return;
  
  const date = document.getElementById('careGlycemicDate').value;
  const fasting = document.getElementById('careGlycemicFasting').value;
  const postBF = document.getElementById('careGlycemicPostBF').value;
  const preLunch = document.getElementById('careGlycemicPreLunch').value;
  const postLunch = document.getElementById('careGlycemicPostLunch').value;
  const preDinner = document.getElementById('careGlycemicPreDinner').value;
  const bedtime = document.getElementById('careGlycemicBedtime').value;
  const notes = document.getElementById('careGlycemicNotes').value;
  
  if (!date) {
    alert('Please enter a date');
    return;
  }
  
  if (!fasting && !postBF && !preLunch && !postLunch && !preDinner && !bedtime) {
    alert('Please enter at least one glucose reading');
    return;
  }
  
  const careEntry = {
    type: 'glycemic',
    timestamp: new Date(date).toISOString(),
    data: { fasting, postBF, preLunch, postLunch, preDinner, bedtime, notes },
    recordedBy: currentUser.name
  };
  
  saveCareHistory(currentPatientId, careEntry);
  displayCareHistory();
  closeGlycemicModal();
  showToast('âœ“ Blood glucose recorded successfully');
}

// Urine Chart Modal
function showUrineChartModal() {
  if (!currentPatientId) {
    alert('Please select a patient first');
    return;
  }
  const today = new Date().toISOString().split('T')[0];
  const now = new Date().toTimeString().slice(0,5);
  document.getElementById('careUrineDate').value = today;
  document.getElementById('careUrineTime').value = now;
  document.getElementById('careUrineIntakeOral').value = '';
  document.getElementById('careUrineIntakeIV').value = '';
  document.getElementById('careUrineOutputUrine').value = '';
  document.getElementById('careUrineOutputOther').value = '';
  document.getElementById('careUrineNotes').value = '';
  document.getElementById('urineChartModal').classList.remove('hidden');
}

function closeUrineChartModal() {
  document.getElementById('urineChartModal').classList.add('hidden');
}

function saveCareUrine() {
  if (!currentPatientId) return;
  
  const date = document.getElementById('careUrineDate').value;
  const time = document.getElementById('careUrineTime').value;
  const intakeOral = document.getElementById('careUrineIntakeOral').value;
  const intakeIV = document.getElementById('careUrineIntakeIV').value;
  const outputUrine = document.getElementById('careUrineOutputUrine').value;
  const outputOther = document.getElementById('careUrineOutputOther').value;
  const notes = document.getElementById('careUrineNotes').value;
  
  if (!date || !time) {
    alert('Please enter date and time');
    return;
  }
  
  const careEntry = {
    type: 'urine_chart',
    timestamp: new Date(`${date}T${time}`).toISOString(),
    data: { intakeOral, intakeIV, outputUrine, outputOther, notes },
    recordedBy: currentUser.name
  };
  
  saveCareHistory(currentPatientId, careEntry);
  displayCareHistory();
  closeUrineChartModal();
  showToast('âœ“ Fluid I/O recorded successfully');
}

// Daily Care Modal
function showDailyCareModal() {
  if (!currentPatientId) {
    alert('Please select a patient first');
    return;
  }
  const today = new Date().toISOString().split('T')[0];
  const hour = new Date().getHours();
  let shift = 'Morning';
  if (hour >= 15 && hour < 23) shift = 'Afternoon';
  else if (hour >= 23 || hour < 7) shift = 'Night';
  
  document.getElementById('careDailyDate').value = today;
  document.getElementById('careDailyShift').value = shift;
  document.getElementById('careDailyCondition').value = '';
  document.getElementById('careDailyADL').value = '';
  document.getElementById('careDailyDiet').value = '';
  document.getElementById('careDailyWounds').value = '';
  document.getElementById('careDailyPain').value = '';
  document.getElementById('careDailyConcerns').value = '';
  document.getElementById('dailyCareModal').classList.remove('hidden');
}

function closeDailyCareModal() {
  document.getElementById('dailyCareModal').classList.add('hidden');
}

function saveCareDailyReport() {
  if (!currentPatientId) return;
  
  const date = document.getElementById('careDailyDate').value;
  const shift = document.getElementById('careDailyShift').value;
  const condition = document.getElementById('careDailyCondition').value;
  const adl = document.getElementById('careDailyADL').value;
  const diet = document.getElementById('careDailyDiet').value;
  const wounds = document.getElementById('careDailyWounds').value;
  const pain = document.getElementById('careDailyPain').value;
  const concerns = document.getElementById('careDailyConcerns').value;
  
  if (!date) {
    alert('Please enter a date');
    return;
  }
  
  const careEntry = {
    type: 'daily_care',
    timestamp: new Date(date).toISOString(),
    data: { shift, condition, adl, diet, wounds, pain, concerns },
    recordedBy: currentUser.name
  };
  
  saveCareHistory(currentPatientId, careEntry);
  displayCareHistory();
  closeDailyCareModal();
  showToast('âœ“ Daily care report saved successfully');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MEDICATION PLAN PAGE FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openMedicationPlanPage() {
  if (!currentPatientId) {
    alert('Please select a patient first');
    return;
  }
  
  const patient = patients[currentPatientId];
  document.getElementById('medPlanPatientName').textContent = patient.name || 'Unknown Patient';
  document.getElementById('medicationPlanPage').classList.remove('hidden');
  
  // Load current medications into the plan page
  loadMedicationPlanTable();
}

function closeMedicationPlanPage() {
  document.getElementById('medicationPlanPage').classList.add('hidden');
}

function saveMedicationPlanAndClose() {
  // Medications are already saved in real-time, just refresh main view and close
  loadPrescribedMedications();
  closeMedicationPlanPage();
  showToast('âœ“ Medication plan saved successfully');
}

function loadMedicationPlanTable() {
  if (!currentPatientId) return;
  
  const patient = patients[currentPatientId];
  const tbody = document.getElementById('medPlanTableBody');
  const emptyState = document.getElementById('medPlanEmpty');
  
  if (!patient.prescribedMedications || patient.prescribedMedications.length === 0) {
    tbody.innerHTML = '';
    emptyState.style.display = 'block';
    return;
  }
  
  emptyState.style.display = 'none';
  
  tbody.innerHTML = patient.prescribedMedications.map((med, idx) => `
    <tr>
      <td><input type="text" value="${escapeHtml(med.drug)}" onchange="updateMedPlanField(${idx}, 'drug', this.value)" style="width: 100%;"></td>
      <td><input type="text" value="${escapeHtml(med.dosage)}" onchange="updateMedPlanField(${idx}, 'dosage', this.value)" style="width: 100%;"></td>
      <td>
        <select onchange="updateMedPlanField(${idx}, 'route', this.value)" style="width: 100%;">
          <option value="PO" ${med.route === 'PO' ? 'selected' : ''}>PO (Oral)</option>
          <option value="IV" ${med.route === 'IV' ? 'selected' : ''}>IV</option>
          <option value="IM" ${med.route === 'IM' ? 'selected' : ''}>IM</option>
          <option value="SC" ${med.route === 'SC' ? 'selected' : ''}>SC</option>
          <option value="Topical" ${med.route === 'Topical' ? 'selected' : ''}>Topical</option>
          <option value="Inhalation" ${med.route === 'Inhalation' ? 'selected' : ''}>Inhalation</option>
          <option value="Other" ${med.route === 'Other' ? 'selected' : ''}>Other</option>
        </select>
      </td>
      <td><input type="text" value="${escapeHtml(med.frequency)}" onchange="updateMedPlanField(${idx}, 'frequency', this.value)" style="width: 100%;"></td>
      <td><input type="date" value="${med.startDate || ''}" onchange="updateMedPlanField(${idx}, 'startDate', this.value)" style="width: 100%;"></td>
      <td><input type="date" value="${med.endDate || ''}" onchange="updateMedPlanField(${idx}, 'endDate', this.value)" style="width: 100%;"></td>
      <td><input type="text" value="${escapeHtml(med.instructions || '')}" onchange="updateMedPlanField(${idx}, 'instructions', this.value)" style="width: 100%;"></td>
      <td>
        <button class="btn btn-danger btn-small" onclick="deleteMedPlanRow(${idx})" title="Delete">ğŸ—‘ï¸</button>
      </td>
    </tr>
  `).join('');
}

function updateMedPlanField(idx, field, value) {
  if (!currentPatientId) return;
  const patient = patients[currentPatientId];
  if (patient.prescribedMedications && patient.prescribedMedications[idx]) {
    patient.prescribedMedications[idx][field] = value;
    saveData();
  }
}

function deleteMedPlanRow(idx) {
  if (!currentPatientId) return;
  if (!confirm('Delete this medication?')) return;
  
  const patient = patients[currentPatientId];
  patient.prescribedMedications.splice(idx, 1);
  saveData();
  loadMedicationPlanTable();
  showToast('âœ“ Medication deleted');
}

function addPrescribedMedRowInPlan() {
  if (!currentPatientId) return;
  
  const patient = patients[currentPatientId];
  if (!patient.prescribedMedications) patient.prescribedMedications = [];
  
  patient.prescribedMedications.push({
    drug: '',
    dosage: '',
    route: 'PO',
    frequency: '',
    startDate: new Date().toISOString().split('T')[0],
    endDate: '',
    instructions: ''
  });
  
  saveData();
  loadMedicationPlanTable();
}

function copyAllToAdminLogFromPlan() {
  if (!currentPatientId) return;
  
  const patient = patients[currentPatientId];
  if (!patient.prescribedMedications || patient.prescribedMedications.length === 0) {
    alert('No medications to copy');
    return;
  }
  
  if (!patient.medications) patient.medications = [];
  
  const today = new Date().toISOString().split('T')[0];
  const now = new Date().toTimeString().slice(0, 5);
  
  let copiedCount = 0;
  patient.prescribedMedications.forEach(med => {
    if (med.drug && med.dosage) {
      patient.medications.push({
        date: today,
        time: now,
        drug: med.drug,
        dosage: med.dosage,
        route: med.route,
        status: 'Given',
        nurse: currentUser.name,
        notes: `Copied from prescribed medications`
      });
      copiedCount++;
    }
  });
  
  saveData();
  showToast(`âœ“ ${copiedCount} medication(s) copied to Administration Log`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MEDICATION ADMINISTRATION LOG PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openMedicationAdminPage() {
  if (!currentPatientId) {
    alert('Please select a patient first');
    return;
  }
  
  const patient = patients[currentPatientId];
  document.getElementById('medAdminPatientName').textContent = patient.name || 'Unknown Patient';
  document.getElementById('medAdminPage').classList.remove('hidden');
  loadMedAdminPageTable();
}

function closeMedAdminPage() {
  document.getElementById('medAdminPage').classList.add('hidden');
}

function saveMedAdminAndClose() {
  renderMedicationTable();
  closeMedAdminPage();
  showToast('âœ“ Administration log saved successfully');
}

function loadMedAdminPageTable() {
  if (!currentPatientId) return;
  
  const patient = patients[currentPatientId];
  if (!patient.medications) patient.medications = [];
  
  const tbody = document.getElementById('medAdminPageTableBody');
  const emptyState = document.getElementById('medAdminPageEmpty');
  
  if (patient.medications.length === 0) {
    tbody.innerHTML = '';
    emptyState.style.display = 'block';
    return;
  }
  
  emptyState.style.display = 'none';
  
  // Get prescribed medications for dropdown
  const prescribedMeds = patient.prescribedMedications || [];
  
  tbody.innerHTML = patient.medications.map((med, idx) => {
    // Build prescription dropdown options
    let prescriptionOptions = '<option value="">-- Select from Prescription --</option>';
    prescribedMeds.forEach((pm, pmIdx) => {
      if (pm.drug) {
        const label = `${pm.drug} - ${pm.dosage || ''} ${pm.route || ''}`.trim();
        prescriptionOptions += `<option value="${pmIdx}">${escapeHtml(label)}</option>`;
      }
    });
    
    return `
    <tr>
      <td><input type="date" value="${med.date || ''}" onchange="updateMedAdminField(${idx}, 'date', this.value)" style="width: 100%;"></td>
      <td><input type="time" value="${med.time || ''}" onchange="updateMedAdminField(${idx}, 'time', this.value)" style="width: 100%;"></td>
      <td>
        <select onchange="fillFromPrescription(${idx}, this.value)" style="width: 100%; font-size: 0.85rem;">
          ${prescriptionOptions}
        </select>
      </td>
      <td><input type="text" value="${escapeHtml(med.drug || '')}" onchange="updateMedAdminField(${idx}, 'drug', this.value)" style="width: 100%;" placeholder="Drug name"></td>
      <td><input type="text" value="${escapeHtml(med.dosage || '')}" onchange="updateMedAdminField(${idx}, 'dosage', this.value)" style="width: 100%;" placeholder="Dosage"></td>
      <td>
        <select onchange="updateMedAdminField(${idx}, 'route', this.value)" style="width: 100%;">
          <option value="PO" ${med.route === 'PO' ? 'selected' : ''}>PO</option>
          <option value="IV" ${med.route === 'IV' ? 'selected' : ''}>IV</option>
          <option value="IM" ${med.route === 'IM' ? 'selected' : ''}>IM</option>
          <option value="SC" ${med.route === 'SC' ? 'selected' : ''}>SC</option>
          <option value="Topical" ${med.route === 'Topical' ? 'selected' : ''}>Topical</option>
          <option value="Inhalation" ${med.route === 'Inhalation' ? 'selected' : ''}>Inhalation</option>
        </select>
      </td>
      <td>
        <select onchange="updateMedAdminField(${idx}, 'status', this.value)" style="width: 100%;">
          <option value="Given" ${med.status === 'Given' ? 'selected' : ''}>Given</option>
          <option value="Missed" ${med.status === 'Missed' ? 'selected' : ''}>Missed</option>
          <option value="Refused" ${med.status === 'Refused' ? 'selected' : ''}>Refused</option>
          <option value="Held" ${med.status === 'Held' ? 'selected' : ''}>Held</option>
        </select>
      </td>
      <td><input type="text" value="${escapeHtml(med.nurse || '')}" onchange="updateMedAdminField(${idx}, 'nurse', this.value)" style="width: 100%;" placeholder="Nurse"></td>
      <td><input type="text" value="${escapeHtml(med.notes || '')}" onchange="updateMedAdminField(${idx}, 'notes', this.value)" style="width: 100%;" placeholder="Notes"></td>
      <td>
        <button class="btn btn-danger btn-small" onclick="deleteMedAdminRow(${idx})" title="Delete">ğŸ—‘ï¸</button>
      </td>
    </tr>
  `}).join('');
}

function updateMedAdminField(idx, field, value) {
  if (!currentPatientId) return;
  const patient = patients[currentPatientId];
  if (patient.medications && patient.medications[idx]) {
    patient.medications[idx][field] = value;
    saveData();
  }
}

function fillFromPrescription(medAdminIdx, prescriptionIdx) {
  if (!currentPatientId) return;
  if (prescriptionIdx === '') return; // User selected the placeholder option
  
  const patient = patients[currentPatientId];
  const prescribedMeds = patient.prescribedMedications || [];
  const prescriptionIdx_num = parseInt(prescriptionIdx);
  
  if (!prescribedMeds[prescriptionIdx_num]) return;
  
  const prescribed = prescribedMeds[prescriptionIdx_num];
  
  // Auto-fill the medication administration record with prescription data
  if (patient.medications && patient.medications[medAdminIdx]) {
    patient.medications[medAdminIdx].drug = prescribed.drug || '';
    patient.medications[medAdminIdx].dosage = prescribed.dosage || '';
    patient.medications[medAdminIdx].route = prescribed.route || 'PO';
    
    saveData();
    loadMedAdminPageTable(); // Reload to show updated values
    showToast('âœ“ Filled from prescription: ' + prescribed.drug);
  }
}

function deleteMedAdminRow(idx) {
  if (!currentPatientId) return;
  if (!confirm('Delete this entry?')) return;
  
  const patient = patients[currentPatientId];
  patient.medications.splice(idx, 1);
  saveData();
  loadMedAdminPageTable();
  showToast('âœ“ Entry deleted');
}

function addMedicationRowInPage() {
  if (!currentPatientId) return;
  
  const patient = patients[currentPatientId];
  if (!patient.medications) patient.medications = [];
  
  const today = new Date().toISOString().split('T')[0];
  const now = new Date().toTimeString().slice(0, 5);
  
  patient.medications.push({
    date: today,
    time: now,
    drug: '',
    dosage: '',
    route: 'PO',
    status: 'Given',
    nurse: currentUser.name,
    notes: ''
  });
  
  saveData();
  loadMedAdminPageTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GLUCOSE MONITORING PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openGlucoseMonitoringPage() {
  if (!currentPatientId) {
    alert('Please select a patient first');
    return;
  }
  
  const patient = patients[currentPatientId];
  document.getElementById('glucosePatientName').textContent = patient.name || 'Unknown Patient';
  document.getElementById('glucosePage').classList.remove('hidden');
  loadGlucosePageTable();
}

function closeGlucosePage() {
  document.getElementById('glucosePage').classList.add('hidden');
}

function saveGlucoseAndClose() {
  renderGlycemicTable();
  closeGlucosePage();
  showToast('âœ“ Glucose readings saved successfully');
}

function loadGlucosePageTable() {
  if (!currentPatientId) return;
  
  const patient = patients[currentPatientId];
  if (!patient.glycemicLog) patient.glycemicLog = [];
  
  const tbody = document.getElementById('glucosePageTableBody');
  const emptyState = document.getElementById('glucosePageEmpty');
  
  if (patient.glycemicLog.length === 0) {
    tbody.innerHTML = '';
    emptyState.style.display = 'block';
    return;
  }
  
  emptyState.style.display = 'none';
  
  tbody.innerHTML = patient.glycemicLog.map((row, idx) => `
    <tr>
      <td><input type="date" value="${row.date || ''}" onchange="updateGlucoseField(${idx}, 'date', this.value)" style="width: 100%;"></td>
      <td><input type="number" step="0.1" value="${row.fasting || ''}" onchange="updateGlucoseField(${idx}, 'fasting', this.value)" style="width: 100%;" placeholder="â€”"></td>
      <td><input type="number" step="0.1" value="${row.postBreakfast || ''}" onchange="updateGlucoseField(${idx}, 'postBreakfast', this.value)" style="width: 100%;" placeholder="â€”"></td>
      <td><input type="number" step="0.1" value="${row.preLunch || ''}" onchange="updateGlucoseField(${idx}, 'preLunch', this.value)" style="width: 100%;" placeholder="â€”"></td>
      <td><input type="number" step="0.1" value="${row.postLunch || ''}" onchange="updateGlucoseField(${idx}, 'postLunch', this.value)" style="width: 100%;" placeholder="â€”"></td>
      <td><input type="number" step="0.1" value="${row.preDinner || ''}" onchange="updateGlucoseField(${idx}, 'preDinner', this.value)" style="width: 100%;" placeholder="â€”"></td>
      <td><input type="number" step="0.1" value="${row.bedtime || ''}" onchange="updateGlucoseField(${idx}, 'bedtime', this.value)" style="width: 100%;" placeholder="â€”"></td>
      <td><input type="text" value="${escapeHtml(row.nurse || '')}" onchange="updateGlucoseField(${idx}, 'nurse', this.value)" style="width: 100%;" placeholder="Nurse"></td>
      <td>
        <button class="btn btn-danger btn-small" onclick="deleteGlucoseRow(${idx})" title="Delete">ğŸ—‘ï¸</button>
      </td>
    </tr>
  `).join('');
}

function updateGlucoseField(idx, field, value) {
  if (!currentPatientId) return;
  const patient = patients[currentPatientId];
  if (patient.glycemicLog && patient.glycemicLog[idx]) {
    patient.glycemicLog[idx][field] = value;
    saveData();
  }
}

function deleteGlucoseRow(idx) {
  if (!currentPatientId) return;
  if (!confirm('Delete this glucose reading?')) return;
  
  const patient = patients[currentPatientId];
  patient.glycemicLog.splice(idx, 1);
  saveData();
  loadGlucosePageTable();
  showToast('âœ“ Reading deleted');
}

function addGlycemicRowInPage() {
  if (!currentPatientId) return;
  
  const patient = patients[currentPatientId];
  if (!patient.glycemicLog) patient.glycemicLog = [];
  
  const today = new Date().toISOString().split('T')[0];
  
  patient.glycemicLog.push({
    date: today,
    fasting: '',
    postBreakfast: '',
    preLunch: '',
    postLunch: '',
    preDinner: '',
    bedtime: '',
    nurse: currentUser.name
  });
  
  saveData();
  loadGlucosePageTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FLUID CHART PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openFluidChartPage() {
  if (!currentPatientId) {
    alert('Please select a patient first');
    return;
  }
  
  const patient = patients[currentPatientId];
  document.getElementById('fluidPatientName').textContent = patient.name || 'Unknown Patient';
  document.getElementById('fluidChartPage').classList.remove('hidden');
  loadFluidPageTable();
  calculateFluidBalancePage();
}

function closeFluidChartPage() {
  document.getElementById('fluidChartPage').classList.add('hidden');
}

function saveFluidChartAndClose() {
  renderFluidTable();
  calculateFluidBalance();
  closeFluidChartPage();
  showToast('âœ“ Fluid chart saved successfully');
}

function loadFluidPageTable() {
  if (!currentPatientId) return;
  
  const patient = patients[currentPatientId];
  if (!patient.fluidLog) patient.fluidLog = [];
  
  const tbody = document.getElementById('fluidPageTableBody');
  const emptyState = document.getElementById('fluidPageEmpty');
  
  if (patient.fluidLog.length === 0) {
    tbody.innerHTML = '';
    emptyState.style.display = 'block';
    return;
  }
  
  emptyState.style.display = 'none';
  
  tbody.innerHTML = patient.fluidLog.map((row, idx) => `
    <tr>
      <td><input type="date" value="${row.date || ''}" onchange="updateFluidField(${idx}, 'date', this.value); calculateFluidBalancePage();" style="width: 100%;"></td>
      <td><input type="time" value="${row.time || ''}" onchange="updateFluidField(${idx}, 'time', this.value)" style="width: 100%;"></td>
      <td>
        <select onchange="updateFluidField(${idx}, 'type', this.value)" style="width: 100%;">
          <option value="Intake" ${row.type === 'Intake' ? 'selected' : ''}>Intake</option>
          <option value="Output" ${row.type === 'Output' ? 'selected' : ''}>Output</option>
        </select>
      </td>
      <td><input type="number" value="${row.intakeOral || ''}" onchange="updateFluidField(${idx}, 'intakeOral', this.value); calculateFluidBalancePage();" style="width: 100%;" placeholder="0"></td>
      <td><input type="number" value="${row.intakeIV || ''}" onchange="updateFluidField(${idx}, 'intakeIV', this.value); calculateFluidBalancePage();" style="width: 100%;" placeholder="0"></td>
      <td><input type="number" value="${row.outputUrine || ''}" onchange="updateFluidField(${idx}, 'outputUrine', this.value); calculateFluidBalancePage();" style="width: 100%;" placeholder="0"></td>
      <td><input type="number" value="${row.outputOther || ''}" onchange="updateFluidField(${idx}, 'outputOther', this.value); calculateFluidBalancePage();" style="width: 100%;" placeholder="0"></td>
      <td><input type="text" value="${escapeHtml(row.notes || '')}" onchange="updateFluidField(${idx}, 'notes', this.value)" style="width: 100%;" placeholder="Notes"></td>
      <td><input type="text" value="${escapeHtml(row.nurse || '')}" onchange="updateFluidField(${idx}, 'nurse', this.value)" style="width: 100%;" placeholder="Nurse"></td>
      <td>
        <button class="btn btn-danger btn-small" onclick="deleteFluidRow(${idx})" title="Delete">ğŸ—‘ï¸</button>
      </td>
    </tr>
  `).join('');
}

function updateFluidField(idx, field, value) {
  if (!currentPatientId) return;
  const patient = patients[currentPatientId];
  if (patient.fluidLog && patient.fluidLog[idx]) {
    patient.fluidLog[idx][field] = value;
    saveData();
  }
}

function deleteFluidRow(idx) {
  if (!currentPatientId) return;
  if (!confirm('Delete this fluid entry?')) return;
  
  const patient = patients[currentPatientId];
  patient.fluidLog.splice(idx, 1);
  saveData();
  loadFluidPageTable();
  calculateFluidBalancePage();
  showToast('âœ“ Entry deleted');
}

function addFluidRowInPage() {
  if (!currentPatientId) return;
  
  const patient = patients[currentPatientId];
  if (!patient.fluidLog) patient.fluidLog = [];
  
  const today = new Date().toISOString().split('T')[0];
  const now = new Date().toTimeString().slice(0, 5);
  
  patient.fluidLog.push({
    date: today,
    time: now,
    type: 'Intake',
    intakeOral: '',
    intakeIV: '',
    outputUrine: '',
    outputOther: '',
    notes: '',
    nurse: currentUser.name
  });
  
  saveData();
  loadFluidPageTable();
}

function calculateFluidBalancePage() {
  if (!currentPatientId) return;
  
  const patient = patients[currentPatientId];
  if (!patient.fluidLog) return;
  
  const today = new Date().toISOString().split('T')[0];
  
  let totalIntake = 0;
  let totalOutput = 0;
  
  patient.fluidLog.forEach(row => {
    if (row.date === today) {
      totalIntake += (parseFloat(row.intakeOral) || 0) + (parseFloat(row.intakeIV) || 0);
      totalOutput += (parseFloat(row.outputUrine) || 0) + (parseFloat(row.outputOther) || 0);
    }
  });
  
  const balance = totalIntake - totalOutput;
  
  document.getElementById('totalIntakePage').innerHTML = `${totalIntake}<span class="vital-unit">mL</span>`;
  document.getElementById('totalOutputPage').innerHTML = `${totalOutput}<span class="vital-unit">mL</span>`;
  document.getElementById('fluidBalancePage').innerHTML = `${balance >= 0 ? '+' : ''}${balance}<span class="vital-unit">mL</span>`;
  
  const balanceCard = document.getElementById('fluidBalanceCardPage');
  if (balance > 0) {
    balanceCard.style.background = 'rgba(45,212,191,0.1)';
  } else if (balance < 0) {
    balanceCard.style.background = 'rgba(244,63,94,0.1)';
  } else {
    balanceCard.style.background = 'var(--card)';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VITALS MONITORING PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openVitalsMonitoringPage() {
  if (!activeId) {
    alert('Please select a patient first');
    return;
  }
  const patient = patients[activeId];
  document.getElementById('vitalsPagePatientName').textContent = patient.name || 'Unknown Patient';
  document.getElementById('vitalsMonitoringPage').classList.remove('hidden');
  loadVitalsPageTable();
  updateVitalsPageSummary();
}

function closeVitalsMonitoringPage() {
  document.getElementById('vitalsMonitoringPage').classList.add('hidden');
}

function saveVitalsPageAndClose() {
  renderVitalsTable();
  updateLatestVitals();
  closeVitalsMonitoringPage();
  showToast('âœ“ Vitals log saved successfully');
}

function loadVitalsPageTable() {
  if (!activeId) return;
  const patient = patients[activeId];
  if (!patient.vitals) patient.vitals = [];

  const tbody = document.getElementById('vitalsPageTableBody');
  const emptyState = document.getElementById('vitalsPageEmpty');

  if (patient.vitals.length === 0) {
    tbody.innerHTML = '';
    emptyState.style.display = 'block';
    return;
  }

  emptyState.style.display = 'none';

  tbody.innerHTML = patient.vitals.map((row, idx) => {
    const hrAbnormal = row.hr && (parseFloat(row.hr) < 60 || parseFloat(row.hr) > 100);
    const tempAbnormal = row.temp && (parseFloat(row.temp) < 36.1 || parseFloat(row.temp) > 37.2);
    const rrAbnormal = row.rr && (parseFloat(row.rr) < 12 || parseFloat(row.rr) > 20);
    const spo2Abnormal = row.spo2 && parseFloat(row.spo2) < 95;
    return `
      <tr>
        <td><input type="date" value="${row.date || ''}" onchange="updateVitalsPageField(${idx}, 'date', this.value)" style="width: 100%;"></td>
        <td><input type="time" value="${row.time || ''}" onchange="updateVitalsPageField(${idx}, 'time', this.value)" style="width: 100%;"></td>
        <td><input type="text" value="${escHtml(row.bp || '')}" placeholder="120/80" onchange="updateVitalsPageField(${idx}, 'bp', this.value)" style="width: 100%;"></td>
        <td class="${hrAbnormal ? (parseFloat(row.hr) < 60 ? 'abnormal-low' : 'abnormal-high') : ''}">
          <input type="number" value="${row.hr || ''}" placeholder="70" oninput="updateVitalsPageField(${idx}, 'hr', this.value); refreshVitalsPageRow(${idx});" style="width: 100%;"></td>
        <td class="${tempAbnormal ? (parseFloat(row.temp) < 36.1 ? 'abnormal-low' : 'abnormal-high') : ''}">
          <input type="number" step="0.1" value="${row.temp || ''}" placeholder="36.5" oninput="updateVitalsPageField(${idx}, 'temp', this.value); refreshVitalsPageRow(${idx});" style="width: 100%;"></td>
        <td class="${rrAbnormal ? (parseFloat(row.rr) < 12 ? 'abnormal-low' : 'abnormal-high') : ''}">
          <input type="number" value="${row.rr || ''}" placeholder="16" oninput="updateVitalsPageField(${idx}, 'rr', this.value); refreshVitalsPageRow(${idx});" style="width: 100%;"></td>
        <td class="${spo2Abnormal ? 'abnormal-low' : ''}">
          <input type="number" value="${row.spo2 || ''}" placeholder="98" oninput="updateVitalsPageField(${idx}, 'spo2', this.value); refreshVitalsPageRow(${idx});" style="width: 100%;"></td>
        <td><input type="text" value="${escHtml(row.recorder || '')}" placeholder="Nurse" onchange="updateVitalsPageField(${idx}, 'recorder', this.value)" style="width: 100%;"></td>
        <td>
          <button class="btn btn-danger btn-small" onclick="deleteVitalsPageRow(${idx})" title="Delete">ğŸ—‘ï¸</button>
        </td>
      </tr>
    `;
  }).join('');
}

function updateVitalsPageField(idx, field, value) {
  if (!activeId) return;
  const patient = patients[activeId];
  if (!patient.vitals || !patient.vitals[idx]) return;
  patient.vitals[idx][field] = value;
  saveData();
  updateVitalsPageSummary();
}

function refreshVitalsPageRow(idx) {
  // Re-render just the abnormal class states by reloading the table
  loadVitalsPageTable();
  updateVitalsPageSummary();
}

function deleteVitalsPageRow(idx) {
  if (!activeId) return;
  if (!confirm('Delete this vitals entry?')) return;
  const patient = patients[activeId];
  patient.vitals.splice(idx, 1);
  saveData();
  loadVitalsPageTable();
  updateVitalsPageSummary();
  showToast('âœ“ Vitals entry deleted');
}

function addVitalsRowInPage() {
  if (!activeId) return;
  const patient = patients[activeId];
  if (!patient.vitals) patient.vitals = [];

  const today = new Date().toISOString().split('T')[0];
  const now = new Date().toTimeString().slice(0, 5);

  patient.vitals.push({
    date: today,
    time: now,
    bp: '',
    hr: '',
    temp: '',
    rr: '',
    spo2: '',
    recorder: currentUser ? currentUser.name : ''
  });

  saveData();
  loadVitalsPageTable();
  updateVitalsPageSummary();
}

function updateVitalsPageSummary() {
  if (!activeId) return;
  const patient = patients[activeId];
  if (!patient.vitals || patient.vitals.length === 0) return;

  const latest = patient.vitals[patient.vitals.length - 1];

  const setCard = (cardId, valId, value, unit, low, high) => {
    const card = document.getElementById(cardId);
    const el = document.getElementById(valId);
    if (!card || !el) return;
    if (!value) { el.innerHTML = `â€”<span class="vital-unit">${unit}</span>`; card.className = 'vital-card'; return; }
    el.innerHTML = `${value}<span class="vital-unit">${unit}</span>`;
    const num = parseFloat(value);
    if (!isNaN(num)) {
      if (num < low) card.className = 'vital-card alert-low';
      else if (num > high) card.className = 'vital-card alert-high';
      else card.className = 'vital-card alert-ok';
    }
  };

  const bpCard = document.getElementById('vitalsPageBP');
  const bpEl = document.getElementById('vitalsPageBPVal');
  if (bpCard && bpEl) {
    bpEl.innerHTML = latest.bp ? `${latest.bp}<span class="vital-unit">mmHg</span>` : `â€”<span class="vital-unit">mmHg</span>`;
    bpCard.className = latest.bp ? 'vital-card alert-ok' : 'vital-card';
  }

  setCard('vitalsPageHR',   'vitalsPageHRVal',   latest.hr,   'bpm',  60,   100);
  setCard('vitalsPageTemp', 'vitalsPageTempVal', latest.temp, 'Â°C',   36.1, 37.2);
  setCard('vitalsPageRR',   'vitalsPageRRVal',   latest.rr,   '/min', 12,   20);
  setCard('vitalsPageSPO2', 'vitalsPageSPO2Val', latest.spo2, '%',    95,   100);
}

// â”€â”€â”€ GC TAB SWITCHING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchGCTab(tabName, btnEl) {
  // Deactivate all tabs and panels
  document.querySelectorAll('.gc-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.gc-tab-panel').forEach(p => p.classList.remove('active'));

  // Activate selected
  if (btnEl) btnEl.classList.add('active');
  const panel = document.getElementById('gc-panel-' + tabName);
  if (panel) panel.classList.add('active');
}

// â”€â”€â”€ UPDATE GC HEADER FIELDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateGCHeader(p) {
  if (!p) return;

  // Name
  const nameEl = document.getElementById('patientDisplayName');
  if (nameEl) nameEl.textContent = p.name || 'Patient Name';

  // Meta line: gender Â· age from DOB
  const metaEl = document.getElementById('patientDisplayMeta');
  if (metaEl) {
    let meta = '';
    if (p.gender) meta += p.gender;
    if (p.dob) {
      const age = ((Date.now() - new Date(p.dob)) / (365.25 * 24 * 3600 * 1000)).toFixed(1);
      meta += (meta ? ' Â· ' : '') + 'born ' + age + ' years ago';
    }
    metaEl.textContent = meta || 'â€”';
  }

  // Badges
  const emrEl = document.getElementById('patientDisplayEMR');
  if (emrEl) emrEl.textContent = p.emr || 'EMR â€”';

  const wardEl = document.getElementById('patientDisplayWard');
  if (wardEl) wardEl.textContent = p.ward || p.patientWard || 'â€”';

  const statusEl = document.getElementById('patientDisplayStatus');
  if (statusEl) {
    const s = p.status || 'active';
    statusEl.textContent = s.charAt(0).toUpperCase() + s.slice(1);
    statusEl.style.background = s === 'discharged' ? 'rgba(148,163,184,0.15)' :
                                  s === 'transferred' ? 'rgba(6,182,212,0.15)' :
                                  'rgba(16,185,129,0.15)';
    statusEl.style.color = s === 'discharged' ? 'var(--muted)' :
                            s === 'transferred' ? '#06b6d4' :
                            'var(--success)';
  }

  // Attending
  const attEl = document.getElementById('patientDisplayAttending');
  if (attEl) attEl.textContent = p.attending || 'â€”';

  // Admission date
  const admEl = document.getElementById('patientDisplayAdmission');
  if (admEl) admEl.textContent = p.admissionDate || 'â€”';
}

function updateThemeButtons(icon, text) {
  // Update all theme toggle buttons (there are multiple in different views)
  const icons = ['themeIcon', 'themeIcon2', 'themeIcon3'];
  const texts = ['themeText', 'themeText2', 'themeText3'];
  
  icons.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = icon;
  });
  
  texts.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = text;
  });
}

function loadTheme() {
  const savedTheme = _memStore.getItem('medrecord_theme') || 'dark';
  setTheme(savedTheme);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NURSING REPORT PANEL TOGGLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function toggleNursingPanel(panelId, btn) {
  const panel = document.getElementById(panelId);
  if (!panel) return;
  const isOpen = panel.style.display !== 'none';
  if (isOpen) {
    panel.style.display = 'none';
    // reset button arrow
    const arrow = btn.querySelector('span:last-child');
    if (arrow) arrow.textContent = 'â–¼';
    btn.style.opacity = '1';
  } else {
    panel.style.display = 'block';
    // animate open
    panel.style.opacity = '0';
    panel.style.transform = 'translateY(-6px)';
    panel.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
    requestAnimationFrame(() => {
      panel.style.opacity = '1';
      panel.style.transform = 'translateY(0)';
    });
    // update button arrow
    const arrow = btn.querySelector('span:last-child');
    if (arrow) arrow.textContent = 'â–²';
    btn.style.opacity = '0.75';
    // scroll panel into view smoothly
    setTimeout(() => panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 50);
  }
}

function closeNursingPanel(panelId) {
  const panel = document.getElementById(panelId);
  if (!panel) return;
  panel.style.transition = 'opacity 0.15s ease, transform 0.15s ease';
  panel.style.opacity = '0';
  panel.style.transform = 'translateY(-4px)';
  setTimeout(() => {
    panel.style.display = 'none';
    panel.style.opacity = '';
    panel.style.transform = '';
    // reset the matching toggle button arrow
    const btnMap = {
      'panel_ward_stat': 'ğŸ“Š',
      'panel_patient_details': 'ğŸ“‹',
      'panel_nursing_entries': 'ğŸ“',
      'panel_blood_transfusion': 'ğŸ©¸'
    };
    // find the button that toggles this panel and reset its arrow
    document.querySelectorAll('button[onclick*="' + panelId + '"]').forEach(btn => {
      const arrow = btn.querySelector('span:last-child');
      if (arrow) arrow.textContent = 'â–¼';
      btn.style.opacity = '1';
    });
  }, 150);
}

// â”€â”€â”€ BLOOD TRANSFUSION RECORDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function addBloodTransfusionEntry() {
  if (!activeId) { alert('Please select a patient first.'); return; }
  const patient = patients[activeId];
  if (!patient.bloodTransfusions) patient.bloodTransfusions = [];
  patient.bloodTransfusions.push({
    bagNumber: '', bloodGroup: '',
    startTime: '', endTime: '',
    preVitals: { bp: '', hr: '', temp: '', rr: '', spo2: '' },
    postVitals: { bp: '', hr: '', temp: '', rr: '', spo2: '' },
    nurse: '', notes: ''
  });
  saveData();
  renderBloodTransfusions();
}

function deleteBloodTransfusionEntry(idx) {
  if (!activeId) return;
  if (!confirm('Delete this transfusion record?')) return;
  const patient = patients[activeId];
  patient.bloodTransfusions.splice(idx, 1);
  saveData();
  renderBloodTransfusions();
  showToast('âœ“ Transfusion record deleted');
}

function updateBTField(idx, path, value) {
  if (!activeId) return;
  const patient = patients[activeId];
  if (!patient.bloodTransfusions || !patient.bloodTransfusions[idx]) return;
  const parts = path.split('.');
  let obj = patient.bloodTransfusions[idx];
  for (let i = 0; i < parts.length - 1; i++) obj = obj[parts[i]];
  obj[parts[parts.length - 1]] = value;
  saveData();
}

function renderBloodTransfusions() {
  const container = document.getElementById('bloodTransfusionContainer');
  if (!container) return;
  if (!activeId) { container.innerHTML = ''; return; }
  const patient = patients[activeId];
  const transfusions = patient.bloodTransfusions || [];

  if (transfusions.length === 0) {
    container.innerHTML = `<div style="color: var(--muted); font-size: 0.85rem; padding: 0.8rem 0;">No blood transfusion records yet.</div>`;
    return;
  }

  container.innerHTML = transfusions.map((t, i) => `
    <div style="background: var(--deep); border: 1px solid rgba(244,63,94,0.25); border-radius: 10px; padding: 1.2rem; margin-bottom: 1rem; position: relative;">
      <div style="position: absolute; top: 0.8rem; right: 0.8rem;">
        <button class="btn btn-danger btn-small" onclick="deleteBloodTransfusionEntry(${i})" title="Delete">ğŸ—‘ï¸ Delete</button>
      </div>
      <div style="font-weight: 700; color: #f43f5e; font-size: 0.85rem; margin-bottom: 1rem; letter-spacing: 0.08em; text-transform: uppercase;">ğŸ©¸ Transfusion Record #${i + 1}</div>

      <!-- Blood Bag Parameters -->
      <div style="font-size: 0.78rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.6rem;">Blood Bag Parameters</div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.8rem; margin-bottom: 1rem;">
        <div>
          <label style="display: block; font-size: 0.72rem; color: var(--muted); margin-bottom: 0.3rem;">Blood Bag Number</label>
          <input type="text" value="${escHtml(t.bagNumber || '')}" placeholder="e.g. BB-2024-001" oninput="updateBTField(${i}, 'bagNumber', this.value)" style="width:100%;">
        </div>
        <div>
          <label style="display: block; font-size: 0.72rem; color: var(--muted); margin-bottom: 0.3rem;">Blood Group</label>
          <select oninput="updateBTField(${i}, 'bloodGroup', this.value)" style="width:100%;">
            <option value="">Select</option>
            ${['A+','A-','B+','B-','AB+','AB-','O+','O-'].map(g => `<option value="${g}" ${t.bloodGroup===g?'selected':''}>${g}</option>`).join('')}
          </select>
        </div>
      </div>

      <!-- Transfusion Time -->
      <div style="font-size: 0.78rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.6rem;">Transfusion Time</div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.8rem; margin-bottom: 1rem;">
        <div>
          <label style="display: block; font-size: 0.72rem; color: var(--muted); margin-bottom: 0.3rem;">Start Time</label>
          <input type="datetime-local" value="${t.startTime || ''}" onchange="updateBTField(${i}, 'startTime', this.value)" style="width:100%;">
        </div>
        <div>
          <label style="display: block; font-size: 0.72rem; color: var(--muted); margin-bottom: 0.3rem;">End Time</label>
          <input type="datetime-local" value="${t.endTime || ''}" onchange="updateBTField(${i}, 'endTime', this.value)" style="width:100%;">
        </div>
      </div>

      <!-- Vitals Grid -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
        <!-- Pre-Transfusion Vitals -->
        <div style="background: rgba(245,158,11,0.07); border: 1px solid rgba(245,158,11,0.2); border-radius: 8px; padding: 0.9rem;">
          <div style="font-size: 0.78rem; font-weight: 700; color: var(--amber); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.7rem;">âš ï¸ Pre-Transfusion Vitals</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
            ${['bp','hr','temp','rr','spo2'].map(v => `
              <div>
                <label style="font-size: 0.68rem; color: var(--muted);">${v.toUpperCase()}${v==='bp'?' (mmHg)':v==='hr'?' (bpm)':v==='temp'?' (Â°C)':v==='rr'?' (/min)':' (%)'}</label>
                <input type="text" value="${escHtml(t.preVitals[v] || '')}" placeholder="${v==='bp'?'120/80':v==='hr'?'70':v==='temp'?'36.5':v==='rr'?'16':'98'}" oninput="updateBTField(${i}, 'preVitals.${v}', this.value)" style="width:100%; margin-top:2px;">
              </div>`).join('')}
          </div>
        </div>
        <!-- Post-Transfusion Vitals -->
        <div style="background: rgba(16,185,129,0.07); border: 1px solid rgba(16,185,129,0.2); border-radius: 8px; padding: 0.9rem;">
          <div style="font-size: 0.78rem; font-weight: 700; color: var(--success); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.7rem;">âœ… Post-Transfusion Vitals</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
            ${['bp','hr','temp','rr','spo2'].map(v => `
              <div>
                <label style="font-size: 0.68rem; color: var(--muted);">${v.toUpperCase()}${v==='bp'?' (mmHg)':v==='hr'?' (bpm)':v==='temp'?' (Â°C)':v==='rr'?' (/min)':' (%)'}</label>
                <input type="text" value="${escHtml(t.postVitals[v] || '')}" placeholder="${v==='bp'?'120/80':v==='hr'?'70':v==='temp'?'36.5':v==='rr'?'16':'98'}" oninput="updateBTField(${i}, 'postVitals.${v}', this.value)" style="width:100%; margin-top:2px;">
              </div>`).join('')}
          </div>
        </div>
      </div>

      <!-- Nurse & Notes -->
      <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 0.8rem;">
        <div>
          <label style="display: block; font-size: 0.72rem; color: var(--muted); margin-bottom: 0.3rem;">Nurse Administering</label>
          <input type="text" value="${escHtml(t.nurse || '')}" placeholder="Nurse name" oninput="updateBTField(${i}, 'nurse', this.value)" style="width:100%;">
        </div>
        <div>
          <label style="display: block; font-size: 0.72rem; color: var(--muted); margin-bottom: 0.3rem;">Notes / Reactions</label>
          <input type="text" value="${escHtml(t.notes || '')}" placeholder="Any reactions or notes..." oninput="updateBTField(${i}, 'notes', this.value)" style="width:100%;">
        </div>
      </div>
    </div>
  `).join('');
}

// â”€â”€â”€ KEYBOARD SHORTCUTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    saveRecord();
  }
});

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadTheme();
checkAuth();
</script>
</body>
</html>
